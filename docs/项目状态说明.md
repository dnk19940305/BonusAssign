# 项目状态说明文档

## 概述

系统中存在两种项目状态字段，分别用于不同的业务场景：
- **cooperation_status（协作状态）**：管理项目的协作流程
- **status（项目状态）**：管理项目的生命周期

两者相互独立，可同时存在，共同描述项目的完整状态。

---

## 1. cooperation_status（协作状态）

### 用途
管理**项目协作流程**，从项目发布到团队组建完成的全过程。

### 状态流转

```
draft（草稿）
   ↓
published（已发布）
   ↓
team_building（组建中）
   ↓
approved（已批准）
   ↓
in_progress（进行中）
   ↓
completed（已完成）
```

### 状态详解

| 状态值 | 中文名称 | 说明 | 触发条件 |
|--------|---------|------|---------|
| `draft` | 草稿 | 项目初创状态，尚未发布 | 创建项目时默认状态 |
| `published` | 已发布 | 管理层发布项目，等待团队申请 | 管理层调用发布接口 |
| `team_building` | 组建中 | 项目经理已提交团队组建申请 | 项目经理提交团队申请 |
| `approved` | 已批准 | 团队申请已通过审批 | 管理层批准团队申请 |
| `in_progress` | 进行中 | 项目已启动执行 | 项目经理启动项目 |
| `completed` | 已完成 | 项目协作完成 | 项目正常完成或提前结项 |
| `rejected` | 已拒绝 | 团队申请被拒绝 | 管理层拒绝团队申请 |

### 相关操作

| 操作 | API路径 | 权限要求 | 状态变更 |
|------|---------|----------|---------|
| 发布项目 | `POST /api/project-collaboration/:projectId/publish` | 管理层 | `draft` → `published` |
| 申请团队 | `POST /api/project-collaboration/:projectId/apply-team` | 项目经理 | `published` → `team_building` |
| 批准申请 | `POST /api/project-collaboration/applications/:id/approve` | 管理层 | `team_building` → `approved` |
| 拒绝申请 | `POST /api/project-collaboration/applications/:id/approve` | 管理层 | `team_building` → `rejected` |
| 要求修改 | `POST /api/project-collaboration/applications/:id/approve` | 管理层 | `team_building` → `needs_modification` |
| 重新提交 | `POST /api/project-collaboration/applications/:id/resubmit` | 项目经理 | `needs_modification` → `pending` |
| 启动项目 | `POST /api/projects/:id/start` | 项目经理 | `approved` → `in_progress` |
| 完成项目 | `POST /api/projects/:id/complete` | 项目经理 | `in_progress` → `completed` |
| 提前结项 | `POST /api/projects/:id/early-complete` | 管理层/项目经理 | `approved/in_progress` → `completed` |

---

## 2. status（项目状态）

### 用途
管理**项目的生命周期**，从计划到归档的全过程，独立于协作流程。

### 状态流转

```
planning（计划中）
   ↓
in_progress（进行中）
   ↓
completed（已完成）
   ↓
archived（已归档）
   ↓
cancelled（已取消）
```

### 状态详解

| 状态值 | 中文名称 | 说明 | 典型场景 |
|--------|---------|------|---------|
| `planning` | 计划中 | 项目处于规划阶段 | 项目创建后，资源分配前 |
| `in_progress` | 进行中 | 项目正在执行 | 团队开始工作 |
| `completed` | 已完成 | 项目已交付 | 项目目标达成 |
| `on_hold` | 已暂停 | 项目暂时搁置 | 等待外部条件 |
| `archived` | 已归档 | 项目已归档保存 | 项目结束后归档 |
| `cancelled` | 已取消 | 项目已终止 | 项目不再继续 |

### 相关操作

| 操作 | 触发时机 | 状态变更 |
|------|---------|---------|
| 创建项目 | 项目初始化 | → `planning` |
| 开始执行 | 资源到位，开始工作 | `planning` → `in_progress` |
| 暂停项目 | 遇到阻塞 | `in_progress` → `on_hold` |
| 恢复项目 | 条件满足 | `on_hold` → `in_progress` |
| 完成项目 | 目标达成 | `in_progress` → `completed` |
| 归档项目 | 项目结束 | `completed` → `archived` |
| 取消项目 | 项目终止 | 任意状态 → `cancelled` |

---

## 3. 两种状态的关系

### 独立性原则
- **cooperation_status** 和 **status** 是两个独立的维度
- 一个项目可以同时拥有两种状态
- 它们的变更互不依赖，但在某些场景下会同步更新

### 典型组合场景

| cooperation_status | status | 场景说明 |
|-------------------|--------|---------|
| `draft` | `planning` | 新创建的项目，尚未发布协作 |
| `published` | `planning` | 已发布等待团队申请，但项目还在规划阶段 |
| `team_building` | `planning` | 团队申请中，项目准备启动 |
| `approved` | `planning` | 团队已批准，等待项目正式启动 |
| `in_progress` | `in_progress` | 项目正在执行，团队协作进行中 |
| `completed` | `completed` | 项目和协作都已完成 |
| `rejected` | `planning` | 团队申请被拒绝，项目回到规划阶段 |
| `null` | `in_progress` | 非协作项目，直接执行 |

### 同步更新场景

某些操作会同时影响两种状态：

1. **启动项目**
   - `cooperation_status`: `approved` → `in_progress`
   - `status`: `planning` → `in_progress`

2. **完成项目**
   - `cooperation_status`: `in_progress` → `completed`
   - `status`: `in_progress` → `completed`

3. **提前结项**
   - `cooperation_status`: 任意 → `completed`
   - `status`: 任意 → `completed`

---

## 4. 数据库设计

### projects 表结构

```sql
CREATE TABLE `projects` (
  `id` varchar(36) PRIMARY KEY,
  `name` varchar(100) NOT NULL COMMENT '项目名称',
  `code` varchar(50) UNIQUE NOT NULL COMMENT '项目代码',
  `description` text COMMENT '项目描述',
  
  -- 项目生命周期状态
  `status` varchar(20) DEFAULT 'planning' COMMENT '项目状态：planning-计划中, in_progress-进行中, completed-已完成, on_hold-已暂停, archived-已归档, cancelled-已取消',
  
  -- 协作流程状态
  `cooperation_status` varchar(30) COMMENT '协作状态：draft-草稿, published-已发布, team_building-组建中, approved-已批准, in_progress-进行中, completed-已完成, rejected-已拒绝',
  `published_by` int COMMENT '发布人ID',
  `published_at` datetime COMMENT '发布时间',
  
  -- 其他字段...
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='项目表';
```

### 字段索引建议

```sql
-- 协作状态索引
CREATE INDEX idx_cooperation_status ON projects(cooperation_status);

-- 项目状态索引
CREATE INDEX idx_status ON projects(status);

-- 复合索引：常用组合查询
CREATE INDEX idx_status_cooperation ON projects(status, cooperation_status);
```

---

## 5. 前端展示建议

### 状态徽章显示

```vue
<template>
  <!-- 项目状态 -->
  <el-tag :type="getStatusType(project.status)">
    {{ getStatusLabel(project.status) }}
  </el-tag>
  
  <!-- 协作状态 -->
  <el-tag :type="getCooperationStatusType(project.cooperationStatus)">
    {{ getCooperationStatusLabel(project.cooperationStatus) }}
  </el-tag>
</template>
```

### 筛选器配置

```typescript
// 项目状态筛选
const statusOptions = [
  { label: '计划中', value: 'planning' },
  { label: '进行中', value: 'in_progress' },
  { label: '已完成', value: 'completed' },
  { label: '已暂停', value: 'on_hold' },
  { label: '已归档', value: 'archived' },
  { label: '已取消', value: 'cancelled' }
]

// 协作状态筛选
const cooperationStatusOptions = [
  { label: '草稿', value: 'draft' },
  { label: '已发布', value: 'published' },
  { label: '组建中', value: 'team_building' },
  { label: '已批准', value: 'approved' },
  { label: '进行中', value: 'in_progress' },
  { label: '已完成', value: 'completed' },
  { label: '已拒绝', value: 'rejected' }
]
```

---

## 6. 最佳实践

### 查询优化

1. **查询协作项目**
   ```sql
   SELECT * FROM projects 
   WHERE cooperation_status IS NOT NULL 
   AND cooperation_status != 'draft';
   ```

2. **查询活跃项目**
   ```sql
   SELECT * FROM projects 
   WHERE status = 'in_progress' 
   AND cooperation_status = 'in_progress';
   ```

3. **查询待审批申请的项目**
   ```sql
   SELECT * FROM projects 
   WHERE cooperation_status = 'team_building';
   ```

### 权限控制

1. **基于 cooperation_status 的权限**
   - `published`: 项目经理可申请团队
   - `team_building`: 管理层可审批
   - `approved`: 项目经理可启动项目
   - `in_progress`: 项目经理可完成项目

2. **基于 status 的权限**
   - `planning`: 可编辑项目信息
   - `in_progress`: 可记录进度
   - `completed`: 只读状态
   - `archived`: 完全锁定

### 状态变更日志

建议记录所有状态变更：

```javascript
await auditService.logStatusChange({
  projectId,
  oldStatus: project.status,
  newStatus: 'in_progress',
  oldCooperationStatus: project.cooperation_status,
  newCooperationStatus: 'in_progress',
  operatorId: user.id,
  reason: '项目启动'
})
```

---

## 7. 常见问题

### Q1: 为什么需要两个状态字段？

**A**: 
- `cooperation_status` 专注于**团队协作流程**，适用于需要团队申请和审批的项目
- `status` 专注于**项目生命周期**，适用于所有项目（包括非协作项目）
- 分离设计使得协作流程可选，不影响基础项目管理

### Q2: 非协作项目的 cooperation_status 是什么？

**A**: 非协作项目的 `cooperation_status` 为 `NULL` 或 `draft`，表示该项目不参与协作流程。

### Q3: 两个状态不一致怎么办？

**A**: 
- 正常情况下，某些场景允许不一致（如团队已批准但项目还在规划）
- 如果出现异常不一致，可通过状态修复接口同步：
  ```javascript
  await projectApi.syncProjectStatus(projectId)
  ```

### Q4: 如何判断项目是否协作项目？

**A**: 检查 `cooperation_status` 字段：
```javascript
const isCollaborationProject = project.cooperation_status !== null && project.cooperation_status !== 'draft'
```

---

## 8. 更新日志

| 日期 | 版本 | 更新内容 |
|------|------|---------|
| 2025-11-17 | 1.0 | 初始版本，明确两种状态的区分和用途 |
| 2025-11-17 | 1.1 | 添加申请状态 `needs_modification`（需修改） |
| 2025-11-17 | 1.2 | 添加项目启动/完成按钮操作说明 |

---

## 附录

### 相关文件

- 数据库脚本: `database/project-collaboration.sql`
- 后端服务: `backend/src/services/projectCollaborationService.js`
- 状态流转服务: `backend/src/services/ProjectStateFlowService.js`
- 前端API: `frontend/src/api/projectCollaboration.ts`
- 项目API: `frontend/src/api/project.ts`
- 协作页面: `frontend/src/views/project/ProjectCollaboration.vue`

### 参考资料

- [项目协作详细设计文档](../详细设计文档.md)
- [数据库设计文档](../database/README.md)
- [API接口文档](../backend/API.md)
