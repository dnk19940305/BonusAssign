# 奖金系统完整操作流程

> 本文档详细说明从项目创建到最终奖金计算发放的完整业务流程及技术实现

## 📋 目录

- [1. 系统概述](#1-系统概述)
- [2. 基础数据准备](#2-基础数据准备)
- [3. 项目数据管理](#3-项目数据管理)
- [4. 绩效数据管理](#4-绩效数据管理)
- [5. 奖金池创建](#5-奖金池创建)
- [6. 三维计算执行](#6-三维计算执行)
- [7. 结果查看与导出](#7-结果查看与导出)
- [8. 技术实现详解](#8-技术实现详解)

---

## 1. 系统概述

### 1.1 三维奖金模型

本系统采用**利润贡献度 + 岗位价值 + 绩效表现**三维奖金分配模型：

```
员工最终奖金 = (员工综合得分 / 所有员工总得分) × 奖金池可分配金额
```

**综合得分计算**：
- **利润贡献度**：基于员工在项目中的工作量、质量、直接贡献等
- **岗位价值**：基于岗位的基准价值（benchmark_value）
- **绩效表现**：基于季度/年度绩效评估结果

### 1.2 核心功能模块

- 基础数据管理（部门、岗位、员工、业务线）
- 项目成本管理（项目预算、成本、利润）
- 绩效评估管理（绩效记录、指标配置）
- 奖金池管理（公司级/项目级/部门级）
- 三维计算引擎（得分计算、标准化、加权）
- 结果分析与导出

---

## 2. 基础数据准备

### 2.1 组织架构配置

#### 步骤1：创建部门
- **路径**：系统管理 → 部门管理
- **操作**：点击"新增部门"
- **必填字段**：
  - 部门名称
  - 部门代码（唯一）
  - 负责人（可选）
  - 上级部门（可选，用于层级结构）

**技术实现**：
- 前端：`frontend/src/views/system/DepartmentManagement.vue`
- 后端：`backend/src/controllers/departmentController.js`
- 数据表：`departments`

#### 步骤2：创建岗位
- **路径**：系统管理 → 岗位管理
- **操作**：点击"新增岗位"
- **必填字段**：
  - 岗位名称
  - 岗位代码（唯一）
  - 岗位级别（如：P5、P6、M1等）
  - **基准价值（benchmark_value）**：用于岗位价值维度计算

**注意**：基准价值直接影响奖金计算，建议根据市场薪酬水平设置

**技术实现**：
- 前端：`frontend/src/views/system/PositionManagement.vue`
- 后端：`backend/src/controllers/positionController.js`
- 数据表：`positions`

#### 步骤3：创建业务线
- **路径**：系统管理 → 业务线管理
- **操作**：点击"新增业务线"
- **必填字段**：
  - 业务线名称
  - 业务线代码（唯一）
  - 负责人
  - 权重（用于业务线之间的重要性对比）

**技术实现**：
- 数据表：`business_lines`
- 后端：`backend/src/controllers/businessLineController.js`

### 2.2 员工信息管理

#### 创建员工档案
- **路径**：员工管理 → 员工列表
- **操作**：点击"新增员工"
- **必填字段**：
  - 员工工号（唯一）
  - 员工姓名
  - 所属部门
  - 所属岗位
  - 年薪
  - 入职日期

**支持功能**：
- 批量导入（Excel模板）
- 员工调岗
- 员工离职

**技术实现**：
- 前端：`frontend/src/views/employee/EmployeeManagement.vue`
- 后端：`backend/src/controllers/employeeController.js`
- 数据表：`employees`

---

## 3. 项目数据管理

### 3.1 创建项目

#### 步骤1：录入项目基础信息
- **路径**：项目管理 → 项目列表
- **操作**：点击"新增项目"
- **必填字段**：
  - 项目编号（唯一）
  - 项目名称
  - 所属业务线
  - 项目经理
  - 开始日期、结束日期
  - 项目状态（进行中/已完成/已取消）

**技术实现**：
- 数据表：`projects`
- 后端：`backend/src/controllers/projectController.js`

#### 步骤2：配置项目成本
- **路径**：在项目列表中点击"成本管理"
- **必填字段**：
  - 期间（如：2025Q1）
  - **项目预算**
  - **实际成本**
  - **实际收入**
  - 利润（自动计算 = 收入 - 成本）

**重要**：项目成本数据是利润贡献度计算的基础！

**技术实现**：
- 前端：`frontend/src/views/project/ProjectCostManagement.vue`
- 后端：`backend/src/services/projectCostService.js`
- 数据表：`project_costs`

### 3.2 分配项目成员

#### 配置员工项目参与度
- **路径**：项目详情 → 项目成员
- **操作**：添加项目成员
- **必填字段**：
  - 员工
  - 角色（项目经理/开发/测试等）
  - 参与度百分比（如：80%表示投入80%工作时间）
  - 工作量（人天）

**注意**：工作量数据用于利润贡献度中的"工作量贡献"维度

**技术实现**：
- 数据表：`project_members`
- 后端：`backend/src/controllers/projectMemberController.js`

---

## 4. 绩效数据管理

### 4.1 配置绩效指标（可选）

如需细化绩效评估，可配置绩效指标：

- **路径**：绩效管理 → 绩效指标配置
- **支持类型**：
  - 定量指标（有明确数值目标）
  - 定性指标（主观评价）

**技术实现**：
- 数据表：`performance_indicators`
- 后端：`backend/src/services/performanceCalculationService.js`

### 4.2 录入绩效记录

#### 单条录入
- **路径**：绩效管理 → 绩效记录管理
- **操作**：点击"新增绩效记录"
- **必填字段**：
  - 员工（支持远程搜索）
  - 考核期间（如：2025Q1）
  - 绩效评级（S/A/B/C/D）
  - 绩效系数（根据评级自动填充）

**评级对应系数**：
- S - 卓越：1.5
- A - 优秀：1.2
- B - 良好：1.0
- C - 合格：0.8
- D - 待改进：0.5

#### 批量导入
- **操作**：点击"批量导入"
- **流程**：
  1. 下载Excel模板
  2. 填写员工绩效数据
  3. 上传文件导入

**技术实现**：
- 前端：`frontend/src/views/performance/PerformanceRecordManagement.vue`
- 后端：`backend/src/controllers/performanceRecordController.js`
- 数据表：`performance_records`

---

## 5. 奖金池创建

### 5.1 奖金池类型

系统支持三种类型的奖金池：

1. **公司级**：全公司范围奖金分配
2. **项目级**：针对特定项目的奖金
3. **部门级**：针对特定部门的奖金

### 5.2 创建奖金池

#### 步骤1：选择奖金池类型
- **路径**：奖金计算 → 奖金池列表
- **操作**：点击"创建奖金池"
- **选择类型**：公司级/项目级/部门级

#### 步骤2：填写奖金池信息

**公司级奖金池**：
- 奖金池名称
- 考核期间（如：2025Q1）
- **公司总利润**（系统会自动汇总所有项目利润作为参考）
- 分配比例（如：15%）
- 可分配金额 = 总利润 × 分配比例（自动计算）

**项目级奖金池**：
- 选择项目
- 期间
- 项目利润（自动获取）
- 分配比例
- 可分配金额（自动计算）

**系统验证**：
- 软性警告：输入总利润超过实际总利润150%时提示确认
- 硬性限制：奖金池金额不能超过输入的总利润

**技术实现**：
- 前端：`frontend/src/views/calculation/BonusCalculation.vue`
- 后端：`backend/src/services/bonusPoolService.js`
- 数据表：`bonus_pools`

---

## 6. 三维计算执行

### 6.1 启动三维计算

#### 操作步骤
- **路径**：奖金计算 → 奖金池列表
- **操作**：选择奖金池，点击"执行三维计算"
- **配置**：
  - 选择权重配置方案（如未配置，使用默认方案）
  - 确认计算范围（所有符合条件的员工）

### 6.2 三维计算详细流程

#### 第一步：获取三个维度原始得分

**A. 利润贡献度得分**

计算公式：
```
利润得分 = 直接贡献 × 40% + 工作量贡献 × 30% + 质量贡献 × 20% + 岗位价值贡献 × 10%
```

**数据来源**：
- 项目成本数据（`project_costs`）
- 项目成员工作量（`project_members`）
- 员工岗位信息（`positions`）

**代码位置**：
- `backend/src/services/threeDimensionalCalculationService.js` - `getProfitContributionScore()`
- `backend/src/services/profitCalculationService.js` - `calculateEmployeeProfitContribution()`

**B. 岗位价值得分**

**数据来源**：直接从 `positions` 表的 `benchmark_value` 字段获取

**代码位置**：
- `backend/src/services/threeDimensionalCalculationService.js` - `getPositionValueScore()`

**C. 绩效表现得分**

**数据来源**：
- 绩效记录（`performance_records`）
- 绩效指标得分（如已配置）

**计算逻辑**：
- 如有绩效指标：按指标权重加权计算
- 如无绩效指标：返回默认分数75

**代码位置**：
- `backend/src/services/threeDimensionalCalculationService.js` - `getPerformanceScore()`
- `backend/src/services/performanceCalculationService.js`

#### 第二步：标准化得分

**目的**：将不同量纲的得分统一到同一尺度

**支持的标准化方法**：

1. **Z-Score标准化**（默认）
   ```
   标准化得分 = (原始得分 - 平均值) / 标准差
   ```

2. **Min-Max标准化**
   ```
   标准化得分 = (原始得分 - 最小值) / (最大值 - 最小值)
   ```

3. **不标准化**
   ```
   直接使用原始得分
   ```

**代码位置**：
- `backend/src/services/threeDimensionalCalculationService.js` - `normalizeScores()`

#### 第三步：加权计算综合得分

**根据权重配置计算最终得分**

**支持的计算方法**：

1. **加权求和（weighted_sum）**
   ```
   综合得分 = 利润得分 × 权重1 + 岗位得分 × 权重2 + 绩效得分 × 权重3
   ```

2. **加权乘积（weighted_product）**
   ```
   综合得分 = (利润得分 ^ 权重1) × (岗位得分 ^ 权重2) × (绩效得分 ^ 权重3)
   ```

3. **混合方法（hybrid）**
   ```
   组合使用以上两种方法
   ```

**默认权重**：
- 利润贡献度：40%
- 岗位价值：30%
- 绩效表现：30%

**代码位置**：
- `backend/src/services/threeDimensionalCalculationService.js` - `calculateTotalScore()`

#### 第四步：应用调整系数

**可选的调整系数**：
- 部门系数
- 职级系数
- 其他自定义系数

**代码位置**：
- `backend/src/services/threeDimensionalCalculationService.js` - `applyAdjustmentFactors()`

#### 第五步：按比例分配奖金

**核心公式**：
```javascript
员工奖金 = (员工综合得分 / 所有员工总得分) × 奖金池可分配金额
```

**计算流程**：
1. 计算所有员工的总得分（totalScoreSum）
2. 获取奖金池可分配金额（distributableAmount）
3. 按比例计算每个员工的奖金金额
4. 四舍五入保留两位小数

**代码位置**：
- `backend/src/services/threeDimensionalCalculationService.js` - `batchSaveResults()`
- 关键代码在第587-657行

**核心代码**：
```javascript
// 计算总得分
totalScoreSum = calculationResults.reduce((sum, result) => {
  return sum + (result.adjustedScore || result.totalScore || 0)
}, 0)

// 分配奖金
baseBonusAmount = (employeeFinalScore / totalScoreSum) * distributableAmount
```

#### 第六步：保存计算结果

**保存内容**：
- 三个维度原始得分
- 标准化后的得分
- 综合得分
- 调整后得分
- **基础奖金金额**
- **最终奖金金额**
- 审核状态（自动批准）

**数据表**：`three_dimensional_calculation_results`

**自动审核机制**：
系统自动将计算结果的 `reviewStatus` 设置为 `'approved'`，确保可以直接参与奖金分配。

**代码位置**：
- `backend/src/services/threeDimensionalCalculationService.js` - `saveCalculationResult()`

### 6.3 计算完成

**系统日志示例**：
```
💰 奖金分配: 可分配金额=￥71,250, 总得分=18231.59
  💵 员工 1QZC9ZBvJUGmQsYW 奖金计算: 得分=645.3959999999998, 总得分=18231.587999999996, 可分配=71250
  ✅ 分配奖金: ￥2522.24
  ...
✅ 奖金分配完成: 已分配=￥71,250, 剩余=￥0
```

---

## 7. 结果查看与导出

### 7.1 查看计算结果

#### 业务线分布视图
- **展示内容**：
  - 各业务线的总得分
  - 各业务线的奖金分配总额
  - 人员数量

#### 员工明细视图
- **展示内容**：
  - 员工工号
  - 员工姓名
  - 所属部门
  - 所属岗位
  - 利润得分
  - 岗位得分
  - 绩效得分
  - 综合得分
  - **最终奖金金额**

**切换方式**：点击页面顶部的"业务线分布"/"员工明细"单选按钮

**技术实现**：
- 前端：`frontend/src/views/calculation/BonusCalculation.vue`
- 视图切换代码在第372-443行

### 7.2 导出结果

#### 导出Excel报表
- **操作**：在结果对话框中点击"导出Excel"
- **导出内容**：
  - 员工明细数据
  - 奖金分配汇总
  - 业务线分布统计

**技术实现**：
- 使用 `XLSX` 库生成Excel文件
- 前端代码：`BonusCalculation.vue` - `exportToExcel()`

---

## 8. 技术实现详解

### 8.1 核心文件清单

| 分类 | 文件路径 | 功能说明 |
|------|---------|---------|
| **核心计算引擎** | `backend/src/services/threeDimensionalCalculationService.js` | 三维计算总控、得分标准化、奖金分配 |
| **维度计算** | `backend/src/services/profitCalculationService.js` | 利润贡献度计算 |
| | `backend/src/services/performanceCalculationService.js` | 绩效表现计算 |
| **业务服务** | `backend/src/services/bonusPoolService.js` | 奖金池管理 |
| | `backend/src/services/projectCostService.js` | 项目成本管理 |
| **API控制器** | `backend/src/controllers/bonusCalculationController.js` | 奖金计算接口 |
| | `backend/src/controllers/employeeController.js` | 员工管理接口 |
| | `backend/src/controllers/performanceRecordController.js` | 绩效记录接口 |
| **前端页面** | `frontend/src/views/calculation/BonusCalculation.vue` | 奖金计算主页面 |
| | `frontend/src/views/performance/PerformanceRecordManagement.vue` | 绩效记录管理 |
| | `frontend/src/views/employee/EmployeeManagement.vue` | 员工管理 |

### 8.2 数据库表结构

| 表名 | 说明 | 关键字段 |
|------|------|---------|
| `bonus_pools` | 奖金池 | id, pool_type, period, total_profit, distribution_ratio, distributable_amount |
| `three_dimensional_calculation_results` | 三维计算结果 | employee_id, bonus_pool_id, profit_score, position_score, performance_score, final_score, base_bonus_amount, final_bonus_amount |
| `employees` | 员工档案 | id, employee_no, name, department_id, position_id, annual_salary |
| `positions` | 岗位信息 | id, name, level, benchmark_value |
| `departments` | 部门信息 | id, name, code |
| `business_lines` | 业务线 | id, name, code, weight |
| `projects` | 项目信息 | id, project_no, name, business_line_id |
| `project_costs` | 项目成本 | project_id, period, budget, actual_cost, actual_revenue, profit |
| `project_members` | 项目成员 | project_id, employee_id, role, participation_rate, workload |
| `performance_records` | 绩效记录 | employee_id, period, rating, coefficient |
| `performance_indicators` | 绩效指标 | id, name, weight, indicator_type |

### 8.3 关键算法实现

#### 利润贡献度计算

**文件**：`backend/src/services/profitCalculationService.js`

**维度**：
1. **直接贡献**：基于项目利润和员工参与度
2. **工作量贡献**：基于实际工作量（人天）
3. **质量贡献**：基于项目质量评分
4. **岗位价值贡献**：基于岗位的benchmark_value

#### 绩效得分计算

**文件**：`backend/src/services/performanceCalculationService.js`

**逻辑**：
- 有绩效指标：按指标权重加权计算
- 无绩效指标：返回默认分数75（防御性编程）

**防御性检查**：
```javascript
if (!indicators || indicators.length === 0) {
  console.warn('⚠️ 没有找到绩效指标，返回默认分数 75')
  return 75
}
```

#### NaN防护机制

**目的**：防止计算过程中出现NaN导致整个计算链失败

**实现位置**：
- `getProfitContributionScore()` - 利润得分计算
- `calculateOverallScore()` - 绩效得分计算

**示例代码**：
```javascript
// 提取score值，支持对象和数值两种格式
const getScore = (value) => {
  if (typeof value === 'object' && value !== null) {
    return value.score || 0
  }
  return value || 0
}

const finalScore = isNaN(score) ? 0 : score
```

### 8.4 完整数据流图

```
┌─────────────────┐
│ 1. 基础数据准备  │
│ - 部门/岗位      │
│ - 员工/业务线    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 2. 项目数据录入  │
│ - 项目信息       │
│ - 成本数据       │
│ - 项目成员       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 3. 绩效数据录入  │
│ - 绩效记录       │
│ - 绩效指标(可选) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 4. 创建奖金池    │
│ - 设置总利润     │
│ - 设置分配比例   │
│ - 计算可分配额   │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 5. 执行三维计算                      │
│                                      │
│  A. 获取原始得分                     │
│     ├─ 利润贡献度 (40%)              │
│     ├─ 岗位价值 (30%)                │
│     └─ 绩效表现 (30%)                │
│                                      │
│  B. 标准化得分                       │
│     └─ Z-Score / Min-Max / None     │
│                                      │
│  C. 加权计算                         │
│     └─ 综合得分 = Σ(维度得分×权重)   │
│                                      │
│  D. 应用调整系数                     │
│     └─ 部门/职级系数                 │
│                                      │
│  E. 按比例分配奖金                   │
│     └─ 奖金 = (得分/总分) × 总金额   │
│                                      │
│  F. 保存结果                         │
│     └─ 自动审核批准                  │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────┐
│ 6. 查看与导出    │
│ - 业务线分布     │
│ - 员工明细       │
│ - 导出Excel      │
└─────────────────┘
```

### 8.5 常见问题与解决方案

#### 问题1：奖金分配金额为0

**原因**：
- 总得分为0（可能是数据缺失）
- 利润得分或绩效得分为NaN
- 业务线数据未同步

**解决方案**：
1. 检查项目成本数据是否录入
2. 检查绩效记录是否存在
3. 检查业务线是否在MySQL中存在
4. 查看后端日志中的得分计算详情

#### 问题2：员工得分为NaN

**原因**：
- 绩效指标为空但未做防御性处理
- 利润数据字段格式不匹配（对象 vs 数值）

**解决方案**：
- 已添加NaN防护机制
- getScore辅助函数处理对象/数值兼容
- calculateOverallScore返回默认值75

#### 问题3：员工搜索无结果

**原因**：
- 前端仅使用本地过滤
- 员工数量超过初始加载限制

**解决方案**：
- 已实现远程搜索功能
- 使用 `search` 参数调用后端接口
- 支持姓名、工号模糊搜索

---

## 9. 最佳实践建议

### 9.1 数据准备阶段

1. **确保岗位基准价值合理**：基准价值直接影响岗位维度得分
2. **及时更新项目成本**：建议每月/每季度更新项目成本数据
3. **完整录入绩效记录**：缺少绩效数据会影响绩效维度计算

### 9.2 奖金池创建阶段

1. **仔细核对总利润**：系统会显示自动汇总的利润供参考
2. **合理设置分配比例**：一般建议10%-20%
3. **项目级奖金池**：确保项目成本数据已录入

### 9.3 计算执行阶段

1. **选择合适的权重配置**：根据公司战略调整三维权重
2. **使用标准化方法**：建议使用Z-Score标准化
3. **查看计算日志**：确认得分计算无异常

### 9.4 结果验证阶段

1. **检查总分配金额**：应该等于或接近可分配金额
2. **对比员工得分**：验证得分是否符合预期
3. **导出Excel存档**：保留计算结果备查

---

## 10. 附录

### 10.1 系统账户

- **默认管理员账户**：admin / admin123
- **权限**：系统管理员拥有所有功能权限

### 10.2 技术栈

- **前端**：Vue3 + TypeScript + Element Plus + Vite
- **后端**：Node.js + Express + Sequelize ORM
- **数据库**：MySQL 8.0+ / NeDB（开发环境）
- **部署**：Docker + PM2 + Nginx

### 10.3 项目启动

**开发环境**：
```bash
# 后端
cd backend
npm install
npm run dev

# 前端
cd frontend
npm install
npm run dev
```

**生产环境**：
```bash
# 使用一键启动脚本
./start.sh  # Linux/Mac
start.bat   # Windows

# 或使用Docker
docker-compose -f docker-compose.production.yml up -d
```

### 10.4 联系与支持

如遇到问题，请：
1. 查看后端日志：`backend/logs/`
2. 查看浏览器控制台
3. 检查数据库数据完整性

---

**文档版本**：v1.0  
**最后更新**：2025-11-24  
**适用系统版本**：BonusAssign v1.x
