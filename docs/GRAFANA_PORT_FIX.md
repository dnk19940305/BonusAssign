# ç«¯å£é…ç½®ä¿®å¤æŠ¥å‘Š

## ğŸ“… ä¿®å¤æ—¥æœŸ
**2024-12-11**

## ğŸ”´ é—®é¢˜æè¿°

åœ¨ `docker-compose.production.yml` ä¸­å‘ç° **Grafana** å’Œ **åç«¯ API** çš„ç«¯å£å†²çªé—®é¢˜ã€‚

### å†²çªè¯¦æƒ…

**ä¿®å¤å‰**:
```yaml
# åç«¯ API
backend:
  ports:
    - "3000:3000"  # âŒ ä½¿ç”¨ 3000 ç«¯å£

# Grafana ç›‘æ§
grafana:
  ports:
    - "3000:3000"  # âŒ ä¹Ÿä½¿ç”¨ 3000 ç«¯å£ï¼ˆå†²çªï¼ï¼‰
```

è™½ç„¶ Grafana ä½¿ç”¨äº† `profiles: [monitoring]`ï¼ˆé»˜è®¤ä¸å¯ç”¨ï¼‰ï¼Œä½†å¦‚æœå¯ç”¨ç›‘æ§åŠŸèƒ½æ—¶ä¼šä¸åç«¯ API å‘ç”Ÿç«¯å£å†²çªã€‚

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤å†…å®¹

å°† Grafana çš„å¤–éƒ¨ç«¯å£ä» `3000` æ”¹ä¸º `3001`ï¼Œé¿å…ä¸åç«¯ API å†²çªã€‚

**ä¿®å¤å**:
```yaml
# åç«¯ API
backend:
  ports:
    - "3000:3000"  # âœ… åç«¯ä½¿ç”¨ 3000 ç«¯å£

# Grafana ç›‘æ§
grafana:
  ports:
    - "3001:3000"  # âœ… Grafana ä½¿ç”¨ 3001 ç«¯å£ï¼ˆå·²ä¿®å¤ï¼‰
```

### ä¿®æ”¹çš„æ–‡ä»¶

#### 1. docker-compose.production.yml

```yaml
grafana:
  image: grafana/grafana-oss:latest
  container_name: bonus-grafana-prod
  restart: unless-stopped
  ports:
    - "3001:3000"  # âœ… ä½¿ç”¨ 3001 ç«¯å£é¿å…ä¸åç«¯ 3000 ç«¯å£å†²çª
  volumes:
    - grafana_data:/var/lib/grafana
    - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
  environment:
    - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    - GF_USERS_ALLOW_SIGN_UP=false
    - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
```

#### 2. .env.template

æ·»åŠ äº† Grafana ç«¯å£é…ç½®è¯´æ˜ï¼š

```ini
# ========================================
# Grafana é…ç½®ï¼ˆä»…ç”Ÿäº§ç¯å¢ƒï¼‰
# ========================================
# Grafana ç®¡ç†å‘˜å¯†ç ï¼ˆå¯é€‰ï¼‰
GRAFANA_PASSWORD=admin123

# Grafana è®¿é—®ç«¯å£ï¼ˆç”Ÿäº§ç¯å¢ƒç›‘æ§ï¼‰
# è®¿é—®åœ°å€: http://localhost:3001
# æ³¨æ„ï¼šGrafana ä½¿ç”¨ 3001 ç«¯å£ï¼Œé¿å…ä¸åç«¯ 3000 ç«¯å£å†²çª
GRAFANA_PORT=3001
```

## ğŸ“Š ç«¯å£åˆ†é…è¡¨

### ä¿®å¤åçš„ç«¯å£é…ç½®

| æœåŠ¡ | å¤–éƒ¨ç«¯å£ | å†…éƒ¨ç«¯å£ | è®¿é—®åœ°å€ | è¯´æ˜ |
|------|----------|----------|----------|------|
| **Frontend** | 8080 | 80 | http://localhost:8080 | å‰ç«¯æœåŠ¡ |
| **Backend** | 3000 | 3000 | http://localhost:3000 | åç«¯ API |
| **Grafana** | **3001** | 3000 | http://localhost:3001 | ç›‘æ§ä»ªè¡¨æ¿ï¼ˆå¯é€‰ï¼‰ |
| **Prometheus** | 9090 | 9090 | http://localhost:9090 | ç›‘æ§æ•°æ®æ”¶é›†ï¼ˆå¯é€‰ï¼‰ |
| **MySQL** | - | - | å¤–éƒ¨ MySQL | ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“ |

### ç«¯å£è¯´æ˜

- âœ… **8080** - å‰ç«¯åº”ç”¨
- âœ… **3000** - åç«¯ APIï¼ˆä¸»æœåŠ¡ï¼‰
- âœ… **3001** - Grafana ç›‘æ§ï¼ˆå¯é€‰ï¼Œéœ€è¦ `--profile monitoring`ï¼‰
- âœ… **9090** - Prometheusï¼ˆå¯é€‰ï¼Œéœ€è¦ `--profile monitoring`ï¼‰

## ğŸš€ ä½¿ç”¨è¯´æ˜

### å¯åŠ¨æœåŠ¡

#### 1. ä¸å¯ç”¨ç›‘æ§ï¼ˆé»˜è®¤ï¼‰

```bash
# åªå¯åŠ¨å‰ç«¯å’Œåç«¯
docker-compose -f docker-compose.production.yml up -d

# è®¿é—®åœ°å€
# å‰ç«¯: http://localhost:8080
# åç«¯: http://localhost:3000
```

æ­¤æ—¶ä¸ä¼šå¯åŠ¨ Grafana å’Œ Prometheusï¼Œ**æ²¡æœ‰ç«¯å£å†²çª**ã€‚

#### 2. å¯ç”¨ç›‘æ§ï¼ˆå¯é€‰ï¼‰

```bash
# å¯ç”¨ monitoring profileï¼ŒåŒæ—¶å¯åŠ¨ç›‘æ§æœåŠ¡
docker-compose -f docker-compose.production.yml --profile monitoring up -d

# è®¿é—®åœ°å€
# å‰ç«¯: http://localhost:8080
# åç«¯: http://localhost:3000
# Grafana: http://localhost:3001  âœ… ä½¿ç”¨æ–°ç«¯å£
# Prometheus: http://localhost:9090
```

### è®¿é—® Grafana

ä¿®å¤åï¼ŒGrafana çš„è®¿é—®æ–¹å¼ï¼š

**è®¿é—®åœ°å€**: http://localhost:3001

**ç™»å½•ä¿¡æ¯**:
- ç”¨æˆ·å: `admin`
- å¯†ç : `.env` æ–‡ä»¶ä¸­çš„ `GRAFANA_PASSWORD`ï¼ˆé»˜è®¤ `admin123`ï¼‰

**é…ç½®æ•°æ®æº**:
- Prometheus URL: `http://prometheus:9090`

## ğŸ” éªŒè¯ç«¯å£é…ç½®

### æ£€æŸ¥ç«¯å£å ç”¨

```bash
# Windows
netstat -ano | findstr ":3000"
netstat -ano | findstr ":3001"

# Linux/Mac
lsof -i :3000
lsof -i :3001
```

### é¢„æœŸç»“æœ

**ä¸å¯ç”¨ç›‘æ§**:
- âœ… 3000 ç«¯å£è¢«åç«¯å ç”¨
- âœ… 3001 ç«¯å£ç©ºé—²

**å¯ç”¨ç›‘æ§**:
- âœ… 3000 ç«¯å£è¢«åç«¯å ç”¨
- âœ… 3001 ç«¯å£è¢« Grafana å ç”¨
- âœ… **æ²¡æœ‰ç«¯å£å†²çª**

## ğŸ“‹ Grafana ç›‘æ§è¯´æ˜

### ä»€ä¹ˆæ˜¯ Grafanaï¼Ÿ

**Grafana** æ˜¯ä¸€ä¸ªå¼€æºçš„ç›‘æ§å’Œå¯è§†åŒ–å¹³å°ï¼Œç”¨äºï¼š

1. **å®æ—¶ç›‘æ§** - ç³»ç»Ÿæ€§èƒ½ã€API å“åº”æ—¶é—´ã€èµ„æºä½¿ç”¨ç‡
2. **æ•°æ®å¯è§†åŒ–** - å°† Prometheus æ”¶é›†çš„æ•°æ®ä»¥å›¾è¡¨å±•ç¤º
3. **å‘Šè­¦ç®¡ç†** - å½“ç³»ç»Ÿå¼‚å¸¸æ—¶å‘é€é€šçŸ¥
4. **æ€§èƒ½åˆ†æ** - åˆ†æç³»ç»Ÿç“¶é¢ˆå’Œä¼˜åŒ–ç‚¹

### æ˜¯å¦éœ€è¦ Grafanaï¼Ÿ

#### âœ… éœ€è¦çš„åœºæ™¯

- ç”Ÿäº§ç¯å¢ƒéœ€è¦å®æ—¶ç›‘æ§
- éœ€è¦ä¸“ä¸šçš„è¿ç»´ä»ªè¡¨æ¿
- éœ€è¦æ€§èƒ½åˆ†æå’Œä¼˜åŒ–
- æœ‰ä¸“é—¨çš„è¿ç»´å›¢é˜Ÿ

#### âŒ ä¸éœ€è¦çš„åœºæ™¯

- å¼€å‘ç¯å¢ƒæˆ–æµ‹è¯•ç¯å¢ƒ
- å°å‹é¡¹ç›®æˆ–ä¸ªäººä½¿ç”¨
- èµ„æºæœ‰é™çš„æœåŠ¡å™¨
- ä¸éœ€è¦å¤æ‚çš„ç›‘æ§

### ç›‘æ§æœåŠ¡èµ„æºå ç”¨

```yaml
prometheus:
  deploy:
    resources:
      limits:
        cpus: '0.5'
        memory: 512M

grafana:
  deploy:
    resources:
      limits:
        cpus: '0.5'
        memory: 512M
```

**æ€»èµ„æºå ç”¨**ï¼ˆå¯ç”¨ç›‘æ§æ—¶ï¼‰:
- CPU: æœ€å¤š 1 æ ¸å¿ƒ
- å†…å­˜: æœ€å¤š 1GB

## ğŸ”§ å…¶ä»–é…ç½®å»ºè®®

### 1. å¦‚æœå®Œå…¨ä¸éœ€è¦ç›‘æ§

å¯ä»¥ä» `docker-compose.production.yml` ä¸­åˆ é™¤ Grafana å’Œ Prometheus é…ç½®ï¼š

```bash
# åˆ é™¤ä»¥ä¸‹æœåŠ¡é…ç½®
# - prometheus
# - grafana
# - prometheus_data volume
# - grafana_data volume
```

### 2. è‡ªå®šä¹‰ Grafana ç«¯å£

å¦‚æœ 3001 ç«¯å£ä¹Ÿè¢«å ç”¨ï¼Œå¯ä»¥ä¿®æ”¹ä¸ºå…¶ä»–ç«¯å£ï¼š

```yaml
grafana:
  ports:
    - "3002:3000"  # ä½¿ç”¨ 3002 æˆ–å…¶ä»–å¯ç”¨ç«¯å£
```

åŒæ—¶æ›´æ–° `.env.template`:
```ini
GRAFANA_PORT=3002
```

### 3. é…ç½® Grafana ä»ªè¡¨æ¿

1. è®¿é—® http://localhost:3001
2. ç™»å½•ï¼ˆadmin / GRAFANA_PASSWORDï¼‰
3. æ·»åŠ  Prometheus æ•°æ®æº
4. å¯¼å…¥æˆ–åˆ›å»ºä»ªè¡¨æ¿
5. é…ç½®å‘Šè­¦è§„åˆ™

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **åç«¯ç«¯å£** | 3000 | 3000 âœ… ä¸å˜ |
| **Grafana ç«¯å£** | 3000 âŒ å†²çª | 3001 âœ… å·²ä¿®å¤ |
| **å¯åŠ¨çŠ¶æ€** | é»˜è®¤ä¸å¯ç”¨ | é»˜è®¤ä¸å¯ç”¨ âœ… ä¸å˜ |
| **è®¿é—®åœ°å€** | http://localhost:3000 | http://localhost:3001 âœ… å·²æ›´æ–° |
| **ç«¯å£å†²çª** | âŒ å­˜åœ¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰ | âœ… å·²è§£å†³ |

## âœ… éªŒè¯æ¸…å•

ä¿®å¤å®Œæˆåï¼Œç¡®è®¤ä»¥ä¸‹å†…å®¹ï¼š

- [x] Grafana ç«¯å£å·²æ”¹ä¸º 3001
- [x] docker-compose.production.yml å·²æ›´æ–°
- [x] .env.template å·²æ·»åŠ  GRAFANA_PORT è¯´æ˜
- [x] åç«¯ API ç«¯å£ä¿æŒ 3000 ä¸å˜
- [x] é»˜è®¤ä¸å¯ç”¨ç›‘æ§ï¼ˆä¸å½±å“æ­£å¸¸ä½¿ç”¨ï¼‰
- [x] å¯ç”¨ç›‘æ§æ—¶æ²¡æœ‰ç«¯å£å†²çª
- [x] æ–‡æ¡£å·²æ›´æ–°

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [docker-compose.production.yml](../docker-compose.production.yml) - ç”Ÿäº§ç¯å¢ƒé…ç½®
- [.env.template](../.env.template) - ç¯å¢ƒå˜é‡æ¨¡æ¿
- [DATABASE_MANAGEMENT_GUIDE.md](DATABASE_MANAGEMENT_GUIDE.md) - æ•°æ®åº“ç®¡ç†æŒ‡å—

## ğŸ‰ æ€»ç»“

### ä¿®å¤å†…å®¹

1. âœ… ä¿®å¤äº† Grafana å’Œåç«¯ API çš„ç«¯å£å†²çª
2. âœ… Grafana ç«¯å£ä» 3000 æ”¹ä¸º 3001
3. âœ… æ›´æ–°äº† .env.template é…ç½®è¯´æ˜
4. âœ… ä¸å½±å“ç°æœ‰æœåŠ¡çš„æ­£å¸¸è¿è¡Œ

### ç«¯å£åˆ†é…

- **8080** - å‰ç«¯åº”ç”¨
- **3000** - åç«¯ APIï¼ˆä¸»æœåŠ¡ï¼‰
- **3001** - Grafana ç›‘æ§ï¼ˆå¯é€‰ï¼‰
- **9090** - Prometheusï¼ˆå¯é€‰ï¼‰

### ä½¿ç”¨å»ºè®®

- é»˜è®¤æƒ…å†µä¸‹ä¸å¯ç”¨ç›‘æ§ï¼Œæ²¡æœ‰ç«¯å£å†²çª
- éœ€è¦ç›‘æ§æ—¶ä½¿ç”¨ `--profile monitoring` å¯åŠ¨
- Grafana è®¿é—®åœ°å€: http://localhost:3001
- ç›‘æ§æœåŠ¡æ˜¯å¯é€‰çš„ï¼Œå¯ä»¥æ ¹æ®éœ€è¦å¯ç”¨æˆ–åˆ é™¤

---

**ä¿®å¤æ—¥æœŸ**: 2024-12-11  
**ä¿®å¤äººå‘˜**: Development Team  
**ç‰ˆæœ¬**: 1.0.0
