# 项目协作模块开发规划

## 文档信息
- **文档版本**: V1.0
- **创建日期**: 2025-10-17
- **项目名称**: 奖金模拟系统 - 项目协作模块
- **规划范围**: 项目发布、团队申请、审批决策三阶段流程
- **规划目标**: 实现功能完整、权限清晰、数据一致的协作系统

---

## 一、项目现状分析

### 1.1 已完成的基础设施 ✅

#### 数据库层面
- **核心表结构**: project_team_applications、project_requirements、project_roles等7张表已建立
- **数据关系**: 外键约束、索引优化、级联删除策略已配置
- **数据完整性**: 基础约束已设置

#### 后端API层面
- **控制器**: ProjectCollaborationController包含10个核心方法
- **服务层**: projectCollaborationService业务逻辑已实现
- **权限中间件**: projectCollaborationAuth细粒度权限控制
- **路由**: RESTful API路由已定义，Swagger文档已生成

#### 前端层面
- **API封装**: projectCollaborationApi TypeScript接口完整
- **页面组件**: ProjectCollaboration.vue、ProjectPublish.vue等已创建
- **状态管理**: Pinia store已集成

### 1.2 待完善的功能缺口 ⚠️

1. **项目发布流程**: 缺少需求模板管理、技能标签化、状态流转逻辑
2. **团队申请流程**: 成员选择器、工作量分配界面、成本校验待实现
3. **审批决策功能**: 审批流程引擎未启用、多级审批未实现
4. **通知消息系统**: 实时推送机制、分类筛选、状态同步待完善
5. **数据一致性**: 并发锁机制、事务边界、回滚策略缺失

### 1.3 技术债务清单

| 问题 | 影响 | 优先级 |
|------|------|--------|
| project_members表字段缺失 | 团队申请 | P0 |
| API类型使用any | 前端类型安全 | P1 |
| E2E测试覆盖不足 | 质量保障 | P0 |
| 业务流程图缺失 | 团队理解 | P1 |

---

## 二、开发规划总体设计

### 2.1 开发阶段划分 (共16周)

```
阶段一: 基础功能完善 (Week 1-4)
  ├─ Week 1: 数据库优化与修复
  ├─ Week 2-3: 后端API补全
  └─ Week 4: 前端基础组件开发

阶段二: 业务流程实现 (Week 5-10)
  ├─ Week 5-6: 项目发布流程
  ├─ Week 7-8: 团队申请流程
  └─ Week 9-10: 审批决策流程

阶段三: 系统集成与优化 (Week 11-13)
  ├─ Week 11: 权限集成测试
  ├─ Week 12: 性能优化
  └─ Week 13: 用户体验优化

阶段四: 测试与上线 (Week 14-16)
  ├─ Week 14: 全流程测试
  ├─ Week 15: 用户培训
  └─ Week 16: 生产部署
```

### 2.2 里程碑设置

| 里程碑 | 完成标志 | 时间 | 验收标准 |
|--------|---------|------|---------|
| M1: 数据层就绪 | 所有表结构完整 | W1 | 数据库健康检查通过 |
| M2: API层完成 | 所有接口开发完成 | W5 | Postman测试集通过 |
| M3: 前端开发完成 | 所有页面开发完成 | W9 | UI/UX评审通过 |
| M4: 集成测试通过 | E2E流程测试通过 | W12 | 测试套件通过 |
| M5: 生产上线 | 系统正式运行 | W16 | 用户验收通过 |

---

## 三、阶段一：基础功能完善 (Week 1-4)

### 任务组 1.1: 数据库优化 (Week 1)

#### 任务 1.1.1: project_members表字段补全
**优先级**: P0  
**工时**: 0.5天

**SQL脚本**:
```sql
ALTER TABLE project_members 
  ADD COLUMN IF NOT EXISTS apply_reason TEXT COMMENT '申请理由',
  ADD COLUMN IF NOT EXISTS applied_at DATETIME COMMENT '申请时间',
  ADD COLUMN IF NOT EXISTS approved_at DATETIME COMMENT '批准时间',
  ADD COLUMN IF NOT EXISTS rejected_at DATETIME COMMENT '拒绝时间',
  ADD COLUMN IF NOT EXISTS remark TEXT COMMENT '备注信息',
  ADD COLUMN IF NOT EXISTS participation_ratio DECIMAL(5,2) DEFAULT 100.0,
  ADD COLUMN IF NOT EXISTS contribution_weight DECIMAL(5,2) DEFAULT 1.0;
```

**验收标准**:
- ✅ 字段成功添加
- ✅ 现有数据不受影响
- ✅ ORM模型已更新

---

#### 任务 1.1.2: 数据库索引优化
**优先级**: P1  
**工时**: 1天

**优化脚本**:
```sql
CREATE INDEX idx_project_members_status_project 
  ON project_members(status, project_id);

CREATE INDEX idx_team_applications_status_project 
  ON project_team_applications(status, project_id);

CREATE INDEX idx_notifications_recipient_read 
  ON project_notifications(recipient_id, is_read, created_at);
```

---

#### 任务 1.1.3: 数据约束加强
**优先级**: P1  
**工时**: 1.5天

**约束规则**:
```sql
ALTER TABLE project_team_applications
  ADD CONSTRAINT chk_estimated_cost_positive 
  CHECK (estimated_cost >= 0);

ALTER TABLE project_members
  ADD CONSTRAINT chk_participation_ratio_valid 
  CHECK (participation_ratio BETWEEN 0 AND 100);

-- 触发器：同步团队成员数量
DELIMITER //
CREATE TRIGGER trg_update_team_member_count
AFTER INSERT ON project_members
FOR EACH ROW
BEGIN
  UPDATE project_team_applications 
  SET total_members = (
    SELECT COUNT(*) FROM project_members 
    WHERE application_id = NEW.application_id
  )
  WHERE id = NEW.application_id;
END//
DELIMITER ;
```

---

### 任务组 1.2: 后端API补全 (Week 2-3)

#### 任务 1.2.1: 项目发布API完善
**文件**: `backend/src/controllers/projectCollaborationController.js`  
**优先级**: P0  
**工时**: 3天

**新增方法**:
```javascript
// 1. 获取需求模板列表
async getRequirementTemplates(req, res, next) {
  const { category, page = 1, pageSize = 10 } = req.query
  const templates = await requirementTemplateService.getTemplates({ category })
  // 分页逻辑...
}

// 2. 创建需求模板
async createRequirementTemplate(req, res, next) {
  const template = await requirementTemplateService.createTemplate({
    ...req.body,
    createdBy: req.user.id
  })
  // 返回结果...
}

// 3. 获取技能标签
async getSkillTags(req, res, next) {
  const tags = await skillTagService.getTags(req.query)
  // 返回标签列表...
}
```

---

#### 任务 1.2.2: 团队申请API优化
**文件**: `backend/src/services/projectCollaborationService.js`  
**优先级**: P0  
**工时**: 4天

**优化内容**:
```javascript
async createTeamApplication(applicationData) {
  // 1. 检查成员重复
  const existingMember = await nedbService.getProjectMember(
    applicationData.projectId, 
    applicationData.applicantId
  )
  if (existingMember) {
    throw new Error('您已经是该项目的成员')
  }
  
  // 2. 检查待审批申请
  const pendingApps = await nedbService.getTeamApplications({
    projectId: applicationData.projectId,
    applicantId: applicationData.applicantId,
    status: 'pending'
  })
  if (pendingApps.length > 0) {
    throw new Error('您已有待审批的申请')
  }
  
  // 3. 验证分配比例总和
  const totalRatio = applicationData.members.reduce(
    (sum, m) => sum + (m.allocationPercentage || 0), 0
  )
  if (Math.abs(totalRatio - 100) > 0.01) {
    throw new Error(`成员分配比例总和必须为100%，当前${totalRatio}%`)
  }
  
  // 4. 验证预估成本
  const project = await nedbService.getProjectById(applicationData.projectId)
  if (applicationData.estimatedCost > project.budget * 1.2) {
    throw new Error('预估成本不能超过项目预算的120%')
  }
  
  // 5. 创建申请
  return await nedbService.createTeamApplication({
    ...applicationData,
    totalMembers: applicationData.members.length,
    submittedAt: new Date()
  })
}
```

**事务支持**:
```javascript
async approveTeamApplication(applicationId, approverId, approved, comments) {
  const session = await nedbService.startSession()
  
  try {
    await session.startTransaction()
    
    // 更新申请状态
    await nedbService.updateTeamApplication(applicationId, {
      status: approved ? 'approved' : 'rejected',
      approvedBy: approverId,
      approvedAt: new Date(),
      approvalComments: comments
    }, { session })
    
    if (approved) {
      // 批量创建成员记录
      const application = await nedbService.getTeamApplicationById(applicationId)
      for (const member of application.members) {
        await nedbService.createProjectMember({
          projectId: application.projectId,
          employeeId: member.employeeId,
          applicationId,
          role: member.roleName,
          contributionWeight: member.contributionWeight,
          status: 'active',
          joinDate: new Date()
        }, { session })
      }
      
      // 更新项目状态
      await nedbService.updateProject(application.projectId, {
        cooperationStatus: 'approved'
      }, { session })
    }
    
    await session.commitTransaction()
    
  } catch (error) {
    await session.abortTransaction()
    throw error
  } finally {
    session.endSession()
  }
}
```

---

#### 任务 1.2.3: 审批流程引擎实现
**新建文件**: `backend/src/services/approvalFlowService.js`  
**优先级**: P1  
**工时**: 5天

**核心服务**:
```javascript
class ApprovalFlowService {
  // 启动审批流程
  async startApprovalFlow(flowType, entityId, initiatorId, data) {
    const flow = await this.getDefaultFlow(flowType)
    const instance = await nedbService.createApprovalInstance({
      flowId: flow.id,
      applicationId: entityId,
      currentStep: 1,
      status: 'pending',
      initiatedBy: initiatorId,
      approvalData: {
        steps: flow.steps.map(step => ({
          ...step,
          status: 'pending'
        }))
      }
    })
    return instance
  }
  
  // 审批当前步骤
  async approveCurrentStep(instanceId, approverId, approved, comments) {
    const instance = await nedbService.getApprovalInstanceById(instanceId)
    const currentStepIndex = instance.currentStep - 1
    const steps = instance.approvalData.steps
    
    // 更新当前步骤
    steps[currentStepIndex] = {
      ...steps[currentStepIndex],
      status: approved ? 'approved' : 'rejected',
      approvedBy: approverId,
      approvedAt: new Date(),
      comments
    }
    
    let newStatus, newStep
    if (!approved) {
      newStatus = 'rejected'
    } else if (currentStepIndex < steps.length - 1) {
      newStep = instance.currentStep + 1
    } else {
      newStatus = 'approved'
    }
    
    return await nedbService.updateApprovalInstance(instanceId, {
      currentStep: newStep,
      status: newStatus,
      completedAt: newStatus !== 'pending' ? new Date() : null,
      approvalData: { steps }
    })
  }
  
  // 获取审批历史
  async getApprovalHistory(entityId, entityType) {
    return await nedbService.getApprovalInstances({
      applicationId: entityId
    })
  }
}
```

---

### 任务组 1.3: 前端基础组件 (Week 4)

#### 任务 1.3.1: 成员选择器组件
**新建文件**: `frontend/src/views/project/components/MemberSelector.vue`  
**优先级**: P0  
**工时**: 3天

**组件结构**:
```vue
<template>
  <el-dialog v-model="visible" title="选择团队成员" width="800px">
    <!-- 搜索栏 -->
    <el-form :inline="true">
      <el-form-item label="姓名">
        <el-input v-model="searchForm.name" placeholder="请输入姓名" />
      </el-form-item>
      <el-form-item label="部门">
        <el-select v-model="searchForm.departmentId">
          <el-option v-for="dept in departments" :key="dept.id" 
                     :label="dept.name" :value="dept.id" />
        </el-select>
      </el-form-item>
    </el-form>

    <!-- 员工表格 -->
    <el-table :data="filteredEmployees" @selection-change="handleSelectionChange">
      <el-table-column type="selection" width="55" />
      <el-table-column prop="employeeCode" label="工号" />
      <el-table-column prop="name" label="姓名" />
      <el-table-column prop="departmentName" label="部门" />
      <el-table-column prop="positionName" label="岗位" />
      <el-table-column label="技能">
        <template #default="{ row }">
          <el-tag v-for="skill in row.skills" :key="skill" size="small">
            {{ skill }}
          </el-tag>
        </template>
      </el-table-column>
    </el-table>

    <!-- 已选成员 -->
    <div v-if="selectedMembers.length > 0" class="selected-members">
      <el-divider>已选成员 ({{ selectedMembers.length }})</el-divider>
      <el-tag v-for="member in selectedMembers" :key="member.id" 
              closable @close="handleRemoveMember(member)">
        {{ member.name }} - {{ member.positionName }}
      </el-tag>
    </div>

    <template #footer>
      <el-button @click="visible = false">取消</el-button>
      <el-button type="primary" @click="handleConfirm">
        确定 ({{ selectedMembers.length }})
      </el-button>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { employeeApi } from '@/api/employee'

const employees = ref([])
const selectedMembers = ref([])
const searchForm = ref({ name: '', departmentId: '' })

const filteredEmployees = computed(() => {
  let result = employees.value
  if (searchForm.value.name) {
    result = result.filter(e => e.name.includes(searchForm.value.name))
  }
  if (searchForm.value.departmentId) {
    result = result.filter(e => e.departmentId === searchForm.value.departmentId)
  }
  return result
})

const loadEmployees = async () => {
  const res = await employeeApi.getList({ page: 1, pageSize: 1000 })
  employees.value = res.data.employees
}

onMounted(() => loadEmployees())
</script>
```

---

#### 任务 1.3.2: 角色权重配置组件
**新建文件**: `frontend/src/views/project/components/RoleWeightConfig.vue`  
**优先级**: P0  
**工时**: 3天

**功能**: 拖拽式权重分配、实时总和验证、可视化展示

```vue
<template>
  <div class="role-weight-config">
    <el-table :data="members" border>
      <el-table-column prop="name" label="成员" width="120" />
      <el-table-column label="项目角色" width="150">
        <template #default="{ row }">
          <el-select v-model="row.roleName">
            <el-option v-for="role in projectRoles" :key="role.code" 
                       :label="role.name" :value="role.name" />
          </el-select>
        </template>
      </el-table-column>
      
      <el-table-column label="贡献权重" width="200">
        <template #default="{ row }">
          <el-slider v-model="row.contributionWeight" :min="0" :max="2" 
                     :step="0.1" show-input @change="validateTotal" />
        </template>
      </el-table-column>
      
      <el-table-column label="工作量 (%)" width="200">
        <template #default="{ row }">
          <el-input-number v-model="row.estimatedWorkload" :min="0" :max="100" 
                           @change="validateAllocation" />
        </template>
      </el-table-column>
      
      <el-table-column label="分配比例 (%)" width="200">
        <template #default="{ row }">
          <el-input-number v-model="row.allocationPercentage" :min="0" :max="100" 
                           @change="validateAllocation" />
        </template>
      </el-table-column>
      
      <el-table-column label="申请理由">
        <template #default="{ row }">
          <el-input v-model="row.reason" type="textarea" rows="2" 
                    placeholder="请说明该成员的作用" />
        </template>
      </el-table-column>
      
      <el-table-column label="操作" width="80" fixed="right">
        <template #default="{ $index }">
          <el-button link type="danger" @click="removeMember($index)">
            删除
          </el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- 统计信息 -->
    <el-card class="statistics-card">
      <template #header>分配统计</template>
      <el-descriptions :column="3" border>
        <el-descriptions-item label="工作量总和">
          <el-tag :type="workloadTotal === 100 ? 'success' : 'danger'">
            {{ workloadTotal }}%
          </el-tag>
        </el-descriptions-item>
        <el-descriptions-item label="分配比例总和">
          <el-tag :type="allocationTotal === 100 ? 'success' : 'danger'">
            {{ allocationTotal }}%
          </el-tag>
        </el-descriptions-item>
        <el-descriptions-item label="成员数量">
          {{ members.length }} 人
        </el-descriptions-item>
      </el-descriptions>
      
      <el-alert v-if="validationMessage" :type="validationType" 
                :title="validationMessage" style="margin-top: 10px" />
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'

const members = ref([])
const projectRoles = ref([])

const workloadTotal = computed(() => 
  members.value.reduce((sum, m) => sum + (m.estimatedWorkload || 0), 0)
)

const allocationTotal = computed(() => 
  members.value.reduce((sum, m) => sum + (m.allocationPercentage || 0), 0)
)

const validationMessage = ref('')
const validationType = ref<'success' | 'warning' | 'error'>('success')

const validateAllocation = () => {
  const workloadOk = Math.abs(workloadTotal.value - 100) < 0.01
  const allocationOk = Math.abs(allocationTotal.value - 100) < 0.01
  
  if (!workloadOk) {
    validationMessage.value = `工作量总和应为100%，当前为${workloadTotal.value}%`
    validationType.value = 'error'
  } else if (!allocationOk) {
    validationMessage.value = `分配比例总和应为100%，当前为${allocationTotal.value}%`
    validationType.value = 'error'
  } else {
    validationMessage.value = '分配配置正确！'
    validationType.value = 'success'
  }
}

watch([workloadTotal, allocationTotal], validateAllocation)
</script>
```

---

## 四、阶段二：业务流程实现 (Week 5-10)

### 任务组 2.1: 项目发布流程 (Week 5-6)

#### 任务 2.1.1: 需求模板管理
**优先级**: P1  
**工时**: 3天

**功能点**:
1. 模板列表展示
2. 创建/编辑模板
3. 模板分类管理
4. 模板应用到项目

**API开发**:
```javascript
// backend/src/services/requirementTemplateService.js
class RequirementTemplateService {
  async getTemplates(query) {
    return await nedbService.find('requirementTemplates', query)
  }
  
  async createTemplate(templateData) {
    return await nedbService.insert('requirementTemplates', {
      ...templateData,
      createdAt: new Date()
    })
  }
  
  async applyTemplate(templateId, projectId) {
    const template = await nedbService.findOne('requirementTemplates', 
                                                { _id: templateId })
    const requirements = template.requirements.map(req => ({
      ...req,
      projectId,
      createdAt: new Date()
    }))
    return await nedbService.insertMany('projectRequirements', requirements)
  }
}
```

---

#### 任务 2.1.2: 项目发布向导
**新建文件**: `frontend/src/views/project/PublishWizard.vue`  
**优先级**: P0  
**工时**: 4天

**分步骤表单**:
```vue
<template>
  <el-dialog v-model="visible" title="发布项目" width="900px">
    <el-steps :active="currentStep" finish-status="success" align-center>
      <el-step title="基本信息" />
      <el-step title="需求设定" />
      <el-step title="预算配置" />
      <el-step title="确认发布" />
    </el-steps>

    <div class="step-content">
      <!-- 步骤1: 基本信息 -->
      <el-form v-show="currentStep === 0" ref="basicForm" 
               :model="projectData" :rules="basicRules">
        <el-form-item label="项目名称" prop="name">
          <el-input v-model="projectData.name" />
        </el-form-item>
        <el-form-item label="项目代码" prop="code">
          <el-input v-model="projectData.code" />
        </el-form-item>
        <el-form-item label="项目描述" prop="description">
          <el-input v-model="projectData.description" type="textarea" :rows="4" 
                    placeholder="请详细描述项目背景、目标和预期成果" />
        </el-form-item>
        <el-form-item label="工作内容" prop="workContent">
          <el-input v-model="projectData.workContent" type="textarea" :rows="6" 
                    placeholder="请描述项目的主要工作内容和任务" />
        </el-form-item>
        <el-form-item label="优先级" prop="priority">
          <el-radio-group v-model="projectData.priority">
            <el-radio label="low">低</el-radio>
            <el-radio label="medium">中</el-radio>
            <el-radio label="high">高</el-radio>
            <el-radio label="critical">紧急</el-radio>
          </el-radio-group>
        </el-form-item>
      </el-form>

      <!-- 步骤2: 需求设定 -->
      <div v-show="currentStep === 1">
        <el-button @click="showTemplateSelector = true">
          从模板选择
        </el-button>
        <el-button @click="addRequirement">新增需求</el-button>
        
        <el-table :data="projectData.requirements" style="margin-top: 20px">
          <el-table-column label="需求类型" width="120">
            <template #default="{ row }">
              <el-select v-model="row.type">
                <el-option label="技术需求" value="technical" />
                <el-option label="业务需求" value="business" />
                <el-option label="质量需求" value="quality" />
              </el-select>
            </template>
          </el-table-column>
          <el-table-column label="需求标题" prop="title" />
          <el-table-column label="需求描述" prop="description" />
          <el-table-column label="优先级" width="100">
            <template #default="{ row }">
              <el-tag :type="getPriorityType(row.priority)">
                {{ row.priority }}
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column label="操作" width="100">
            <template #default="{ $index }">
              <el-button link @click="editRequirement($index)">编辑</el-button>
              <el-button link type="danger" @click="removeRequirement($index)">
                删除
              </el-button>
            </template>
          </el-table-column>
        </el-table>
        
        <el-form-item label="技能要求" style="margin-top: 20px">
          <el-select v-model="projectData.skillRequirements" 
                     multiple filterable allow-create>
            <el-option v-for="skill in skillTags" :key="skill" 
                       :label="skill" :value="skill" />
          </el-select>
        </el-form-item>
      </div>

      <!-- 步骤3: 预算配置 -->
      <el-form v-show="currentStep === 2" label-width="120px">
        <el-form-item label="项目预算">
          <el-input-number v-model="projectData.budget" :min="0" :step="10000" />
          <span style="margin-left: 10px">元</span>
        </el-form-item>
        <el-form-item label="奖金规模">
          <el-input-number v-model="projectData.bonusScale" :min="0" :step="5000" />
          <span style="margin-left: 10px">元</span>
        </el-form-item>
        <el-form-item label="利润目标">
          <el-input-number v-model="projectData.profitTarget" :min="0" :step="10000" />
          <span style="margin-left: 10px">元</span>
        </el-form-item>
        <el-form-item label="项目周期">
          <el-date-picker v-model="projectData.startDate" type="date" 
                          placeholder="开始日期" />
          <span style="margin: 0 10px">至</span>
          <el-date-picker v-model="projectData.endDate" type="date" 
                          placeholder="结束日期" />
        </el-form-item>
      </el-form>

      <!-- 步骤4: 确认发布 -->
      <div v-show="currentStep === 3" class="preview-content">
        <el-descriptions title="项目信息预览" :column="2" border>
          <el-descriptions-item label="项目名称">
            {{ projectData.name }}
          </el-descriptions-item>
          <el-descriptions-item label="项目代码">
            {{ projectData.code }}
          </el-descriptions-item>
          <el-descriptions-item label="项目描述" :span="2">
            {{ projectData.description }}
          </el-descriptions-item>
          <el-descriptions-item label="需求数量">
            {{ projectData.requirements.length }} 项
          </el-descriptions-item>
          <el-descriptions-item label="技能要求">
            <el-tag v-for="skill in projectData.skillRequirements" 
                    :key="skill" size="small">
              {{ skill }}
            </el-tag>
          </el-descriptions-item>
          <el-descriptions-item label="项目预算">
            {{ formatCurrency(projectData.budget) }}
          </el-descriptions-item>
          <el-descriptions-item label="奖金规模">
            {{ formatCurrency(projectData.bonusScale) }}
          </el-descriptions-item>
        </el-descriptions>
      </div>
    </div>

    <template #footer>
      <el-button v-if="currentStep > 0" @click="prevStep">上一步</el-button>
      <el-button v-if="currentStep < 3" type="primary" @click="nextStep">
        下一步
      </el-button>
      <el-button v-if="currentStep === 3" type="primary" 
                 :loading="publishing" @click="handlePublish">
        确认发布
      </el-button>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { projectCollaborationApi } from '@/api/projectCollaboration'
import { ElMessage } from 'element-plus'

const currentStep = ref(0)
const publishing = ref(false)
const projectData = ref({
  name: '',
  code: '',
  description: '',
  workContent: '',
  priority: 'medium',
  requirements: [],
  skillRequirements: [],
  budget: 0,
  bonusScale: 0,
  profitTarget: 0,
  startDate: null,
  endDate: null
})

const nextStep = () => {
  if (currentStep.value < 3) currentStep.value++
}

const prevStep = () => {
  if (currentStep.value > 0) currentStep.value--
}

const handlePublish = async () => {
  try {
    publishing.value = true
    await projectCollaborationApi.publishProject(projectData.value)
    ElMessage.success('项目发布成功')
    visible.value = false
  } catch (error) {
    ElMessage.error('项目发布失败')
  } finally {
    publishing.value = false
  }
}
</script>
```

---

### 任务组 2.2: 团队申请流程 (Week 7-8)

#### 任务 2.2.1: 团队申请表单
**新建文件**: `frontend/src/views/project/components/TeamApplicationForm.vue`  
**优先级**: P0  
**工时**: 4天

**功能模块**:
1. 团队基本信息
2. 成员选择与配置
3. 成本预估
4. 申请理由

```vue
<template>
  <el-form ref="formRef" :model="formData" :rules="rules" label-width="120px">
    <!-- 团队基本信息 -->
    <el-card header="团队基本信息">
      <el-form-item label="团队名称" prop="teamName">
        <el-input v-model="formData.teamName" 
                  placeholder="请输入团队名称，如：XX项目核心团队" />
      </el-form-item>
      <el-form-item label="团队描述" prop="teamDescription">
        <el-input v-model="formData.teamDescription" type="textarea" :rows="4" 
                  placeholder="请描述团队的组成、优势和特点" />
      </el-form-item>
    </el-card>

    <!-- 团队成员 -->
    <el-card header="团队成员" style="margin-top: 20px">
      <el-button @click="showMemberSelector = true" icon="Plus">
        添加成员
      </el-button>
      
      <!-- 使用角色权重配置组件 -->
      <RoleWeightConfig v-model:members="formData.members" 
                        :project-roles="projectRoles" 
                        @validate="handleMemberValidation" />
    </el-card>

    <!-- 成本预估 -->
    <el-card header="成本预估" style="margin-top: 20px">
      <el-form-item label="预估成本">
        <el-input-number v-model="formData.estimatedCost" :min="0" :step="10000" />
        <span style="margin-left: 10px">元</span>
        <el-tag v-if="project.budget" style="margin-left: 20px" 
                :type="costValidationType">
          项目预算: {{ formatCurrency(project.budget) }}
          (占比: {{ costPercentage }}%)
        </el-tag>
      </el-form-item>
      
      <el-alert v-if="formData.estimatedCost > project.budget * 1.2" 
                type="error" title="预估成本超出项目预算的120%，请重新调整" />
    </el-card>

    <!-- 申请理由 -->
    <el-card header="申请理由" style="margin-top: 20px">
      <el-form-item label="申请理由" prop="applicationReason">
        <el-input v-model="formData.applicationReason" type="textarea" :rows="6" 
                  placeholder="请详细说明：1. 团队如何满足项目需求 2. 团队成员的分工和优势 3. 预期的项目成果" 
                  :minlength="50" show-word-limit />
      </el-form-item>
    </el-card>
  </el-form>

  <!-- 成员选择器 -->
  <MemberSelector v-model="showMemberSelector" @confirm="handleMembersSelected" />
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import RoleWeightConfig from './RoleWeightConfig.vue'
import MemberSelector from './MemberSelector.vue'

interface Props {
  project: any
}

const props = defineProps<Props>()

const formData = ref({
  teamName: '',
  teamDescription: '',
  members: [],
  estimatedCost: 0,
  applicationReason: ''
})

const costPercentage = computed(() => {
  if (!props.project.budget) return 0
  return ((formData.value.estimatedCost / props.project.budget) * 100).toFixed(2)
})

const costValidationType = computed(() => {
  const percentage = parseFloat(costPercentage.value)
  if (percentage <= 100) return 'success'
  if (percentage <= 120) return 'warning'
  return 'danger'
})

const rules = {
  teamName: [
    { required: true, message: '请输入团队名称', trigger: 'blur' },
    { min: 3, max: 100, message: '团队名称长度在3-100字符之间', trigger: 'blur' }
  ],
  teamDescription: [
    { required: true, message: '请输入团队描述', trigger: 'blur' },
    { min: 20, message: '团队描述不少于20字符', trigger: 'blur' }
  ],
  applicationReason: [
    { required: true, message: '请输入申请理由', trigger: 'blur' },
    { min: 50, message: '申请理由不少于50字符', trigger: 'blur' }
  ]
}

const handleMembersSelected = (members: any[]) => {
  formData.value.members.push(...members.map(m => ({
    employeeId: m.id,
    name: m.name,
    positionName: m.positionName,
    roleName: '',
    contributionWeight: 1.0,
    estimatedWorkload: 0,
    allocationPercentage: 0,
    reason: ''
  })))
}
</script>
```

---

#### 任务 2.2.2: 申请提交与状态跟踪
**优先级**: P0  
**工时**: 3天

**我的申请页面**:
```vue
<template>
  <div class="my-applications">
    <!-- 筛选栏 -->
    <el-form :inline="true">
      <el-form-item label="项目名称">
        <el-input v-model="queryParams.projectName" placeholder="请输入项目名称" 
                  clearable @clear="loadApplications" />
      </el-form-item>
      <el-form-item label="申请状态">
        <el-select v-model="queryParams.status" clearable>
          <el-option label="待审批" value="pending" />
          <el-option label="已批准" value="approved" />
          <el-option label="已拒绝" value="rejected" />
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="loadApplications">查询</el-button>
      </el-form-item>
    </el-form>

    <!-- 申请列表 -->
    <el-table :data="applications" v-loading="loading">
      <el-table-column label="项目名称" prop="Project.name" width="200" />
      <el-table-column label="团队名称" prop="teamName" width="150" />
      <el-table-column label="成员数量" prop="totalMembers" width="100" align="center" />
      <el-table-column label="预估成本" width="120" align="right">
        <template #default="{ row }">
          {{ formatCurrency(row.estimatedCost) }}
        </template>
      </el-table-column>
      <el-table-column label="申请状态" width="100" align="center">
        <template #default="{ row }">
          <el-tag :type="getStatusType(row.status)">
            {{ getStatusText(row.status) }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="提交时间" width="180">
        <template #default="{ row }">
          {{ formatDateTime(row.submittedAt) }}
        </template>
      </el-table-column>
      <el-table-column label="审批时间" width="180">
        <template #default="{ row }">
          {{ row.approvedAt ? formatDateTime(row.approvedAt) : '-' }}
        </template>
      </el-table-column>
      <el-table-column label="操作" fixed="right" width="150">
        <template #default="{ row }">
          <el-button link @click="viewDetail(row)">查看详情</el-button>
          <el-button v-if="row.status === 'pending'" link type="danger" 
                     @click="withdrawApplication(row.id)">
            撤回
          </el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- 分页 -->
    <el-pagination
      v-model:current-page="queryParams.page"
      v-model:page-size="queryParams.pageSize"
      :total="total"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="loadApplications"
      @current-change="loadApplications"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { projectCollaborationApi } from '@/api/projectCollaboration'

const applications = ref([])
const loading = ref(false)
const total = ref(0)
const queryParams = ref({
  page: 1,
  pageSize: 10,
  projectName: '',
  status: ''
})

const loadApplications = async () => {
  loading.value = true
  try {
    const res = await projectCollaborationApi.getMyApplications(queryParams.value)
    applications.value = res.data.applications
    total.value = res.data.pagination.total
  } finally {
    loading.value = false
  }
}

const getStatusType = (status: string) => {
  const map: Record<string, string> = {
    pending: 'warning',
    approved: 'success',
    rejected: 'danger'
  }
  return map[status] || 'info'
}

const getStatusText = (status: string) => {
  const map: Record<string, string> = {
    pending: '待审批',
    approved: '已批准',
    rejected: '已拒绝'
  }
  return map[status] || status
}

onMounted(() => loadApplications())
</script>
```

---

### 任务组 2.3: 审批决策流程 (Week 9-10)

#### 任务 2.3.1: 审批页面开发
**文件**: `frontend/src/views/project/ProjectMemberApproval.vue`  
**优先级**: P0  
**工时**: 4天

**审批功能**:
```vue
<template>
  <div class="approval-page">
    <!-- 待审批列表 -->
    <el-card header="待审批申请">
      <el-table :data="pendingApplications" v-loading="loading">
        <el-table-column label="项目" prop="Project.name" width="200" />
        <el-table-column label="团队" prop="teamName" width="150" />
        <el-table-column label="申请人" prop="ApplicantName" width="120" />
        <el-table-column label="成员数" prop="totalMembers" width="80" align="center" />
        <el-table-column label="预估成本" width="120" align="right">
          <template #default="{ row }">
            {{ formatCurrency(row.estimatedCost) }}
          </template>
        </el-table-column>
        <el-table-column label="提交时间" width="180">
          <template #default="{ row }">
            {{ formatDateTime(row.submittedAt) }}
          </template>
        </el-table-column>
        <el-table-column label="操作" fixed="right" width="150">
          <template #default="{ row }">
            <el-button link type="primary" @click="openApprovalDialog(row)">
              审批
            </el-button>
            <el-button link @click="viewApplicationDetail(row)">
              详情
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <!-- 审批对话框 -->
    <el-dialog v-model="approvalDialogVisible" title="团队申请审批" width="900px">
      <el-descriptions title="申请信息" :column="2" border>
        <el-descriptions-item label="项目名称">
          {{ currentApplication?.Project?.name }}
        </el-descriptions-item>
        <el-descriptions-item label="团队名称">
          {{ currentApplication?.teamName }}
        </el-descriptions-item>
        <el-descriptions-item label="申请人">
          {{ currentApplication?.ApplicantName }}
        </el-descriptions-item>
        <el-descriptions-item label="提交时间">
          {{ formatDateTime(currentApplication?.submittedAt) }}
        </el-descriptions-item>
        <el-descriptions-item label="团队描述" :span="2">
          {{ currentApplication?.teamDescription }}
        </el-descriptions-item>
        <el-descriptions-item label="申请理由" :span="2">
          {{ currentApplication?.applicationReason }}
        </el-descriptions-item>
      </el-descriptions>

      <!-- 团队成员列表 -->
      <el-divider content-position="left">团队成员</el-divider>
      <el-table :data="currentApplication?.members" border>
        <el-table-column label="姓名" prop="name" width="120" />
        <el-table-column label="部门" prop="departmentName" />
        <el-table-column label="岗位" prop="positionName" />
        <el-table-column label="项目角色" prop="roleName" width="120" />
        <el-table-column label="贡献权重" prop="contributionWeight" width="100" 
                         align="center" />
        <el-table-column label="工作量" width="100" align="center">
          <template #default="{ row }">
            {{ row.estimatedWorkload }}%
          </template>
        </el-table-column>
        <el-table-column label="分配比例" width="100" align="center">
          <template #default="{ row }">
            {{ row.allocationPercentage }}%
          </template>
        </el-table-column>
        <el-table-column label="申请理由" prop="reason" show-overflow-tooltip />
      </el-table>

      <!-- 审批表单 -->
      <el-divider content-position="left">审批决策</el-divider>
      <el-form ref="approvalFormRef" :model="approvalForm" label-width="100px">
        <el-form-item label="审批决定">
          <el-radio-group v-model="approvalForm.action">
            <el-radio label="approve">批准申请</el-radio>
            <el-radio label="reject">拒绝申请</el-radio>
            <el-radio label="modify">要求修改</el-radio>
          </el-radio-group>
        </el-form-item>
        
        <el-form-item label="审批意见" 
                      :rules="[{ required: true, message: '请填写审批意见' }]">
          <el-input v-model="approvalForm.comments" type="textarea" :rows="4" 
                    :placeholder="getCommentsPlaceholder()" 
                    :minlength="10" show-word-limit />
        </el-form-item>
        
        <el-form-item v-if="approvalForm.action === 'modify'" label="修改要求">
          <el-checkbox-group v-model="approvalForm.modifications">
            <el-checkbox label="调整团队结构">调整团队结构</el-checkbox>
            <el-checkbox label="优化成本预估">优化成本预估</el-checkbox>
            <el-checkbox label="补充申请理由">补充申请理由</el-checkbox>
            <el-checkbox label="调整成员权重">调整成员权重</el-checkbox>
          </el-checkbox-group>
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="approvalDialogVisible = false">取消</el-button>
        <el-button type="primary" :loading="submitting" @click="submitApproval">
          提交审批
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { projectCollaborationApi } from '@/api/projectCollaboration'
import { ElMessage, ElMessageBox } from 'element-plus'

const pendingApplications = ref([])
const currentApplication = ref(null)
const approvalDialogVisible = ref(false)
const loading = ref(false)
const submitting = ref(false)

const approvalForm = ref({
  action: 'approve',
  comments: '',
  modifications: []
})

const loadPendingApplications = async () => {
  loading.value = true
  try {
    const res = await projectCollaborationApi.getPendingApplications({
      status: 'pending'
    })
    pendingApplications.value = res.data.applications
  } finally {
    loading.value = false
  }
}

const openApprovalDialog = (application: any) => {
  currentApplication.value = application
  approvalDialogVisible.value = true
  approvalForm.value = {
    action: 'approve',
    comments: '',
    modifications: []
  }
}

const getCommentsPlaceholder = () => {
  const placeholders = {
    approve: '请填写批准理由和后续注意事项',
    reject: '请详细说明拒绝理由',
    modify: '请具体说明需要修改的内容和要求'
  }
  return placeholders[approvalForm.value.action as keyof typeof placeholders]
}

const submitApproval = async () => {
  try {
    await ElMessageBox.confirm(
      `确定要${getActionText()}这个团队申请吗？`,
      '确认审批',
      { type: 'warning' }
    )
    
    submitting.value = true
    
    await projectCollaborationApi.approveTeamApplication(
      currentApplication.value.id,
      {
        action: approvalForm.value.action,
        comments: approvalForm.value.comments,
        modifications: approvalForm.value.modifications
      }
    )
    
    ElMessage.success('审批成功')
    approvalDialogVisible.value = false
    await loadPendingApplications()
    
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('审批失败')
    }
  } finally {
    submitting.value = false
  }
}

const getActionText = () => {
  const texts = {
    approve: '批准',
    reject: '拒绝',
    modify: '要求修改'
  }
  return texts[approvalForm.value.action as keyof typeof texts]
}

onMounted(() => loadPendingApplications())
</script>
```

---

#### 任务 2.3.2: 审批流程引擎集成
**优先级**: P1  
**工时**: 3天

**后端集成**:
```javascript
// backend/src/controllers/projectCollaborationController.js

async approveTeamApplication(req, res, next) {
  try {
    const { applicationId } = req.params
    const { action, comments } = req.body
    const user = req.user
    
    // 获取申请信息
    const application = await getDataService().getTeamApplicationById(applicationId)
    
    // 检查是否已启动审批流程
    let approvalInstance = await approvalFlowService.getInstanceByApplication(
      applicationId
    )
    
    if (!approvalInstance) {
      // 启动审批流程
      approvalInstance = await approvalFlowService.startApprovalFlow(
        'team_application',
        applicationId,
        user.id,
        { projectId: application.projectId }
      )
    }
    
    // 审批当前步骤
    const updatedInstance = await approvalFlowService.approveCurrentStep(
      approvalInstance._id,
      user.id,
      action === 'approve',
      comments
    )
    
    // 如果审批流程完成，更新申请状态
    if (updatedInstance.status === 'approved') {
      await projectCollaborationService.approveTeamApplication(
        applicationId,
        user.id,
        true,
        comments
      )
    } else if (updatedInstance.status === 'rejected') {
      await projectCollaborationService.approveTeamApplication(
        applicationId,
        user.id,
        false,
        comments
      )
    }
    
    res.json({
      code: 200,
      message: '审批成功',
      data: {
        application: updatedInstance,
        nextStep: updatedInstance.currentStep,
        status: updatedInstance.status
      }
    })
    
  } catch (error) {
    logger.error('Approve team application error:', error)
    next(error)
  }
}
```

---

## 五、阶段三：系统集成与优化 (Week 11-13)

### 任务组 3.1: 权限集成测试 (Week 11)

#### 任务 3.1.1: 权限验证测试
**优先级**: P0  
**工时**: 2天

**测试用例**:
```typescript
// frontend/tests/project-collaboration-permissions.spec.ts

import { test, expect } from '@playwright/test'

test.describe('项目协作权限测试', () => {
  test('管理员可以发布项目', async ({ page }) => {
    await page.goto('/login')
    await page.fill('input[name="username"]', 'admin')
    await page.fill('input[name="password"]', 'admin123')
    await page.click('button[type="submit"]')
    
    await page.goto('/project/collaboration')
    await expect(page.locator('button:has-text("发布项目")')).toBeVisible()
  })
  
  test('项目经理可以申请团队', async ({ page }) => {
    await page.goto('/login')
    await page.fill('input[name="username"]', 'project_manager')
    await page.fill('input[name="password"]', 'password')
    await page.click('button[type="submit"]')
    
    await page.goto('/project/collaboration')
    await expect(page.locator('button:has-text("申请团队")')).toBeVisible()
  })
  
  test('普通用户不能发布项目', async ({ page }) => {
    await page.goto('/login')
    await page.fill('input[name="username"]', 'employee')
    await page.fill('input[name="password"]', 'password')
    await page.click('button[type="submit"]')
    
    await page.goto('/project/collaboration')
    await expect(page.locator('button:has-text("发布项目")')).not.toBeVisible()
  })
})
```

---

#### 任务 3.1.2: API权限测试
**优先级**: P0  
**工时**: 2天

**Postman测试集**:
```javascript
// 测试1: 发布项目 - 需要project:create权限
pm.test("管理员可以发布项目", function () {
    pm.sendRequest({
        url: pm.environment.get("baseUrl") + "/project-collaboration/publish",
        method: "POST",
        header: {
            "Authorization": "Bearer " + pm.environment.get("adminToken"),
            "Content-Type": "application/json"
        },
        body: {
            mode: "raw",
            raw: JSON.stringify({
                name: "测试项目",
                code: "TEST_001",
                description: "这是一个测试项目",
                workContent: "项目工作内容",
                budget: 100000
            })
        }
    }, function (err, res) {
        pm.expect(res.code).to.equal(200)
    })
})

// 测试2: 团队申请 - 需要project_manager权限
pm.test("项目经理可以申请团队", function () {
    // 测试逻辑...
})

// 测试3: 审批申请 - 需要member:approve权限
pm.test("管理员可以审批申请", function () {
    // 测试逻辑...
})
```

---

### 任务组 3.2: 性能优化 (Week 12)

#### 任务 3.2.1: 数据库查询优化
**优先级**: P1  
**工时**: 2天

**优化措施**:
```sql
-- 1. 添加覆盖索引
CREATE INDEX idx_applications_project_status_submitted 
  ON project_team_applications(project_id, status, submitted_at DESC);

-- 2. 优化联表查询
-- 原查询（N+1问题）:
SELECT * FROM project_team_applications WHERE status = 'pending';
-- 然后循环查询每个项目...

-- 优化后（JOIN查询）:
SELECT 
  a.*,
  p.name AS project_name,
  p.code AS project_code,
  u.username AS applicant_name
FROM project_team_applications a
LEFT JOIN projects p ON a.project_id = p.id
LEFT JOIN users u ON a.applicant_id = u.id
WHERE a.status = 'pending'
ORDER BY a.submitted_at DESC;

-- 3. 分页查询优化（使用游标分页）
SELECT * FROM project_team_applications
WHERE id > last_seen_id
ORDER BY id
LIMIT 10;
```

---

#### 任务 3.2.2: 前端性能优化
**优先级**: P1  
**工时**: 2天

**优化措施**:
```typescript
// 1. 虚拟滚动 - 大列表渲染优化
<template>
  <el-table-v2
    :columns="columns"
    :data="applications"
    :width="800"
    :height="600"
    fixed
  />
</template>

// 2. 防抖搜索
import { debounce } from 'lodash-es'

const handleSearch = debounce(async () => {
  await loadApplications()
}, 300)

// 3. 组件懒加载
const MemberSelector = defineAsyncComponent(() =>
  import('./components/MemberSelector.vue')
)

// 4. 数据缓存
import { useStorage } from '@vueuse/core'

const cachedApplications = useStorage('applications-cache', [])

const loadApplications = async () => {
  if (cachedApplications.value.length > 0) {
    applications.value = cachedApplications.value
  }
  
  const res = await projectCollaborationApi.getMyApplications()
  applications.value = res.data.applications
  cachedApplications.value = applications.value
}
```

---

### 任务组 3.3: 用户体验优化 (Week 13)

#### 任务 3.3.1: 交互优化
**优先级**: P1  
**工时**: 3天

**优化项**:
1. **加载状态优化**
```vue
<template>
  <el-skeleton v-if="loading" :rows="5" animated />
  <div v-else>
    <!-- 实际内容 -->
  </div>
</template>
```

2. **空状态优化**
```vue
<el-empty v-if="applications.length === 0"
  description="暂无申请记录"
  :image-size="200">
  <el-button type="primary" @click="showApplicationForm = true">
    创建第一个申请
  </el-button>
</el-empty>
```

3. **操作反馈优化**
```typescript
// 成功提示带进度条
ElMessage({
  type: 'success',
  message: '申请提交成功！正在跳转到申请列表...',
  duration: 2000,
  onClose: () => {
    router.push('/project/my-applications')
  }
})

// 错误提示带重试
ElMessageBox.confirm(
  '网络请求失败，是否重试？',
  '提示',
  {
    confirmButtonText: '重试',
    cancelButtonText: '取消',
    type: 'error'
  }
).then(() => {
  submitApplication()
})
```

---

## 六、阶段四：测试与上线 (Week 14-16)

### 任务组 4.1: 全流程测试 (Week 14)

#### 任务 4.1.1: E2E测试用例编写
**优先级**: P0  
**工时**: 3天

**完整流程测试**:
```typescript
// frontend/tests/project-collaboration-e2e.spec.ts

test('完整协作流程测试', async ({ page, browser }) => {
  // 1. 管理员登录并发布项目
  const adminContext = await browser.newContext()
  const adminPage = await adminContext.newPage()
  
  await adminPage.goto('/login')
  await adminPage.fill('input[name="username"]', 'admin')
  await adminPage.fill('input[name="password"]', 'admin123')
  await adminPage.click('button[type="submit"]')
  
  await adminPage.goto('/project/collaboration')
  await adminPage.click('button:has-text("发布项目")')
  
  // 填写项目信息
  await adminPage.fill('input[name="name"]', 'E2E测试项目')
  await adminPage.fill('input[name="code"]', `E2E_${Date.now()}`)
  await adminPage.fill('textarea[name="description"]', '这是一个端到端测试项目描述内容超过20字符')
  await adminPage.fill('textarea[name="workContent"]', '项目工作内容详细说明')
  
  // 提交发布
  await adminPage.click('button:has-text("确认发布")')
  await adminPage.waitForSelector('.el-message--success')
  
  // 2. 项目经理登录并申请团队
  const managerContext = await browser.newContext()
  const managerPage = await managerContext.newPage()
  
  await managerPage.goto('/login')
  await managerPage.fill('input[name="username"]', 'project_manager')
  await managerPage.fill('input[name="password"]', 'password')
  await managerPage.click('button[type="submit"]')
  
  await managerPage.goto('/project/collaboration')
  await managerPage.click('.project-item:first-child button:has-text("申请团队")')
  
  // 填写团队信息
  await managerPage.fill('input[name="teamName"]', 'E2E测试团队')
  await managerPage.fill('textarea[name="teamDescription"]', '这是一个端到端测试团队描述')
  
  // 添加成员
  await managerPage.click('button:has-text("添加成员")')
  await managerPage.check('.member-selector tbody tr:first-child input[type="checkbox"]')
  await managerPage.click('.member-selector button:has-text("确定")')
  
  // 填写申请理由
  await managerPage.fill('textarea[name="applicationReason"]', 
    '这是一个详细的申请理由，说明团队如何满足项目需求以及预期成果，字数需要超过50字符')
  
  // 提交申请
  await managerPage.click('button:has-text("提交申请")')
  await managerPage.waitForSelector('.el-message--success')
  
  // 3. 管理员审批申请
  await adminPage.goto('/project/member-approval')
  await adminPage.click('.application-item:first-child button:has-text("审批")')
  
  // 选择批准
  await adminPage.check('input[value="approve"]')
  await adminPage.fill('textarea[name="comments"]', '团队配置合理，批准组建申请')
  
  // 提交审批
  await adminPage.click('.approval-dialog button:has-text("提交审批")')
  await adminPage.waitForSelector('.el-message--success')
  
  // 4. 验证流程完成
  await managerPage.goto('/project/my-applications')
  await expect(
    managerPage.locator('.application-item:first-child .el-tag--success')
  ).toContainText('已批准')
  
  // 清理
  await adminContext.close()
  await managerContext.close()
})
```

---

#### 任务 4.1.2: 测试报告生成
**优先级**: P1  
**工时**: 1天

**配置Playwright报告**:
```typescript
// playwright.config.ts
export default defineConfig({
  reporter: [
    ['html', { outputFolder: 'test-results/html-report' }],
    ['json', { outputFile: 'test-results/test-results.json' }],
    ['junit', { outputFile: 'test-results/junit.xml' }]
  ],
  
  use: {
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
    trace: 'on-first-retry'
  }
})
```

---

### 任务组 4.2: 用户培训 (Week 15)

#### 任务 4.2.1: 培训文档编写
**优先级**: P1  
**工时**: 2天

**用户手册目录**:
```
项目协作模块用户手册
├── 1. 系统概述
│   ├── 1.1 功能介绍
│   └── 1.2 角色权限
├── 2. 管理层操作指南
│   ├── 2.1 如何发布项目
│   ├── 2.2 如何审批申请
│   └── 2.3 如何查看协作状态
├── 3. 项目经理操作指南
│   ├── 3.1 如何申请团队组建
│   ├── 3.2 如何查看申请状态
│   └── 3.3 如何响应审批意见
├── 4. 常见问题解答
└── 5. 联系支持
```

---

#### 任务 4.2.2: 在线培训与答疑
**优先级**: P1  
**工时**: 2天

**培训计划**:
- Day 1: 管理层培训（2小时）
- Day 2: 项目经理培训（2小时）
- Day 3-5: 现场答疑与问题收集

---

### 任务组 4.3: 生产部署 (Week 16)

#### 任务 4.3.1: 生产环境准备
**优先级**: P0  
**工时**: 2天

**部署清单**:
```bash
# 1. 数据库迁移
mysql -u root -p bonus_system < database/project-collaboration.sql

# 2. 后端部署
cd backend
npm install --production
pm2 start ecosystem.config.js --env production

# 3. 前端构建
cd frontend
npm run build
cp -r dist/* /var/www/bonus-system/

# 4. Nginx配置
nginx -t
systemctl reload nginx

# 5. 健康检查
curl http://localhost:3001/health
```

---

#### 任务 4.3.2: 上线监控与回滚预案
**优先级**: P0  
**工时**: 2天

**监控指标**:
- API响应时间 < 500ms
- 错误率 < 1%
- 系统可用性 > 99.5%

**回滚预案**:
```bash
# 快速回滚脚本
#!/bin/bash
set -e

echo "开始回滚..."

# 1. 恢复前端代码
cp -r /var/www/bonus-system-backup/* /var/www/bonus-system/

# 2. 恢复后端服务
pm2 stop bonus-system-backend
cp -r /opt/bonus-system-backup/* /opt/bonus-system/
pm2 start ecosystem.config.js

# 3. 恢复数据库（如有必要）
# mysql -u root -p bonus_system < backup.sql

echo "回滚完成！"
```

---

## 七、风险管理与应对

### 7.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| 数据库并发冲突 | 高 | 中 | 实施乐观锁+事务隔离 |
| API性能瓶颈 | 中 | 中 | Redis缓存+查询优化 |
| 前端兼容性问题 | 低 | 低 | 浏览器测试矩阵 |

### 7.2 进度风险

| 风险 | 应对措施 |
|------|---------|
| 需求变更频繁 | 版本冻结机制，变更需经评审 |
| 人员流动 | 知识文档化，双人备份 |
| 技术难点阻塞 | 提前技术预研，外部专家支持 |

### 7.3 业务风险

| 风险 | 应对措施 |
|------|---------|
| 用户接受度低 | 分阶段试点推广，收集反馈 |
| 数据迁移失败 | 完整备份+灰度迁移 |
| 权限配置错误 | 权限矩阵评审+自动化测试 |

---

## 八、质量保障措施

### 8.1 代码质量

- **代码审查**: 所有代码必须经过同行评审
- **单元测试**: 核心业务逻辑覆盖率 > 80%
- **静态分析**: ESLint + SonarQube扫描
- **代码规范**: 严格遵循项目编码规范

### 8.2 测试策略

```
测试金字塔
├── E2E测试 (10%)
│   └── 关键业务流程
├── 集成测试 (30%)
│   └── API接口测试
└── 单元测试 (60%)
    └── 业务逻辑测试
```

### 8.3 文档质量

- **API文档**: Swagger自动生成
- **代码注释**: JSDoc规范注释
- **用户文档**: Markdown格式，版本控制
- **变更日志**: CHANGELOG.md记录

---

## 九、成功标准

### 9.1 功能完整性
- ✅ 项目发布功能100%可用
- ✅ 团队申请流程完整闭环
- ✅ 审批决策机制有效运行
- ✅ 通知消息及时送达

### 9.2 性能指标
- ✅ 页面首屏加载 < 2秒
- ✅ API响应时间 < 500ms
- ✅ 支持100并发用户
- ✅ 系统可用性 > 99.5%

### 9.3 用户满意度
- ✅ 用户培训完成率 > 90%
- ✅ 用户满意度评分 > 4.0/5.0
- ✅ 系统使用率 > 70%
- ✅ Bug反馈率 < 5%

---

## 十、后续优化方向

### 10.1 短期优化 (1-3个月)
- 增加审批流程模板配置
- 实现移动端适配
- 增加数据导出功能
- 优化通知推送机制

### 10.2 中期规划 (3-6个月)
- 集成企业微信/钉钉通知
- 增加项目看板视图
- 实现智能推荐匹配
- 增加数据分析报表

### 10.3 长期愿景 (6-12个月)
- AI辅助审批决策
- 区块链审计追溯
- 跨系统数据打通
- 智能化流程优化

---

## 附录

### A. 技术栈清单
- **前端**: Vue 3 + TypeScript + Element Plus + Pinia
- **后端**: Node.js + Express + Sequelize/NeDB
- **数据库**: MySQL 8.0+ / NeDB
- **测试**: Playwright + Jest
- **部署**: Docker + PM2 + Nginx

### B. 参考文档
- [系统需求分析文档](./系统需求分析文档.md)
- [数据库设计文档](../database/project-collaboration.sql)
- [API接口文档](http://localhost:3001/api-docs)
- [前端组件库](https://element-plus.org/)

### C. 联系方式
- **技术负责人**: [姓名] - [邮箱]
- **产品负责人**: [姓名] - [邮箱]
- **项目经理**: [姓名] - [邮箱]

---

**文档结束**

*最后更新时间: 2025-10-17*
