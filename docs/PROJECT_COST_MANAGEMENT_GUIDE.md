# 项目成本管理模块使用指南

## 📋 功能概述

项目成本管理模块提供了完整的成本记录增删改查功能，帮助用户高效管理项目成本。

### 主要功能

1. **成本记录管理**
   - ✅ 创建成本记录
   - ✅ 编辑成本记录
   - ✅ 删除成本记录
   - ✅ 查询成本记录

2. **数据筛选与搜索**
   - 按项目筛选
   - 按成本类型筛选
   - 按日期范围筛选

3. **财务概览**
   - 总预算统计
   - 总成本统计
   - 预期利润计算
   - 预估奖金展示

## 🎯 核心功能详解

### 1. 创建成本记录

**操作步骤：**
1. 点击页面右上角的"录入成本"按钮
2. 填写必要信息：
   - **项目**：选择关联的项目（必填）
   - **成本类型**：选择人力成本、材料成本或其他成本（必填）
   - **金额**：输入成本金额（必填，最小0.01元）
   - **发生日期**：选择成本发生的日期（必填，不能超过今天）
   - **状态**：选择"已确认"或"待审核"
   - **描述**：详细描述成本情况（必填，5-500字）
3. 点击"创建"按钮提交

**表单验证规则：**
- 项目：必须选择
- 成本类型：必须选择
- 金额：必须大于0.01元
- 描述：长度5-500个字符
- 日期：必须选择，不能是未来日期

**成功提示：**
- 创建成功后显示"成本记录创建成功"
- 自动刷新成本列表和财务概览
- 对话框自动关闭

### 2. 编辑成本记录

**操作步骤：**
1. 在成本列表中找到要编辑的记录
2. 点击该记录行的"编辑"按钮
3. 在弹出的对话框中修改信息
4. 点击"更新"按钮保存

**注意事项：**
- 编辑功能会保留原有的记录ID
- 所有字段都可以修改
- 修改后会更新updatedAt时间戳
- 需要有相应的权限才能编辑

**错误处理：**
- 如果没有权限：显示"您没有权限修改此成本记录"
- 如果记录不存在：显示"未找到相关记录"
- 如果服务器错误：显示"服务器错误，请稍后重试"

### 3. 删除成本记录

**操作步骤：**
1. 在成本列表中找到要删除的记录
2. 点击该记录行的"删除"按钮
3. 在确认对话框中点击"确定"

**安全机制：**
- 删除前需要二次确认
- 只有有权限的用户才能删除
- 删除成功后自动刷新列表和财务数据

**权限控制：**
- 需要项目管理权限（manage）
- 项目经理和超级管理员可以删除

### 4. 搜索与筛选

**筛选条件：**
- **项目**：下拉选择特定项目
- **成本类型**：选择人力/材料/其他成本
- **日期范围**：选择起止日期范围

**操作按钮：**
- **搜索**：应用筛选条件查询
- **重置**：清空所有筛选条件

## 🎨 UI设计特点

### 1. 成本类型标签

```vue
人力成本 - 蓝色标签（primary）
材料成本 - 绿色标签（success）
其他成本 - 橙色标签（warning）
```

### 2. 状态标签

```vue
待审核 - 橙色标签（warning）
已确认 - 绿色标签（success）
已拒绝 - 红色标签（danger）
```

### 3. 财务概览卡片

采用渐变色图标设计：
- 💰 总预算 - 蓝色图标
- 💼 总成本 - 橙色图标
- 📈 预期利润 - 绿色图标（正值）/ 红色图标（负值）
- 🎁 预估奖金 - 红色图标

### 4. 表单增强

**金额输入框：**
- 支持步进调节（每次100元）
- 显示货币符号（¥）
- 精确到2位小数
- 最大值99,999,999.99元

**日期选择器：**
- 禁止选择未来日期
- 统一格式：YYYY-MM-DD
- 支持快捷选择

**成本类型选择：**
- 带说明文字的下拉选项
- 示例：人力成本（员工工资、福利等）

## 💻 技术实现

### 前端技术栈

```typescript
// 核心框架
Vue 3 Composition API
TypeScript 严格类型检查
Element Plus UI组件库

// 状态管理
Reactive 响应式数据
Ref 引用类型

// HTTP请求
Axios (通过request工具封装)
```

### API接口

```typescript
// 创建成本记录
POST /api/project-costs
Body: { projectId, costType, amount, description, date, status }

// 更新成本记录
PUT /api/project-costs/:costId
Body: Partial<ProjectCost>

// 删除成本记录
DELETE /api/project-costs/:costId

// 查询成本列表
GET /api/project-costs?projectId=&costType=&page=&pageSize=

// 查询项目列表
GET /api/projects
```

### 类型定义

```typescript
export interface ProjectCost {
  _id?: string
  projectId: string
  costType: '人力成本' | '材料成本' | '其他成本'
  amount: number
  description: string
  date: string
  recordedBy: string
  status: 'pending' | 'confirmed' | 'rejected'
  createdAt?: string
  updatedAt?: string
  projectName?: string  // 前端添加的关联字段
}
```

### 表单验证

```typescript
const costFormRules = {
  projectId: [
    { required: true, message: '请选择项目', trigger: 'change' }
  ],
  costType: [
    { required: true, message: '请选择成本类型', trigger: 'change' }
  ],
  amount: [
    { required: true, message: '请输入成本金额', trigger: 'blur' },
    { type: 'number', min: 0.01, message: '金额必须大于0', trigger: 'blur' }
  ],
  description: [
    { required: true, message: '请输入成本描述', trigger: 'blur' },
    { min: 5, max: 500, message: '描述长度应在5-500个字符之间', trigger: 'blur' }
  ],
  date: [
    { required: true, message: '请选择发生日期', trigger: 'change' }
  ]
}
```

## 🔧 错误处理机制

### 1. 网络错误处理

```typescript
try {
  await projectCostApi.updateCost(id, data)
} catch (error: any) {
  if (error.response) {
    const { status, data } = error.response
    
    switch (status) {
      case 400: ElMessage.error('请求参数有误，请检查输入'); break
      case 403: ElMessage.error('您没有权限执行此操作'); break
      case 404: ElMessage.error('未找到相关记录'); break
      case 500: ElMessage.error('服务器错误，请稍后重试'); break
      default: ElMessage.error(data.message || '操作失败，请重试')
    }
  }
}
```

### 2. 表单验证错误

- 实时验证：失焦时触发
- 提交验证：点击提交时验证所有字段
- 错误提示：红色文字显示在表单项下方

### 3. 权限错误

- 无权限访问：显示403错误
- 无权限操作：按钮置灰或隐藏
- 权限验证：后端二次验证

## 📊 数据流程

### 创建流程

```
用户填写表单 
  → 前端验证 
  → 调用创建API 
  → 后端验证权限 
  → 数据库插入 
  → 返回成功响应 
  → 刷新列表
  → 更新财务概览
```

### 编辑流程

```
点击编辑按钮 
  → 填充表单数据 
  → 用户修改 
  → 前端验证 
  → 调用更新API（带ID）
  → 后端验证权限 
  → 数据库更新 
  → 返回成功响应 
  → 刷新列表
```

### 删除流程

```
点击删除按钮 
  → 二次确认对话框 
  → 用户确认 
  → 调用删除API 
  → 后端验证权限 
  → 数据库删除 
  → 返回成功响应 
  → 刷新列表
  → 更新财务概览
```

## 🎯 最佳实践

### 1. 使用建议

**成本录入时机：**
- 建议在成本实际发生后尽快录入
- 大额成本需要审核后再确认
- 定期检查待审核的成本记录

**成本类型选择：**
- 人力成本：工资、奖金、福利、培训等
- 材料成本：设备采购、软件许可、工具购置等
- 其他成本：差旅费、办公费、咨询费等

**描述规范：**
- 明确说明成本项目
- 标注成本用途
- 包含必要的凭证信息
- 示例：「购买开发服务器2台，用于项目测试环境搭建」

### 2. 权限管理

**角色权限：**
- 超级管理员：所有权限
- 项目经理：管理本项目成本
- 财务人员：查看和审核
- 团队成员：仅查看

### 3. 数据安全

**防止误操作：**
- 删除需要二次确认
- 编辑会显示原有数据
- 关键操作有loading状态

**数据验证：**
- 前后端双重验证
- 金额范围限制
- 日期合理性检查

## 🐛 常见问题

### Q1: 为什么无法编辑成本记录？
**A:** 可能的原因：
1. 没有项目管理权限
2. 该成本记录已被删除
3. 网络连接问题
4. 服务器繁忙

**解决方法：**
- 检查用户权限
- 刷新页面重试
- 联系项目经理或管理员

### Q2: 提交表单后没有反应？
**A:** 检查项：
1. 是否所有必填项都已填写
2. 金额是否大于0
3. 描述长度是否在5-500字符之间
4. 日期是否选择正确
5. 打开浏览器控制台查看错误信息

### Q3: 财务概览数据不更新？
**A:** 可能原因：
1. 成本记录状态为"待审核"
2. 缓存未刷新
3. 权限不足无法查看

**解决方法：**
- 刷新页面
- 检查成本记录状态
- 联系管理员确认权限

### Q4: 如何批量导入成本记录？
**A:** 当前版本暂不支持批量导入，后续版本会添加：
- Excel导入功能
- CSV导入功能
- 导入模板下载

## 🚀 未来规划

### 计划中的功能

1. **批量操作**
   - 批量删除
   - 批量审核
   - 批量导出

2. **高级筛选**
   - 金额范围筛选
   - 多条件组合筛选
   - 保存筛选条件

3. **数据可视化**
   - 成本趋势图
   - 成本结构饼图
   - 项目对比柱状图

4. **审批流程**
   - 多级审批
   - 审批历史
   - 驳回重提

5. **报表功能**
   - 月度成本报表
   - 项目成本分析
   - 成本预警提醒

## 📞 技术支持

如有问题，请联系：
- 技术支持邮箱：support@company.com
- 项目负责人：xxx
- 开发团队：xxx

---

**文档版本**: v1.0.0  
**最后更新**: 2025-10-16  
**适用系统**: BonusAssign 项目管理系统
