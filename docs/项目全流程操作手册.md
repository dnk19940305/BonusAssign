# 项目全流程操作手册

## 测试账号信息

| 用户名 | 密码 | 角色 | 姓名 | 主要职责 |
|--------|------|------|------|----------|
| `hr_manager` | `test123` | HR管理员 | 王人事 | 员工管理、岗位管理 |
| `project_manager` | `test123` | 项目经理 | 张项目 | 项目创建、发布、管理 |
| `test_user` | `test123` | 普通员工 | 李测试 | 申请加入项目 |

---

## 完整业务流程图

```
阶段1：项目准备
  ├─ 项目经理：创建项目（草稿状态）
  └─ 项目经理：发布项目协作信息

阶段2：团队组建
  ├─ 普通员工：申请加入项目
  ├─ 项目经理：审批申请
  └─ 项目经理：启动项目

阶段3：项目执行
  ├─ 项目经理：创建项目奖金池
  ├─ 项目经理：记录项目成本
  └─ 项目经理：更新项目进度

阶段4：项目结项
  ├─ 项目经理：完成项目
  ├─ 系统：计算项目利润
  ├─ 系统：生成奖金池
  └─ 项目经理：分配奖金
```

---

## 阶段1：项目创建与发布

### 1.1 创建项目（草稿状态）

**操作人**：项目经理 (`project_manager`)

**操作步骤**：
1. 登录系统
2. 导航至：**项目管理 → 项目列表**
3. 点击 **新建项目** 按钮
4. 填写项目基本信息：
   ```
   项目名称：【必填】如"智慧园区系统开发"
   项目代码：【必填】唯一标识，如"PROJ2025001"
   所属业务线：【必填】选择业务线
   项目经理：【自动填充】当前用户
   开始日期：【必填】如2025-01-01
   结束日期：【必填】如2025-06-30
   项目描述：【可选】项目简介
   ```
5. 点击 **保存** 按钮
6. **系统返回**：
   - 项目ID（如：`proj_abc123`）
   - 项目状态：`draft`（草稿）
   - 成功提示："项目创建成功"

**重要说明**：
- ✅ 此时项目已创建，但未发布
- ✅ 草稿状态项目不显示在协作申请页面
- ✅ 可以继续编辑项目基本信息

**API调用**：
```javascript
// 文件：frontend/src/api/project.ts
POST /api/projects
{
  name: "智慧园区系统开发",
  code: "PROJ2025001",
  businessLineId: "line_001",
  managerId: "project_manager_id",
  startDate: "2025-01-01",
  endDate: "2025-06-30",
  description: "项目描述"
}

// 响应
{
  code: 200,
  data: {
    id: "proj_abc123",
    status: "draft",
    ...
  }
}
```

---

### 1.2 发布项目协作信息

**操作人**：项目经理 (`project_manager`)

**前置条件**：项目已创建（草稿状态）

**操作步骤**：
1. 在项目列表找到刚创建的项目
2. 点击项目行的 **发布协作** 按钮
3. 发布对话框显示：
   - **项目基本信息**（只读显示）：
     - 项目名称
     - 项目代码
     - 项目经理
     - 起止日期
   - **协作发布信息**（可编辑）：
     ```
     工作内容：【必填】详细描述项目工作内容
     技能要求：【必填】选择所需技能标签（多选）
     协作需求：【必填】描述协作期望
     预计工时：【可选】如200人天
     预计收益：【可选】如500万元
     ```
4. 填写完成后点击 **确定发布**
5. **系统执行**：
   - 将项目状态从 `draft` 改为 `published`
   - 保存协作信息
   - 项目出现在"申请团队"页面

**API调用**：
```javascript
// 文件：frontend/src/api/collaboration.ts
POST /api/collaborations/publish/:projectId
{
  workContent: "负责智慧园区核心模块开发",
  skillRequirements: ["skill_frontend", "skill_vue", "skill_nodejs"],
  collaborationNeeds: "需要3名前端工程师、2名后端工程师",
  estimatedWorkload: "200人天",
  estimatedRevenue: "5000000"
}

// 响应
{
  code: 200,
  message: "项目发布成功"
}
```

**注意事项**：
- ⚠️ 发布后项目基本信息不可修改（如需修改需撤回发布）
- ⚠️ 发布后项目才会在"申请团队"页面显示
- ⚠️ 必须先创建项目再发布，不能跳过创建步骤

---

## 阶段2：团队组建

### 2.1 员工申请加入项目

**操作人**：普通员工 (`test_user`)

**操作步骤**：
1. 登录系统
2. 导航至：**项目协作 → 申请团队**
3. 浏览已发布的项目列表
4. 找到感兴趣的项目（如"智慧园区系统开发"）
5. 点击 **查看详情** 查看项目信息：
   - 项目基本信息
   - 工作内容
   - 技能要求
   - 协作需求
6. 点击 **申请加入** 按钮
7. 填写申请信息：
   ```
   申请角色：【必填】选择项目角色（开发、测试、设计等）
   申请理由：【必填】说明申请原因
   预计投入：【可选】如30%工作时间
   ```
8. 点击 **提交申请**
9. **系统提示**："申请已提交，等待项目经理审批"

**API调用**：
```javascript
// 文件：frontend/src/api/collaboration.ts
POST /api/collaborations/apply
{
  projectId: "proj_abc123",
  employeeId: "test_user_id",
  role: "开发工程师",
  reason: "熟悉Vue和Node.js技术栈，可承担前端开发工作",
  commitment: "30%"
}
```

---

### 2.2 项目经理审批申请

**操作人**：项目经理 (`project_manager`)

**操作步骤**：
1. 登录系统
2. 导航至：**项目协作 → 我的项目**
3. 找到"智慧园区系统开发"项目
4. 点击 **待审批** 标签页
5. 查看申请列表，包含：
   - 申请人姓名
   - 申请角色
   - 申请理由
   - 申请时间
6. 点击申请行的 **审批** 按钮
7. 选择审批结果：
   - **通过**：填写分配的项目角色
   - **拒绝**：填写拒绝理由
8. 点击 **确定**

**通过申请后系统行为**：
- 员工加入项目团队
- 申请状态变为 `approved`
- 员工可在"我的项目"中看到该项目

**API调用**：
```javascript
// 文件：frontend/src/api/collaboration.ts
POST /api/collaborations/approve/:applicationId
{
  status: "approved",  // 或 "rejected"
  assignedRole: "前端开发工程师",
  rejectReason: ""  // 拒绝时填写
}
```

---

### 2.3 启动项目

**操作人**：项目经理 (`project_manager`)

**前置条件**：
- 项目已发布
- 至少有1名团队成员

**操作步骤**：
1. 在项目列表找到项目
2. 点击 **启动项目** 按钮
3. 确认项目信息：
   - 项目名称
   - 项目周期
   - 团队成员列表
   - 项目预算（如有）
4. 点击 **确认启动**
5. **系统执行**：
   - 项目状态从 `published` 改为 `ongoing`
   - 开始记录项目时间
   - 可以创建奖金池和成本

**API调用**：
```javascript
// 文件：frontend/src/api/project.ts
POST /api/projects/:projectId/start
```

---

## 阶段3：项目执行

### 3.1 创建项目奖金池

**操作人**：项目经理 (`project_manager`)

**前置条件**：项目状态为 `ongoing`

**操作步骤**：
1. 导航至：**项目管理 → 项目详情 → 奖金管理**
2. 点击 **创建奖金池** 按钮
3. 填写奖金池信息：
   ```
   奖金池名称：【必填】如"2025年Q1智慧园区项目奖金"
   奖金周期：【必填】选择"季度"、"半年"或"年度"
   奖金总额：【必填】如100万元
   分配规则：【必填】选择分配方式
     - 按项目贡献
     - 按工作量
     - 按绩效
     - 自定义
   备注：【可选】
   ```
4. 点击 **创建**
5. **系统提示**："奖金池创建成功"

**重要说明**：
- 奖金池可以提前创建，不影响项目执行
- 一个项目可以创建多个奖金池（不同周期）
- 奖金总额可以在项目结束前调整

**API调用**：
```javascript
// 文件：frontend/src/api/bonusPool.ts
POST /api/bonus-pools
{
  projectId: "proj_abc123",
  name: "2025年Q1智慧园区项目奖金",
  period: "quarterly",
  totalAmount: 1000000,
  distributionRule: "contribution",
  description: "备注信息"
}
```

---

### 3.2 记录项目成本

**操作人**：项目经理 (`project_manager`)

**操作步骤**：
1. 导航至：**项目管理 → 项目详情 → 成本管理**
2. 点击 **新增成本** 按钮
3. 填写成本信息：
   ```
   成本类型：【必填】选择
     - 人力成本
     - 设备成本
     - 外包成本
     - 其他成本
   成本金额：【必填】如50万元
   成本日期：【必填】发生日期
   成本说明：【必填】详细说明
   支付状态：【必填】已支付/未支付
   ```
4. 点击 **保存**
5. **系统自动计算**：
   - 累计成本
   - 预估利润 = 预计收益 - 累计成本

**API调用**：
```javascript
// 文件：frontend/src/api/projectCost.ts
POST /api/project-costs
{
  projectId: "proj_abc123",
  costType: "labor",
  amount: 500000,
  costDate: "2025-03-15",
  description: "开发团队3月份人力成本",
  paymentStatus: "paid"
}
```

**成本类型说明**：
- **人力成本**：团队成员工资、奖金
- **设备成本**：服务器、软件采购
- **外包成本**：外包服务费用
- **其他成本**：差旅、培训等

---

### 3.3 更新项目进度

**操作人**：项目经理 (`project_manager`)

**操作步骤**：
1. 在项目详情页点击 **更新进度**
2. 填写进度信息：
   ```
   当前进度：【必填】如60%
   里程碑：【可选】选择已完成的里程碑
   进度说明：【可选】进度情况描述
   风险提示：【可选】存在的风险
   ```
3. 点击 **保存**

**系统显示**：
- 进度条更新
- 项目状态面板更新
- 团队成员可见最新进度

---

## 阶段4：项目结项与奖金计算

### 4.1 完成项目

**操作人**：项目经理 (`project_manager`)

**前置条件**：
- 项目状态为 `ongoing`
- 项目进度达到100%（建议）

**操作步骤**：
1. 在项目详情页点击 **完成项目** 按钮
2. 填写结项信息：
   ```
   实际完成日期：【必填】
   项目总结：【必填】项目总结报告
   实际收益：【必填】项目实际收益金额
   项目评估：【可选】项目成功度评估
   ```
3. 确认成本信息：
   - 系统显示累计成本
   - 确认所有成本已录入
4. 点击 **确认完成**
5. **系统执行**：
   - 项目状态改为 `completed`
   - 计算项目利润
   - 触发奖金计算流程

**利润计算公式**：
```
项目利润 = 实际收益 - 累计成本
利润率 = 项目利润 / 实际收益 × 100%
```

**API调用**：
```javascript
// 文件：frontend/src/api/project.ts
POST /api/projects/:projectId/complete
{
  actualEndDate: "2025-06-30",
  summary: "项目总结报告内容...",
  actualRevenue: 5000000,
  evaluation: "excellent"
}
```

---

### 4.2 系统自动计算奖金池

**触发条件**：项目完成后自动触发

**计算流程**：
1. **获取基础数据**
   ```
   项目利润：500万 - 300万 = 200万
   奖金池总额：100万（提前设定）
   团队成员：5人
   ```

2. **计算奖金池可分配金额**
   ```
   奖金池比例：根据公司政策（如20%）
   计算奖金池：200万 × 20% = 40万
   实际可用：min(40万, 100万) = 40万
   ```

3. **验证奖金池上限**
   - 如果计算奖金 > 预设奖金池，提示调整
   - 如果计算奖金 < 预设奖金池，使用计算值

4. **分配到个人**
   - 按配置的分配规则（贡献度、工作量、绩效等）
   - 生成每个人的奖金明细

**系统显示**：
- 奖金计算详情页
- 每个成员的奖金金额
- 计算依据和公式

**API调用**：
```javascript
// 文件：backend/src/services/bonusCalculationService.js
POST /api/bonus-pools/:poolId/calculate
{
  projectId: "proj_abc123"
}

// 响应
{
  code: 200,
  data: {
    poolAmount: 400000,
    distributions: [
      {
        employeeId: "emp_001",
        employeeName: "张三",
        amount: 100000,
        contribution: 0.25,
        reason: "项目核心开发"
      },
      // ...
    ]
  }
}
```

---

### 4.3 项目经理分配奖金

**操作人**：项目经理 (`project_manager`)

**操作步骤**：
1. 导航至：**项目管理 → 项目详情 → 奖金管理**
2. 查看系统自动计算的奖金分配方案
3. **可选操作**：
   - **接受系统方案**：直接点击"确认分配"
   - **手动调整**：
     - 修改个人奖金金额
     - 调整分配比例
     - 添加奖金说明
4. 点击 **确认分配** 按钮
5. **系统执行**：
   - 锁定奖金分配方案
   - 生成奖金发放记录
   - 通知团队成员

**奖金分配原则**：
- 总额不超过奖金池上限
- 每个人的奖金 ≥ 0
- 需要填写分配理由

**API调用**：
```javascript
// 文件：frontend/src/api/bonusPool.ts
POST /api/bonus-pools/:poolId/distribute
{
  distributions: [
    {
      employeeId: "emp_001",
      amount: 100000,
      reason: "项目核心开发，贡献度25%"
    },
    // ...
  ]
}
```

---

### 4.4 员工查看奖金

**操作人**：项目成员 (如 `test_user`)

**操作步骤**：
1. 登录系统
2. 导航至：**我的奖金 → 奖金记录**
3. 查看奖金详情：
   ```
   项目名称：智慧园区系统开发
   奖金金额：10万元
   发放日期：2025-07-15
   奖金说明：项目前端开发，贡献度10%
   项目周期：2025-01-01 至 2025-06-30
   ```
4. 可导出奖金明细

---

## 完整流程时间线示例

| 时间 | 操作 | 操作人 | 项目状态 |
|------|------|--------|----------|
| 2025-01-01 | 创建项目 | 项目经理 | draft |
| 2025-01-02 | 发布项目 | 项目经理 | published |
| 2025-01-03 | 员工申请 | 李测试 | published |
| 2025-01-04 | 审批通过 | 项目经理 | published |
| 2025-01-05 | 启动项目 | 项目经理 | ongoing |
| 2025-01-10 | 创建奖金池 | 项目经理 | ongoing |
| 2025-03-15 | 记录成本 | 项目经理 | ongoing |
| 2025-06-30 | 完成项目 | 项目经理 | completed |
| 2025-07-01 | 计算奖金 | 系统自动 | completed |
| 2025-07-02 | 分配奖金 | 项目经理 | completed |
| 2025-07-15 | 奖金发放 | 财务部门 | completed |

---

## 关键API端点汇总

| 功能 | 方法 | 端点 | 文件位置 |
|------|------|------|----------|
| 创建项目 | POST | /api/projects | frontend/src/api/project.ts |
| 发布协作 | POST | /api/collaborations/publish/:projectId | frontend/src/api/collaboration.ts |
| 申请加入 | POST | /api/collaborations/apply | frontend/src/api/collaboration.ts |
| 审批申请 | POST | /api/collaborations/approve/:id | frontend/src/api/collaboration.ts |
| 启动项目 | POST | /api/projects/:projectId/start | frontend/src/api/project.ts |
| 创建奖金池 | POST | /api/bonus-pools | frontend/src/api/bonusPool.ts |
| 记录成本 | POST | /api/project-costs | frontend/src/api/projectCost.ts |
| 完成项目 | POST | /api/projects/:projectId/complete | frontend/src/api/project.ts |
| 计算奖金 | POST | /api/bonus-pools/:poolId/calculate | backend/src/services/bonusCalculationService.js |
| 分配奖金 | POST | /api/bonus-pools/:poolId/distribute | frontend/src/api/bonusPool.ts |

---

## 数据库表关系

```
projects (项目表)
  ├─ id: 项目ID
  ├─ status: draft → published → ongoing → completed
  └─ manager_id: 项目经理ID

collaborations (协作申请表)
  ├─ project_id → projects.id
  ├─ employee_id → employees.id
  └─ status: pending → approved/rejected

project_costs (项目成本表)
  ├─ project_id → projects.id
  ├─ cost_type: 成本类型
  └─ amount: 成本金额

bonus_pools (奖金池表)
  ├─ project_id → projects.id
  ├─ total_amount: 奖金总额
  └─ status: pending → calculated → distributed

bonus_distributions (奖金分配表)
  ├─ pool_id → bonus_pools.id
  ├─ employee_id → employees.id
  └─ amount: 个人奖金
```

---

## 常见问题

### Q1: 项目创建后能否修改基本信息？
A: 可以，但仅限草稿状态。发布后如需修改需先撤回发布。

### Q2: 奖金池必须在项目开始时创建吗？
A: 不必须，可以在项目任何阶段创建，但建议在启动时创建以便规划。

### Q3: 项目成本可以修改吗？
A: 可以，项目完成前均可修改。完成后需要特殊权限。

### Q4: 奖金计算依据是什么？
A: 主要依据：项目利润、奖金池设置、个人贡献度、工作量、绩效等。

### Q5: 可以手动调整奖金分配吗？
A: 可以，项目经理可以在系统计算基础上手动调整，但需填写理由。

### Q6: 奖金何时发放？
A: 由财务部门根据公司流程发放，通常在项目结项后1-2周。

---

## 注意事项

### ⚠️ 重要提示
1. **禁止跳过创建直接发布**：必须先创建项目（draft）再发布（published）
2. **奖金池上限**：计算奖金不能超过奖金池总额
3. **成本记录完整性**：项目完成前确保所有成本已录入
4. **团队审批及时性**：尽快审批员工申请，避免影响项目启动

### ✅ 最佳实践
1. 项目启动时即创建奖金池，明确激励目标
2. 定期（每月）录入项目成本，避免遗漏
3. 项目执行中及时更新进度，保持透明
4. 结项前与团队沟通奖金分配原则

---

**文档版本**：v1.0  
**最后更新**：2025-12-25  
**适用范围**：奖金模拟系统全流程
