<template>
  <div class="bonus-calculation">
    <div class="page-header">
      <div class="flex-center">
        <h2>å¥–é‡‘æ± è®¡ç®—</h2>
        <el-popover placement="right" :width="400" trigger="hover">
          <template #reference>
            <el-icon :size="24" style="margin-left: 8px">
              <QuestionFilled />
            </el-icon>
          </template>
          <!-- åŠŸèƒ½è¯´æ˜ -->
          <div class="function-intro">
            <el-alert title="ä¸‰ç»´å¥–é‡‘è®¡ç®—" type="info" :closable="false" class="info-alert">
              <template #default>
                <div class="intro-content">
                  <p>
                    å…¬å¸å¥–é‡‘æ± é‡‡ç”¨<strong>ä¸‰ç»´è¯„ä¼°æ¨¡å‹</strong>è¿›è¡Œç§‘å­¦åˆ†é…ï¼Œç»¼åˆè¯„ä»·å‘˜å·¥çš„<strong>åˆ©æ¶¦è´¡çŒ®</strong>ã€<strong>å²—ä½ä»·å€¼</strong>å’Œ<strong>ç»©æ•ˆè¡¨ç°</strong>ä¸‰ä¸ªç»´åº¦ã€‚
                  </p>

                  <div class="formula-section">
                    <h4>æ ¸å¿ƒè®¡ç®—å…¬å¼</h4>
                    <p><strong>ä¸ªäººå¥–é‡‘</strong> = å¥–é‡‘æ± æ€»é¢ Ã— (ä¸ªäººæœ€ç»ˆç³»æ•°å¾—åˆ† / å…¨å‘˜æ€»å¾—åˆ†)</p>
                    <p><strong>ä¸‰ç»´è®¡ç®—å¾—åˆ†</strong> = åˆ©æ¶¦è´¡çŒ®å¾—åˆ† Ã— æƒé‡ + å²—ä½ä»·å€¼å¾—åˆ† Ã— æƒé‡ + ç»©æ•ˆè¡¨ç°å¾—åˆ† Ã— æƒé‡</p>
                    <p><strong>æœ€ç»ˆç³»æ•°å¾—åˆ†</strong> = ä¸‰ç»´è®¡ç®—å¾—åˆ† Ã— å²—ä½åŸºå‡†å€¼ Ã— åŸå¸‚ç³»æ•° Ã— ä¸šåŠ¡çº¿ç³»æ•° Ã— ç»©æ•ˆç³»æ•° Ã— æ—¶é—´ç³»æ•°</p>
                  </div>

                  <div class="coefficients-section">
                    <h4>ä¸‰ç»´è¯„ä¼°ä½“ç³»</h4>
                    <ul>
                      <li><strong>åˆ©æ¶¦è´¡çŒ®ç»´åº¦ï¼ˆé»˜è®¤50%ï¼‰</strong>ï¼šè¯„ä¼°å‘˜å·¥å¯¹å…¬å¸åˆ©æ¶¦çš„ç›´æ¥å’Œé—´æ¥è´¡çŒ®
                        <ul style="margin-top: 4px; font-size: 13px; color: #606266;">
                          <li>ç›´æ¥è´¡çŒ®ï¼ˆ40%ï¼‰ï¼šä¸šåŠ¡æ”¶å…¥ã€è®¢å•è·å–</li>
                          <li>å·¥ä½œé‡ï¼ˆ30%ï¼‰ï¼šå®Œæˆå·¥æ—¶ã€ä»»åŠ¡æ•°é‡</li>
                          <li>è´¨é‡è´¡çŒ®ï¼ˆ20%ï¼‰ï¼šé”™è¯¯ç‡ã€å®¢æˆ·æ»¡æ„åº¦</li>
                          <li>å²—ä½ä»·å€¼ï¼ˆ10%ï¼‰ï¼šä¸å¯æ›¿ä»£æ€§ã€æŠ€èƒ½ç¨€ç¼ºæ€§</li>
                        </ul>
                      </li>
                      <li><strong>å²—ä½ä»·å€¼ç»´åº¦ï¼ˆé»˜è®¤30%ï¼‰</strong>ï¼šè¡¡é‡å²—ä½æœ¬èº«çš„é‡è¦æ€§å’Œå¤æ‚åº¦
                        <ul style="margin-top: 4px; font-size: 13px; color: #606266;">
                          <li>æŠ€èƒ½å¤æ‚åº¦ï¼ˆ25%ï¼‰ï¼šæŠ€æœ¯éš¾åº¦ã€ä¸“ä¸šè¦æ±‚</li>
                          <li>è´£ä»»æƒé‡ï¼ˆ30%ï¼‰ï¼šå†³ç­–æƒé™ã€é£é™©æ‰¿æ‹…</li>
                          <li>å†³ç­–å½±å“ï¼ˆ20%ï¼‰ï¼šå¯¹ç»„ç»‡çš„å½±å“èŒƒå›´</li>
                          <li>ç»éªŒè¦æ±‚ï¼ˆ15%ï¼‰ï¼šå·¥ä½œç»éªŒé—¨æ§›</li>
                          <li>å¸‚åœºä»·å€¼ï¼ˆ10%ï¼‰ï¼šäººæ‰ç¨€ç¼ºç¨‹åº¦</li>
                        </ul>
                      </li>
                      <li><strong>ç»©æ•ˆè¡¨ç°ç»´åº¦ï¼ˆé»˜è®¤20%ï¼‰</strong>ï¼šè¯„ä»·å‘˜å·¥çš„å®é™…å·¥ä½œè¡¨ç°
                        <ul style="margin-top: 4px; font-size: 13px; color: #606266;">
                          <li>å·¥ä½œäº§å‡ºï¼ˆ35%ï¼‰ï¼šå®Œæˆé‡ã€è¾¾æˆç‡</li>
                          <li>å·¥ä½œè´¨é‡ï¼ˆ30%ï¼‰ï¼šæˆæœè´¨é‡ã€å®¢æˆ·åé¦ˆ</li>
                          <li>å·¥ä½œæ•ˆç‡ï¼ˆ15%ï¼‰ï¼šæ—¶é—´ç®¡ç†ã€èµ„æºåˆ©ç”¨</li>
                          <li>å›¢é˜Ÿåä½œï¼ˆ10%ï¼‰ï¼šè·¨éƒ¨é—¨åˆä½œã€çŸ¥è¯†åˆ†äº«</li>
                          <li>åˆ›æ–°èƒ½åŠ›ï¼ˆ5%ï¼‰ï¼šä¼˜åŒ–å»ºè®®ã€æŠ€æœ¯åˆ›æ–°</li>
                          <li>é¢†å¯¼èƒ½åŠ›ï¼ˆ3%ï¼‰ï¼šé¡¹ç›®é¢†å¯¼ã€å›¢é˜ŸæŒ‡å¯¼</li>
                          <li>å­¦ä¹ æˆé•¿ï¼ˆ2%ï¼‰ï¼šæŠ€èƒ½æå‡ã€åŸ¹è®­å‚ä¸</li>
                        </ul>
                      </li>
                    </ul>
                  </div>

                  <div class="navigation-section">
                    <h4>é…ç½®ç®¡ç†</h4>
                    <ul>
                      <li><strong>æƒé‡é…ç½®</strong>ï¼šç³»ç»Ÿç®¡ç† â†’ ä¸‰ç»´æƒé‡é…ç½®ï¼ˆå¯è‡ªå®šä¹‰å„ç»´åº¦æƒé‡ï¼‰</li>
                      <li><strong>æ ‡å‡†åŒ–æ–¹æ³•</strong>ï¼šæ”¯æŒZ-Scoreæ ‡å‡†åŒ–ã€ç™¾åˆ†ä½æ’åã€Min-Maxå½’ä¸€åŒ–</li>
                      <li><strong>è®¡ç®—æ–¹æ³•</strong>ï¼šåŠ æƒæ±‚å’Œï¼ˆé»˜è®¤ï¼‰ã€åŠ æƒä¹˜ç§¯ã€æ··åˆæ–¹æ³•</li>
                      <li><strong>è°ƒæ•´ç³»æ•°</strong>ï¼šå“è¶Šå¥–åŠ±ã€ç»©æ•ˆå€æ•°ã€å²—ä½çº§åˆ«å€æ•°</li>
                    </ul>
                  </div>
                </div>
              </template>
            </el-alert>
          </div>
        </el-popover>
      </div>

      <div class="header-actions">
        <el-button type="primary" @click="showCreatePoolDialog" :disabled="calculating">
          <el-icon>
            <Plus />
          </el-icon>
          åˆ›å»ºå¥–é‡‘æ± 
        </el-button>
        <el-button @click="refreshData" :loading="loading">
          <el-icon>
            <Refresh />
          </el-icon>
          åˆ·æ–°
        </el-button>
      </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-cards">
      <el-card class="stat-card" shadow="hover">
        <div class="stat-content">
          <div class="stat-title">å¥–é‡‘æ± æ€»æ•°</div>
          <div class="stat-number">{{ statistics.totalPools }}</div>
          <div class="stat-subtitle">å·²åˆ›å»º</div>
        </div>
      </el-card>
      <el-card class="stat-card" shadow="hover">
        <div class="stat-content">
          <div class="stat-title">æ€»é‡‘é¢</div>
          <div class="stat-number">Â¥{{ formatNumber(statistics.totalAmount) }}</div>
          <div class="stat-subtitle">ç´¯è®¡å¥–é‡‘æ± </div>
        </div>
      </el-card>
      <el-card class="stat-card" shadow="hover">
        <div class="stat-content">
          <div class="stat-title">å·²åˆ†é…</div>
          <div class="stat-number">{{ statistics.allocatedPools }}</div>
          <div class="stat-subtitle">å®Œæˆè®¡ç®—</div>
        </div>
      </el-card>
      <el-card class="stat-card" shadow="hover">
        <div class="stat-content">
          <div class="stat-title">å—ç›Šäººæ•°</div>
          <div class="stat-number">{{ statistics.totalEmployees }}</div>
          <div class="stat-subtitle">å‚ä¸å‘˜å·¥</div>
        </div>
      </el-card>
    </div>

    <!-- å¥–é‡‘æ± åˆ—è¡¨ -->
    <el-card class="table-card">
      <template #header>
        <div class="card-header">
          <span>å¥–é‡‘æ± åˆ—è¡¨</span>
          <div class="header-controls">
            <el-select v-model="queryForm.status" placeholder="ç­›é€‰çŠ¶æ€" clearable style="width: 120px"
              @change="handleSearch">
              <el-option label="è‰ç¨¿" value="draft" />
              <el-option label="å·²è®¡ç®—" value="calculated" />
              <el-option label="å·²åˆ†é…" value="allocated" />
              <el-option label="å·²å‘æ”¾" value="paid" />
            </el-select>
          </div>
        </div>
      </template>

      <el-table :data="bonusPools" v-loading="loading" stripe @selection-change="handleSelectionChange">
        <el-table-column type="selection" width="50" />
        <el-table-column prop="period" label="è®¡ç®—å‘¨æœŸ" width="120" />
        <el-table-column label="å…¬å¸åˆ©æ¶¦" width="140">
          <template #default="{ row }">
            Â¥{{ formatNumber(row.totalProfit) }}
          </template>
        </el-table-column>
        <el-table-column label="å¥–é‡‘æ± æ¯”ä¾‹" width="100">
          <template #default="{ row }">
            {{ (row.poolRatio * 100).toFixed(1) }}%
          </template>
        </el-table-column>
        <el-table-column label="å¥–é‡‘æ± é‡‘é¢" width="140">
          <template #default="{ row }">
            Â¥{{ formatNumber(row.poolAmount) }}
          </template>
        </el-table-column>
        <el-table-column label="å¯åˆ†é…é‡‘é¢" width="140">
          <template #default="{ row }">
            Â¥{{ formatNumber(row.distributableAmount) }}
          </template>
        </el-table-column>
        <el-table-column label="çŠ¶æ€" width="100">
          <template #default="{ row }">
            <el-tag :type="getStatusType(row.status)">
              {{ getStatusText(row.status) }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="createdAt" label="åˆ›å»ºæ—¶é—´" width="180">
          <template #default="{ row }">
            {{ formatDate(row.createdAt) }}
          </template>
        </el-table-column>
        <el-table-column label="æ“ä½œ" width="380" fixed="right">
          <template #default="{ row }">
            <el-button type="primary" size="small" @click="showCalculateDialog(row)"
              :disabled="calculating || row.status === 'allocated' || row.status === 'paid'">
              {{ row.status === 'draft' ? 'è®¡ç®—' : 'é‡æ–°è®¡ç®—' }}
            </el-button>
            <el-button size="small" @click="showResultDialog(row)" :disabled="row.status === 'draft'">
              æŸ¥çœ‹ç»“æœ
            </el-button>
            <el-button 
              v-if="row.status === 'calculated' || row.status === 'allocated'" 
              type="success" 
              size="small" 
              @click="handlePayment(row)"
            >
              å‘æ”¾å¥–é‡‘
            </el-button>
            <el-dropdown @command="(cmd: string) => handleMoreAction(cmd, row)">
              <el-button size="small">
                æ›´å¤š<el-icon class="el-icon--right"><arrow-down /></el-icon>
              </el-button>
              <template #dropdown>
                <el-dropdown-menu>
                  <el-dropdown-item command="edit" :disabled="row.status === 'allocated' || row.status === 'paid'">
                    ç¼–è¾‘
                  </el-dropdown-item>
                  <el-dropdown-item command="copy">å¤åˆ¶</el-dropdown-item>
                  <el-dropdown-item command="export" :disabled="row.status === 'draft'">
                    å¯¼å‡ºç»“æœ
                  </el-dropdown-item>
                  <el-dropdown-item command="delete" divided :disabled="row.status === 'paid'">åˆ é™¤</el-dropdown-item>
                </el-dropdown-menu>
              </template>
            </el-dropdown>
          </template>
        </el-table-column>
      </el-table>

      <!-- åˆ†é¡µ -->
      <div class="pagination">
        <el-pagination v-model:current-page="pagination.page" v-model:page-size="pagination.pageSize"
          :total="pagination.total" :page-sizes="[10, 20, 50, 100]" layout="total, sizes, prev, pager, next, jumper"
          @size-change="handleSizeChange" @current-change="handleCurrentChange" />
      </div>
    </el-card>

    <!-- åˆ›å»ºå¥–é‡‘æ± å¯¹è¯æ¡† -->
    <el-dialog v-model="createPoolVisible" title="åˆ›å»ºå¥–é‡‘æ± " width="600px" :close-on-click-modal="false">
      <el-form ref="poolFormRef" :model="poolForm" :rules="poolFormRules" label-width="120px">

        <!-- å…¬å¸è´¢åŠ¡ä¿¡æ¯å±•ç¤º -->
        <el-alert v-if="companyFinancialData.totalBudget > 0 || companyFinancialData.totalProfit !== 0" type="info"
          :closable="false" style="margin-bottom: 20px">
          <template #title>
            <div style="font-weight: bold; margin-bottom: 10px">å…¬å¸è´¢åŠ¡æ¦‚è§ˆ</div>
          </template>
          <div style="font-size: 13px">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px">
              <span><strong>é¡¹ç›®æ€»é¢„ç®—ï¼š</strong>{{ formatNumber(companyFinancialData.totalBudget) }} å…ƒ</span>
              <span><strong>æ€»æˆæœ¬ï¼š</strong><span style="color: #f56c6c">{{ formatNumber(companyFinancialData.totalCost) }}
                  å…ƒ</span></span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px">
              <span><strong>é¢„æœŸåˆ©æ¶¦ï¼š</strong>
                <span
                  :style="{ color: companyFinancialData.totalProfit >= 0 ? '#67c23a' : '#f56c6c', fontWeight: 'bold' }">
                  {{ formatNumber(companyFinancialData.totalProfit) }} å…ƒ
                </span>
              </span>
              <span><strong>é¢„ä¼°å¥–é‡‘ï¼š</strong>{{ formatNumber(companyFinancialData.estimatedBonus) }} å…ƒ</span>
            </div>
            <div
              style="display: flex; justify-content: space-between; margin-bottom: 8px; padding-top: 8px; border-top: 1px dashed #dcdfe6">
              <span><strong>å·²åˆ†é…é¡¹ç›®å¥–é‡‘ï¼š</strong>
                <span style="color: #e6a23c">
                  {{ formatNumber((companyFinancialData as any).allocatedProjectBonus || 0) }} å…ƒ
                </span>
              </span>
              <span><strong>å·²åˆ†é…å…¬å¸å¥–é‡‘ï¼š</strong>
                <span style="color: #e6a23c">
                  {{ formatNumber((companyFinancialData as any).allocatedCompanyBonus || 0) }} å…ƒ
                </span>
              </span>
            </div>
            <div style="background: #f5f7fa; padding: 8px; border-radius: 4px; margin-top: 8px">
              <strong>å¯ç”¨åˆ©æ¶¦ï¼ˆæ‰£é™¤å†å²å¥–é‡‘ï¼‰ï¼š</strong>
              <span :style="{
                color: ((companyFinancialData as any).finalAvailableProfit || 0) >= 0 ? '#67c23a' : '#f56c6c',
                fontWeight: 'bold',
                fontSize: '16px'
              }">
                {{ formatNumber((companyFinancialData as any).finalAvailableProfit || 0) }} å…ƒ
              </span>
            </div>
            <el-divider style="margin: 8px 0" />
            <div style="color: #909399; font-size: 12px">
              <span v-if="(companyFinancialData as any).finalAvailableProfit > 0">
                âœ“ å»ºè®®å¥–é‡‘æ± é‡‘é¢ä¸è¶…è¿‡å¯ç”¨åˆ©æ¶¦ Â¥{{ formatNumber((companyFinancialData as any).finalAvailableProfit || 0) }}
              </span>
              <span v-else style="color: #f56c6c">
                âš  å…¬å¸å¯ç”¨åˆ©æ¶¦ä¸è¶³ Â¥{{ formatNumber(Math.abs((companyFinancialData as any).finalAvailableProfit || 0))
                }}ï¼Œè¯·è°¨æ…è®¾ç½®å¥–é‡‘æ± 
              </span>
            </div>
          </div>
        </el-alert>

        <el-form-item label="è®¡ç®—å‘¨æœŸ" prop="period">
          <el-select v-model="poolForm.period" placeholder="è¯·é€‰æ‹©è®¡ç®—å‘¨æœŸ" style="width: 100%">
            <el-option
              v-for="option in periodOptions"
              :key="option.value"
              :label="option.label"
              :value="option.value"
            />
          </el-select>
        </el-form-item>
        <el-form-item label="å…¬å¸æ€»åˆ©æ¶¦" prop="totalProfit">
          <el-input-number v-model="poolForm.totalProfit" :min="0" :precision="2" style="width: 100%"
            controls-position="right" />
        </el-form-item>
        <el-form-item label="å¥–é‡‘æ± æ¯”ä¾‹" prop="poolRatio">
          <el-slider v-model="poolForm.poolRatio" :min="0.05" :max="0.3" :step="0.01"
            :format-tooltip="(val: number) => `${(val * 100).toFixed(1)}%`" style="width: 80%; margin-right: 20px" />
          <span>{{ (poolForm.poolRatio * 100).toFixed(1) }}%</span>
        </el-form-item>
        <el-form-item label="é¢„ç•™è°ƒèŠ‚é‡‘" prop="reserveRatio">
          <el-slider v-model="poolForm.reserveRatio" :min="0" :max="0.1" :step="0.005"
            :format-tooltip="(val: number) => `${(val * 100).toFixed(2)}%`" style="width: 80%; margin-right: 20px" />
          <span>{{ (poolForm.reserveRatio * 100).toFixed(2) }}%</span>
        </el-form-item>
        <el-form-item label="CEOç‰¹åˆ«å¥–åŠ±" prop="specialRatio">
          <el-slider v-model="poolForm.specialRatio" :min="0" :max="0.1" :step="0.005"
            :format-tooltip="(val: number) => `${(val * 100).toFixed(2)}%`" style="width: 80%; margin-right: 20px" />
          <span>{{ (poolForm.specialRatio * 100).toFixed(2) }}%</span>
        </el-form-item>

        <!-- è®¡ç®—é¢„è§ˆ -->
        <el-divider content-position="left">è®¡ç®—é¢„è§ˆ</el-divider>
        <div class="calculation-preview">
          <div class="preview-item">
            <span>å¥–é‡‘æ± æ€»é¢ï¼š</span>
            <strong>Â¥{{ formatNumber(poolForm.totalProfit * poolForm.poolRatio) }}</strong>
          </div>
          <div class="preview-item">
            <span>é¢„ç•™è°ƒèŠ‚é‡‘ï¼š</span>
            <span>Â¥{{ formatNumber(poolForm.totalProfit * poolForm.poolRatio * poolForm.reserveRatio) }}</span>
          </div>
          <div class="preview-item">
            <span>CEOç‰¹åˆ«å¥–åŠ±ï¼š</span>
            <span>Â¥{{ formatNumber(poolForm.totalProfit * poolForm.poolRatio * poolForm.specialRatio) }}</span>
          </div>
          <div class="preview-item highlight">
            <span>å¯åˆ†é…é‡‘é¢ï¼š</span>
            <strong>Â¥{{ formatNumber(poolForm.totalProfit * poolForm.poolRatio * (1 - poolForm.reserveRatio -
              poolForm.specialRatio)) }}</strong>
          </div>
        </div>
      </el-form>

      <template #footer>
        <div class="dialog-footer">
          <el-button @click="createPoolVisible = false">å–æ¶ˆ</el-button>
          <el-button type="primary" @click="handleCreatePool" :loading="submitting">
            åˆ›å»º
          </el-button>
        </div>
      </template>
    </el-dialog>

    <!-- ç¼–è¾‘å¥–é‡‘æ± å¯¹è¯æ¡† -->
    <el-dialog v-model="editPoolVisible" title="ç¼–è¾‘å¥–é‡‘æ± " width="600px" :close-on-click-modal="false">
      <el-form ref="editFormRef" :model="editForm" :rules="editFormRules" label-width="120px">
        <el-form-item label="è®¡ç®—å‘¨æœŸ" prop="period">
          <el-select v-model="editForm.period" placeholder="è¯·é€‰æ‹©è®¡ç®—å‘¨æœŸ" style="width: 100%">
            <el-option
              v-for="option in periodOptions"
              :key="option.value"
              :label="option.label"
              :value="option.value"
            />
          </el-select>
        </el-form-item>
        <el-form-item label="å…¬å¸æ€»åˆ©æ¶¦" prop="totalProfit">
          <el-input-number v-model="editForm.totalProfit" :min="0" :precision="2" style="width: 100%"
            controls-position="right" />
        </el-form-item>
        <el-form-item label="å¥–é‡‘æ± æ¯”ä¾‹" prop="poolRatio">
          <el-slider v-model="editForm.poolRatio" :min="0.05" :max="0.3" :step="0.01"
            :format-tooltip="(val: number) => `${(val * 100).toFixed(1)}%`" style="width: 80%; margin-right: 20px" />
          <span>{{ (editForm.poolRatio * 100).toFixed(1) }}%</span>
        </el-form-item>
        <el-form-item label="é¢„ç•™è°ƒèŠ‚é‡‘" prop="reserveRatio">
          <el-slider v-model="editForm.reserveRatio" :min="0" :max="0.1" :step="0.005"
            :format-tooltip="(val: number) => `${(val * 100).toFixed(2)}%`" style="width: 80%; margin-right: 20px" />
          <span>{{ (editForm.reserveRatio * 100).toFixed(2) }}%</span>
        </el-form-item>
        <el-form-item label="CEOç‰¹åˆ«å¥–åŠ±" prop="specialRatio">
          <el-slider v-model="editForm.specialRatio" :min="0" :max="0.1" :step="0.005"
            :format-tooltip="(val: number) => `${(val * 100).toFixed(2)}%`" style="width: 80%; margin-right: 20px" />
          <span>{{ (editForm.specialRatio * 100).toFixed(2) }}%</span>
        </el-form-item>

        <!-- è®¡ç®—é¢„è§ˆ -->
        <el-divider content-position="left">è®¡ç®—é¢„è§ˆ</el-divider>
        <div class="calculation-preview">
          <div class="preview-item">
            <span>å¥–é‡‘æ± æ€»é¢ï¼š</span>
            <strong>Â¥{{ formatNumber(editForm.totalProfit * editForm.poolRatio) }}</strong>
          </div>
          <div class="preview-item">
            <span>é¢„ç•™è°ƒèŠ‚é‡‘ï¼š</span>
            <span>Â¥{{ formatNumber(editForm.totalProfit * editForm.poolRatio * editForm.reserveRatio) }}</span>
          </div>
          <div class="preview-item">
            <span>CEOç‰¹åˆ«å¥–åŠ±ï¼š</span>
            <span>Â¥{{ formatNumber(editForm.totalProfit * editForm.poolRatio * editForm.specialRatio) }}</span>
          </div>
          <div class="preview-item highlight">
            <span>å¯åˆ†é…é‡‘é¢ï¼š</span>
            <strong>Â¥{{ formatNumber(editForm.totalProfit * editForm.poolRatio * (1 - editForm.reserveRatio -
              editForm.specialRatio)) }}</strong>
          </div>
        </div>
      </el-form>

      <template #footer>
        <div class="dialog-footer">
          <el-button @click="editPoolVisible = false">å–æ¶ˆ</el-button>
          <el-button type="primary" @click="handleEditPool" :loading="submitting">
            æ›´æ–°
          </el-button>
        </div>
      </template>
    </el-dialog>

    <!-- è®¡ç®—å‚æ•°å¯¹è¯æ¡† -->
    <el-dialog v-model="calculateVisible" title="å¥–é‡‘è®¡ç®—å‚æ•°" width="800px" :close-on-click-modal="false">
      <div v-if="currentPool">
        <div class="pool-info">
          <h4>å¥–é‡‘æ± ä¿¡æ¯</h4>
          <el-descriptions :column="2" border>
            <el-descriptions-item label="è®¡ç®—å‘¨æœŸ">{{ currentPool.period }}</el-descriptions-item>
            <el-descriptions-item label="å¯åˆ†é…é‡‘é¢">Â¥{{ formatNumber(currentPool.distributableAmount)
            }}</el-descriptions-item>
          </el-descriptions>
        </div>

        <el-divider />

        <el-form ref="calculateFormRef" :model="calculateForm" label-width="120px">
          <h4>è®¡ç®—æ–¹å¼</h4>
          <el-form-item label="è®¡ç®—æ¨¡å¼">
            <el-radio-group v-model="calculateForm.mode">
              <el-radio label="full">å…¨å‘˜è®¡ç®—</el-radio>
              <el-radio label="department">æŒ‰éƒ¨é—¨è®¡ç®—</el-radio>
              <el-radio label="line">æŒ‰ä¸šåŠ¡çº¿è®¡ç®—</el-radio>
            </el-radio-group>
          </el-form-item>

          <el-form-item v-if="calculateForm.mode === 'department'" label="é€‰æ‹©éƒ¨é—¨">
            <el-select v-model="calculateForm.departments" multiple placeholder="è¯·é€‰æ‹©éƒ¨é—¨" style="width: 100%">
              <el-option v-for="dept in departments" :key="dept.id" :label="dept.name" :value="dept.id" />
            </el-select>
          </el-form-item>

          <el-form-item v-if="calculateForm.mode === 'line'" label="é€‰æ‹©ä¸šåŠ¡çº¿">
            <el-select v-model="calculateForm.businessLines" multiple placeholder="è¯·é€‰æ‹©ä¸šåŠ¡çº¿" style="width: 100%">
              <el-option v-for="line in businessLines" :key="line.id" :label="line.name" :value="line.id" />
            </el-select>
          </el-form-item>

          <h4>é«˜çº§é€‰é¡¹</h4>
          <el-form-item label="æœ€ä½åˆ†æ•°é˜ˆå€¼">
            <el-input-number v-model="calculateForm.minScoreThreshold" :min="0" :max="1" :step="0.1" :precision="2" />
          </el-form-item>

          <el-form-item label="æ˜¯å¦æ¨¡æ‹Ÿ">
            <el-switch v-model="calculateForm.simulation" />
            <span class="form-item-help">æ¨¡æ‹Ÿæ¨¡å¼ä¸‹ä¸ä¼šä¿å­˜ç»“æœ</span>
          </el-form-item>
        </el-form>
      </div>

      <template #footer>
        <div class="dialog-footer">
          <el-button @click="calculateVisible = false">å–æ¶ˆ</el-button>
          <el-button type="primary" @click="handleCalculate" :loading="calculating">
            {{ calculateForm.simulation ? 'å¼€å§‹æ¨¡æ‹Ÿ' : 'å¼€å§‹è®¡ç®—' }}
          </el-button>
        </div>
      </template>
    </el-dialog>

    <!-- è®¡ç®—è¿›åº¦å¯¹è¯æ¡† -->
    <el-dialog v-model="progressVisible" title="è®¡ç®—è¿›åº¦" width="500px" :close-on-click-modal="false" :show-close="false">
      <div class="progress-content">
        <el-progress :percentage="progress.percentage" :status="progress.status" stroke-width="8" />
        <p class="progress-text">{{ progress.text }}</p>
        <div class="progress-details" v-if="progress.details">
          <p v-for="detail in progress.details" :key="detail">{{ detail }}</p>
        </div>
      </div>

      <template #footer>
        <div class="dialog-footer">
          <el-button @click="progressVisible = false" type="primary">{{ progress.status === 'success' ? 'å…³é—­' : 'åå°è¿è¡Œ' }}</el-button>
        </div>
      </template>
    </el-dialog>

    <!-- è®¡ç®—ç»“æœå¯¹è¯æ¡† -->
    <el-dialog v-model="resultVisible" title="è®¡ç®—ç»“æœ" width="1200px" :close-on-click-modal="false">
      <div v-if="calculationResult">
        <!-- ç»“æœæ±‡æ€» -->
        <div class="result-summary">
          <el-row :gutter="20">
            <el-col :span="6">
              <div class="summary-item">
                <div class="summary-number">{{ calculationResult.summary.totalEmployees }}</div>
                <div class="summary-label">å‚ä¸å‘˜å·¥</div>
              </div>
            </el-col>
            <el-col :span="6">
              <div class="summary-item">
                <div class="summary-number">Â¥{{ formatNumber(calculationResult.summary.totalBonus) }}</div>
                <div class="summary-label">æ€»å¥–é‡‘</div>
              </div>
            </el-col>
            <el-col :span="6">
              <div class="summary-item">
                <div class="summary-number">Â¥{{ formatNumber(calculationResult.summary.averageBonus) }}</div>
                <div class="summary-label">å¹³å‡å¥–é‡‘</div>
              </div>
            </el-col>
            <el-col :span="6">
              <div class="summary-item">
                <div class="summary-number">{{ ((calculationResult.summary.totalBonus /
                  currentPool?.distributableAmount) *
                  100).toFixed(1) }}%</div>
                <div class="summary-label">åˆ†é…æ¯”ä¾‹</div>
              </div>
            </el-col>
          </el-row>
        </div>

        <!-- è§†å›¾åˆ‡æ¢æŒ‰é’® -->
        <div class="view-switcher">
          <el-radio-group v-model="resultViewMode" size="small">
            <el-radio-button value="line">ä¸šåŠ¡çº¿åˆ†å¸ƒ</el-radio-button>
            <el-radio-button value="department">éƒ¨é—¨åˆ†å¸ƒ</el-radio-button>
            <el-radio-button value="employee">å‘˜å·¥æ˜ç»†</el-radio-button>
          </el-radio-group>
        </div>

        <!-- ä¸šåŠ¡çº¿åˆ†å¸ƒè§†å›¾ -->
        <div v-if="resultViewMode === 'line'">
          <el-table :data="calculationResult.lineStats" stripe>
            <el-table-column prop="lineName" label="ä¸šåŠ¡çº¿" />
            <el-table-column prop="employees" label="å‘˜å·¥æ•°é‡" />
            <el-table-column label="æ€»å¥–é‡‘">
              <template #default="{ row }">
                Â¥{{ formatNumber(row.totalBonus) }}
              </template>
            </el-table-column>
            <el-table-column label="å¹³å‡å¥–é‡‘">
              <template #default="{ row }">
                Â¥{{ formatNumber(row.averageBonus) }}
              </template>
            </el-table-column>
            <el-table-column label="å æ¯”">
              <template #default="{ row }">
                {{ ((row.totalBonus / calculationResult.summary.totalBonus) * 100).toFixed(1) }}%
              </template>
            </el-table-column>
          </el-table>
        </div>

        <!-- éƒ¨é—¨åˆ†å¸ƒè§†å›¾ -->
        <div v-if="resultViewMode === 'department'">
          <el-table :data="calculationResult.lineStats" stripe>
            <el-table-column prop="lineName" label="éƒ¨é—¨" />
            <el-table-column prop="employees" label="å‘˜å·¥æ•°é‡" />
            <el-table-column label="æ€»å¥–é‡‘">
              <template #default="{ row }">
                Â¥{{ formatNumber(row.totalBonus) }}
              </template>
            </el-table-column>
            <el-table-column label="å¹³å‡å¥–é‡‘">
              <template #default="{ row }">
                Â¥{{ formatNumber(row.averageBonus) }}
              </template>
            </el-table-column>
            <el-table-column label="å æ¯”">
              <template #default="{ row }">
                {{ ((row.totalBonus / calculationResult.summary.totalBonus) * 100).toFixed(1) }}%
              </template>
            </el-table-column>
          </el-table>
        </div>

        <!-- å‘˜å·¥æ˜ç»†è§†å›¾ -->
        <div v-if="resultViewMode === 'employee'">
          <el-divider content-position="left">å‘˜å·¥å¥–é‡‘æ˜ç»†</el-divider>
          <el-table :data="employeeDetailsList" stripe v-loading="loadingEmployeeDetails" max-height="500">
            <el-table-column prop="employeeNo" label="å·¥å·" width="100" />
            <el-table-column prop="employeeName" label="å§“å" width="100" />
            <el-table-column prop="departmentName" label="éƒ¨é—¨" width="100" />
            <el-table-column prop="positionName" label="å²—ä½" width="120" />
            <el-table-column label="åˆ©æ¶¦è´¡çŒ®" width="100" align="right">
              <template #default="{ row }">
                {{ row.profitContributionScore?.toFixed(2) || '0.00' }}
              </template>
            </el-table-column>
            <el-table-column label="å²—ä½ä»·å€¼" width="100" align="right">
              <template #default="{ row }">
                {{ row.positionValueScore?.toFixed(2) || '0.00' }}
              </template>
            </el-table-column>
            <el-table-column label="ç»©æ•ˆè¯„åˆ†" width="100" align="right">
              <template #default="{ row }">
                {{ row.performanceScore?.toFixed(2) || '0.00' }}
              </template>
            </el-table-column>
            <el-table-column label="ä¸‰ç»´è®¡ç®—å¾—åˆ†" width="110" align="right">
              <template #default="{ row }">
                {{row.totalScore?.toFixed(2) || '0.00' }}
              </template>
            </el-table-column>
            <el-table-column label="æœ€ç»ˆç³»æ•°å¾—åˆ†" width="120" align="right">
              <template #default="{ row }">
                <span style="color: #409eff; font-weight: bold;">
                  {{ row.finalScore?.toFixed(2) || '0.00' }}
                </span>
              </template>
            </el-table-column>
            
            <!-- â­ æ–°å¢ï¼šç³»æ•°åˆ—ï¼ˆå¯æŠ˜å ï¼‰ -->
            <el-table-column label="è®¡ç®—ç³»æ•°" align="center" width="500">
              <el-table-column label="å²—ä½åŸºå‡†" width="90" align="right">
                <template #default="{ row }">
                  <el-tag size="small" effect="plain" type="info">
                    {{ row.positionBenchmark?.toFixed(2) || '1.00' }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column label="åŸå¸‚ç³»æ•°" width="85" align="right">
                <template #default="{ row }">
                  <el-tag size="small" effect="plain" :type="row.cityCoefficient > 1 ? 'success' : 'info'">
                    {{ row.cityCoefficient?.toFixed(2) || '1.00' }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column label="ä¸šåŠ¡çº¿" width="85" align="right">
                <template #default="{ row }">
                  <el-tag size="small" effect="plain" :type="row.businessLineCoefficient > 1 ? 'success' : 'info'">
                    {{ row.businessLineCoefficient?.toFixed(2) || '1.00' }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column label="ç»©æ•ˆç³»æ•°" width="85" align="right">
                <template #default="{ row }">
                  <el-tag size="small" effect="plain" :type="row.performanceCoefficient >= 1 ? 'success' : 'warning'">
                    {{ row.performanceCoefficient?.toFixed(2) || '1.00' }}
                  </el-tag>
                </template>
              </el-table-column>
              <!-- âœ… æ—¶é—´ç³»æ•°å·²ç§»é™¤ï¼Œä¸å†å±•ç¤º -->
            </el-table-column>
            
            <el-table-column label="æœ€ç»ˆå¥–é‡‘" width="120" align="right">
              <template #default="{ row }">
                <span style="color: #f56c6c; font-weight: bold;">
                  Â¥{{ formatNumber(row.finalBonusAmount || 0) }}
                </span>
              </template>
            </el-table-column>
            
            <!-- â­ æ–°å¢ï¼šæ“ä½œåˆ—ï¼ˆæŸ¥çœ‹è®¡ç®—è¿‡ç¨‹ï¼‰ -->
            <el-table-column label="æ“ä½œ" width="100" align="center" fixed="right">
              <template #default="{ row }">
                <el-button 
                  size="small" 
                  type="primary" 
                  link
                  @click="showCalculationDetail(row)"
                >
                  è®¡ç®—è¿‡ç¨‹
                </el-button>
              </template>
            </el-table-column>
          </el-table>
        </div>
      </div>

      <template #footer>
        <div class="dialog-footer">
          <el-button @click="resultVisible = false">å…³é—­</el-button>
          <el-button type="primary" @click="exportResult" :loading="exporting">
            å¯¼å‡ºç»“æœ
          </el-button>
        </div>
      </template>
    </el-dialog>
    
    <!-- â­ æ–°å¢ï¼šè®¡ç®—è¿‡ç¨‹è¯¦æƒ…å¯¹è¯æ¡† -->
    <el-dialog
      v-model="calculationDetailVisible"
      title="å¥–é‡‘è®¡ç®—è¿‡ç¨‹è¯¦æƒ…"
      width="900px"
      :close-on-click-modal="false"
    >
      <div class="calculation-detail-container" v-if="currentCalculationDetail.employeeName">
        <!-- å‘˜å·¥åŸºæœ¬ä¿¡æ¯ -->
        <el-card class="info-card" shadow="never">
          <template #header>
            <div class="card-header">
              <span>ğŸ‘¤ å‘˜å·¥ä¿¡æ¯</span>
            </div>
          </template>
          <el-descriptions :column="3" border>
            <el-descriptions-item label="å§“å">{{ currentCalculationDetail.employeeName }}</el-descriptions-item>
            <el-descriptions-item label="å·¥å·">{{ currentCalculationDetail.employeeNo }}</el-descriptions-item>
            <el-descriptions-item label="éƒ¨é—¨">{{ currentCalculationDetail.departmentName }}</el-descriptions-item>
            <el-descriptions-item label="å²—ä½">{{ currentCalculationDetail.positionName }}</el-descriptions-item>
            <el-descriptions-item label="ä¸šåŠ¡çº¿">{{ currentCalculationDetail.businessLineName }}</el-descriptions-item>
            <el-descriptions-item label="æœ€ç»ˆå¥–é‡‘">
              <span style="color: #f56c6c; font-weight: bold; font-size: 16px;">
                Â¥{{ formatNumber(currentCalculationDetail.finalBonusAmount || 0) }}
              </span>
            </el-descriptions-item>
          </el-descriptions>
        </el-card>

        <!-- è®¡ç®—å…¬å¼å±•ç¤º -->
        <el-card class="formula-card" shadow="never">
          <template #header>
            <div class="card-header">
              <span>ğŸ§® è®¡ç®—å…¬å¼</span>
            </div>
          </template>
          <div class="formula-content">
            <div class="formula-line main-formula">
              <strong>æœ€ç»ˆç³»æ•°å¾—åˆ†</strong> = 
              <span class="formula-part">ä¸‰ç»´è®¡ç®—å¾—åˆ†</span> Ã— 
              <span class="formula-part">å²—ä½åŸºå‡†å€¼</span> Ã— 
              <span class="formula-part">åŸå¸‚ç³»æ•°</span> Ã— 
              <span class="formula-part">ä¸šåŠ¡çº¿ç³»æ•°</span> Ã— 
              <span class="formula-part">ç»©æ•ˆç³»æ•°</span> Ã— 
              <span class="formula-part">æ—¶é—´ç³»æ•°</span>
            </div>
            <div class="formula-line calculation-result">
              <strong>{{ currentCalculationDetail.finalScore?.toFixed(2) }}</strong> = 
              <span class="value">{{ currentCalculationDetail.totalScore?.toFixed(2) }}</span> Ã— 
              <span class="value">{{ currentCalculationDetail.positionBenchmark?.toFixed(2) }}</span> Ã— 
              <span class="value">{{ currentCalculationDetail.cityCoefficient?.toFixed(2) }}</span> Ã— 
              <span class="value">{{ currentCalculationDetail.businessLineCoefficient?.toFixed(2) }}</span> Ã— 
              <span class="value">{{ currentCalculationDetail.performanceCoefficient?.toFixed(2) }}</span>
              <!-- âœ… ç§»é™¤æ—¶é—´ç³»æ•° -->
            </div>
          </div>
        </el-card>

        <!-- ç³»æ•°è¯¦ç»†è¯´æ˜ -->
        <el-card class="coefficients-card" shadow="never">
          <template #header>
            <div class="card-header">
              <span>ğŸ“Š ç³»æ•°è¯¦ç»†è¯´æ˜</span>
            </div>
          </template>
          <el-row :gutter="20">
            <el-col :span="8">
              <div class="coefficient-item">
                <div class="coef-label">ğŸ¯ å²—ä½åŸºå‡†å€¼</div>
                <div class="coef-value">{{ currentCalculationDetail.positionBenchmark?.toFixed(2) }}</div>
                <div class="coef-desc">èŒƒå›´ï¼š0.1 - 3.0</div>
              </div>
            </el-col>
            <el-col :span="8">
              <div class="coefficient-item">
                <div class="coef-label">ğŸŒ† åŸå¸‚ç³»æ•°</div>
                <div class="coef-value" :class="currentCalculationDetail.cityCoefficient > 1 ? 'positive' : 'normal'">
                  {{ currentCalculationDetail.cityCoefficient?.toFixed(2) }}
                </div>
                <div class="coef-desc">èŒƒå›´ï¼š0.8 - 1.5</div>
              </div>
            </el-col>
            <el-col :span="8">
              <div class="coefficient-item">
                <div class="coef-label">ğŸ¢ ä¸šåŠ¡çº¿ç³»æ•°</div>
                <div class="coef-value" :class="currentCalculationDetail.businessLineCoefficient > 1 ? 'positive' : 'normal'">
                  {{ currentCalculationDetail.businessLineCoefficient?.toFixed(2) }}
                </div>
                <div class="coef-desc">èŒƒå›´ï¼š0.8 - 1.5</div>
              </div>
            </el-col>
          </el-row>
          <el-row :gutter="20" style="margin-top: 20px;">
            <el-col :span="8">
              <div class="coefficient-item">
                <div class="coef-label">ğŸ† ç»©æ•ˆç³»æ•°</div>
                <div class="coef-value" :class="currentCalculationDetail.performanceCoefficient >= 1 ? 'positive' : 'negative'">
                  {{ currentCalculationDetail.performanceCoefficient?.toFixed(2) }}
                </div>
                <div class="coef-desc">èŒƒå›´ï¼š0.5 - 2.0</div>
              </div>
            </el-col>
            <!-- âœ… æ—¶é—´ç³»æ•°å·²ç§»é™¤ -->
            <el-col :span="8">
              <div class="coefficient-item highlight">
                <div class="coef-label">âœ¨ æœ€ç»ˆç³»æ•°å¾—åˆ†</div>
                <div class="coef-value final">{{ currentCalculationDetail.finalScore?.toFixed(2) }}</div>
                <div class="coef-desc">åº”ç”¨æ‰€æœ‰ç³»æ•°åçš„å¾—åˆ†</div>
              </div>
            </el-col>
          </el-row>
        </el-card>

        <!-- ä¸‰ç»´å¾—åˆ†æ˜ç»† -->
        <el-card class="scores-card" shadow="never">
          <template #header>
            <div class="card-header">
              <span>ğŸ“Š ä¸‰ç»´è¯„åˆ†æ˜ç»†</span>
            </div>
          </template>
          <el-descriptions :column="3" border>
            <el-descriptions-item label="åˆ©æ¶¦è´¡çŒ®å¾—åˆ†">
              <span class="score-value">{{ currentCalculationDetail.profitContributionScore?.toFixed(2) }}</span>
            </el-descriptions-item>
            <el-descriptions-item label="å²—ä½ä»·å€¼å¾—åˆ†">
              <span class="score-value">{{ currentCalculationDetail.positionValueScore?.toFixed(2) }}</span>
            </el-descriptions-item>
            <el-descriptions-item label="ç»©æ•ˆè¡¨ç°å¾—åˆ†">
              <span class="score-value">{{ currentCalculationDetail.performanceScore?.toFixed(2) }}</span>
            </el-descriptions-item>
            <el-descriptions-item label="ä¸‰ç»´è®¡ç®—å¾—åˆ†" :span="3">
              <span class="score-value highlight">{{ currentCalculationDetail.totalScore?.toFixed(2) }}</span>
              <span class="score-note">(åŠ æƒæ±‡æ€»åçš„åŸºç¡€å¾—åˆ†)</span>
            </el-descriptions-item>
          </el-descriptions>
        </el-card>
      </div>

      <template #footer>
        <div class="dialog-footer">
          <el-button @click="calculationDetailVisible = false">å…³é—­</el-button>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted, computed, watch } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Plus, Refresh, ArrowDown } from '@element-plus/icons-vue'
import { useRouter } from 'vue-router'
import { businessLineApi } from '@/api/businessLine'
import { departmentApi } from '@/api/department'
import { getBonusPools } from '@/api/calculation'
import { startCalculation, simulateCalculation } from '@/api/calculation'
import type { BusinessLine } from '@/types/businessLine'
import type { Department } from '@/api/department'
import request from '@/utils/request'
import { generateCompanyPeriodOptions } from '@/utils/periodUtils'

// å“åº”å¼æ•°æ®
const router = useRouter()
const loading = ref(false)
const calculating = ref(false)
const submitting = ref(false)
const exporting = ref(false)

const bonusPools = ref<any[]>([])
const selectedPools = ref<any[]>([])
const departments = ref<Department[]>([])
const businessLines = ref<BusinessLine[]>([])

// ç»Ÿè®¡æ•°æ®
const statistics = reactive({
  totalPools: 0,
  totalAmount: 0,
  allocatedPools: 0,
  totalEmployees: 0
})

// å…¬å¸è´¢åŠ¡æ•°æ®
const companyFinancialData = ref({
  totalBudget: 0,
  totalCost: 0,
  totalProfit: 0,
  estimatedBonus: 0
})

// æŸ¥è¯¢è¡¨å•
const queryForm = reactive({
  status: undefined
})

// åˆ†é¡µ
const pagination = reactive({
  page: 1,
  pageSize: 20,
  total: 0
})
type BonusPool = {
  _id: number  // æš‚æ—¶ä¿ç•™_idï¼Œè¿™ä¸ªæ–‡ä»¶çš„APIä¸åŒ
  period: string
  totalProfit: number
  poolRatio: number
  reserveRatio: number
  specialRatio: number
  distributableAmount: number
}
type BonusCalculationResult = {
  summary: {
    totalEmployees: number
    totalBonus: number
    averageBonus: number
    maxBonus: number
    minBonus: number
  }
  lineStats: {
    lineName: string
    employees: number
    totalBonus: number
    averageBonus: number
  }[]
  threeDimensionalResults?: any[]
}
// å¯¹è¯æ¡†çŠ¶æ€
const createPoolVisible = ref(false)
const editPoolVisible = ref(false)
const calculateVisible = ref(false)
const progressVisible = ref(false)
const resultVisible = ref(false)

const currentPool = ref<BonusPool>({} as BonusPool)
const calculationResult = ref<BonusCalculationResult>({} as BonusCalculationResult)

// è§†å›¾æ¨¡å¼å’Œå‘˜å·¥æ˜ç»†
const resultViewMode = ref<'line' | 'employee'|'department'>('line')
const lineDistributionMode = ref<'business' | 'department'>('business')
const employeeDetailsList = ref<any[]>([])
const loadingEmployeeDetails = ref(false)

// â­ æ–°å¢ï¼šè®¡ç®—è¿‡ç¨‹è¯¦æƒ…
const calculationDetailVisible = ref(false)
const currentCalculationDetail = ref<any>({})

// è¡¨å•
const poolFormRef = ref()
const editFormRef = ref()
const calculateFormRef = ref()

const poolForm = reactive({
  period: '',
  totalProfit: 10000000,
  poolRatio: 0.15,
  reserveRatio: 0.02,
  specialRatio: 0.03
})

const editForm = reactive({
  period: '',
  totalProfit: 10000000,
  poolRatio: 0.15,
  reserveRatio: 0.02,
  specialRatio: 0.03
})

const calculateForm = reactive({
  mode: 'full',
  departments: [],
  businessLines: [],
  minScoreThreshold: 0,
  simulation: false
})

// è¿›åº¦
const progress = reactive({
  percentage: 0,
  status: '' as 'success' | 'exception' | 'active' | 'warning' | '',
  text: '',
  details: [] as string[]
})

// è¡¨å•éªŒè¯è§„åˆ™
const poolFormRules = {
  period: [
    { required: true, message: 'è¯·è¾“å…¥è®¡ç®—å‘¨æœŸ', trigger: 'blur' }
  ],
  totalProfit: [
    { required: true, message: 'è¯·è¾“å…¥å…¬å¸æ€»åˆ©æ¶¦', trigger: 'blur' },
    { type: 'number', min: 0, message: 'åˆ©æ¶¦ä¸èƒ½ä¸ºè´Ÿæ•°', trigger: 'blur' }
  ]
}

const editFormRules = {
  period: [
    { required: true, message: 'è¯·è¾“å…¥è®¡ç®—å‘¨æœŸ', trigger: 'blur' }
  ],
  totalProfit: [
    { required: true, message: 'è¯·è¾“å…¥å…¬å¸æ€»åˆ©æ¶¦', trigger: 'blur' },
    { type: 'number', min: 0, message: 'åˆ©æ¶¦ä¸èƒ½ä¸ºè´Ÿæ•°', trigger: 'blur' }
  ]
}

// å·¥å…·å‡½æ•°
const formatNumber = (num: number) => {
  return new Intl.NumberFormat('zh-CN').format(num || 0)
}

const formatDate = (date: string | Date) => {
  return new Date(date).toLocaleString('zh-CN')
}

const periodOptions = computed(() => generateCompanyPeriodOptions())

const getStatusType = (status: string) => {
  const statusMap: Record<string, string> = {
    draft: 'info',
    calculated: 'warning',
    allocated: 'success',
    paid: '' // å·²å‘æ”¾ä½¿ç”¨é»˜è®¤ç»¿è‰²
  }
  return statusMap[status] || 'info'
}

const getStatusText = (status: string) => {
  const statusMap: Record<string, string> = {
    draft: 'è‰ç¨¿',
    calculated: 'å·²è®¡ç®—',
    allocated: 'å·²åˆ†é…',
    paid: 'å·²å‘æ”¾'
  }
  return statusMap[status] || status
}

// æ•°æ®åŠ è½½
const loadBonusPools = async () => {
  loading.value = true
  try {
    // è·å–çœŸå®çš„å¥–é‡‘æ± æ•°æ®
    const response = await getBonusPools({ pageSize: 100 })
    const data = response.data
    bonusPools.value = data.bonusPools
    // æ›´æ–°ç»Ÿè®¡
    statistics.totalPools = data.pagination.total
    statistics.totalAmount = bonusPools.value.reduce((sum, pool) => sum + (pool.poolAmount || 0), 0)
    // å·²åˆ†é…ç»Ÿè®¡ï¼šçŠ¶æ€ä¸º 'calculated' æˆ– 'allocated' çš„å¥–é‡‘æ± 
    statistics.allocatedPools = bonusPools.value.filter(pool =>
      pool.status === 'calculated' || pool.status === 'allocated'
    ).length

    // ç»Ÿè®¡å®é™…å‚ä¸å¥–é‡‘åˆ†é…çš„å‘˜å·¥æ•°ï¼ˆä»æ‰€æœ‰å·²è®¡ç®—çš„å¥–é‡‘æ± ä¸­æ±‡æ€»ï¼‰
    try {
      const participantSet = new Set<number>()

      for (const pool of bonusPools.value) {
        if (pool.status === 'calculated' || pool.status === 'allocated') {
          try {
            const { getCalculationHistory } = await import('@/api/calculation')
            const calcResponse: any = await getCalculationHistory(pool._id)

            if (calcResponse && calcResponse.code === 200 && calcResponse.data) {
              const threeDimensionalResults = calcResponse.data.threeDimensionalResults || []
              threeDimensionalResults.forEach((result: any) => {
                participantSet.add(result.employeeId || result.employee_id)
              })
            }
          } catch (error) {
            console.warn(`è·å–å¥–é‡‘æ±  ${pool._id} çš„è®¡ç®—ç»“æœå¤±è´¥:`, error)
          }
        }
      }

      statistics.totalEmployees = participantSet.size
    } catch (error) {
      console.error('ç»Ÿè®¡å‚ä¸å‘˜å·¥æ•°å¤±è´¥:', error)
      // å¦‚æœç»Ÿè®¡å¤±è´¥ï¼Œæ˜¾ç¤º0è€Œä¸æ˜¯é”™è¯¯çš„æ€»å‘˜å·¥æ•°
      statistics.totalEmployees = 0
    }

  } catch (error: any) {
    ElMessage.error('åŠ è½½å¥–é‡‘æ± åˆ—è¡¨å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
  } finally {
    loading.value = false
  }
}

const loadBasicData = async () => {
  try {
    console.log('ğŸ”„ æ­£åœ¨åŠ è½½åŸºç¡€æ•°æ®...')

    // åŠ è½½ä¸šåŠ¡çº¿æ•°æ®
    const businessLinesResponse = await businessLineApi.getBusinessLines({
      pageSize: 100,
      status: 1
    })

    if (businessLinesResponse && businessLinesResponse.data) {
      businessLines.value = businessLinesResponse.data.list || []
      console.log('âœ… æˆåŠŸåŠ è½½ä¸šåŠ¡çº¿æ•°æ®:', businessLines.value.length, 'ä¸ªä¸šåŠ¡çº¿')
    }

    // åŠ è½½éƒ¨é—¨æ•°æ®
    const departmentsResponse = await departmentApi.getDepartmentOptions({
      status: 1
    })

    if (departmentsResponse && departmentsResponse.data) {
      departments.value = departmentsResponse.data.departments || []
      console.log('âœ… æˆåŠŸåŠ è½½éƒ¨é—¨æ•°æ®:', departments.value.length, 'ä¸ªéƒ¨é—¨')
    }

    console.log('âœ… åŸºç¡€æ•°æ®åŠ è½½å®Œæˆ')

  } catch (error: any) {
    console.error('âŒ åŠ è½½åŸºç¡€æ•°æ®å¤±è´¥:', error)
    ElMessage.error('åŠ è½½åŸºç¡€æ•°æ®å¤±è´¥: ' + (error.response?.data?.message || error.message))

    // è®¾ç½®ç©ºæ•°ç»„ä½œä¸ºé»˜è®¤å€¼
    businessLines.value = []
    departments.value = []
  }
}

// äº‹ä»¶å¤„ç†
const refreshData = () => {
  loadBonusPools()
  loadBasicData()
}

const handleSearch = () => {
  loadBonusPools()
}

const handleSizeChange = (size: number) => {
  pagination.pageSize = size
  loadBonusPools()
}

const handleCurrentChange = (page: number) => {
  pagination.page = page
  loadBonusPools()
}

const handleSelectionChange = (selection: BonusPool[]) => {
  selectedPools.value = selection
}

const showCreatePoolDialog = async () => {
  // é‡ç½®è¡¨å•
  Object.assign(poolForm, {
    period: '',
    totalProfit: 0,
    poolRatio: 0.15,
    reserveRatio: 0.02,
    specialRatio: 0.03
  })

  // è·å–å…¬å¸æ€»ä½“è´¢åŠ¡æ•°æ®
  try {
    const { projectCostApi } = await import('@/api/projectCosts')
    const response = await projectCostApi.getAllProjectCostSummaries()
    const summaries = response.data || []

    // è®¡ç®—å…¬å¸æ€»ä½“è´¢åŠ¡æ•°æ®
    companyFinancialData.value.totalBudget = summaries.reduce((sum: number, s: any) => sum + (Number(s?.totalBudget) || 0), 0)
    companyFinancialData.value.totalCost = summaries.reduce((sum: number, s: any) => sum + (Number(s?.totalCost) || 0), 0)
    companyFinancialData.value.totalProfit = companyFinancialData.value.totalBudget - companyFinancialData.value.totalCost
    companyFinancialData.value.estimatedBonus = summaries.reduce((sum: number, s: any) => sum + (Number(s?.estimatedBonus) || 0), 0)

    // è®¡ç®—å·²åˆ†é…çš„é¡¹ç›®å¥–é‡‘å’Œå¯ç”¨åˆ©æ¶¦
    const allocatedProjectBonus = summaries.reduce((sum: number, s: any) => sum + (Number(s?.allocatedProjectBonus) || 0), 0)
    const availableProfit = summaries.reduce((sum: number, s: any) => sum + (Number(s?.availableProfit) || 0), 0)

    // æŸ¥è¯¢å·²åˆ›å»ºçš„å…¬å¸çº§å¥–é‡‘æ± æ€»é¢
    const { getBonusPools } = await import('@/api/calculation')
    const bonusPoolsResponse = await getBonusPools({ pageSize: 1000 })
    const allocatedCompanyBonus = (bonusPoolsResponse.data?.bonusPools || []).reduce((sum: number, pool: any) => {
      return sum + (Number(pool?.poolAmount) || 0)
    }, 0)

    // è®¡ç®—æœ€ç»ˆå¯ç”¨åˆ©æ¶¦
    const finalAvailableProfit = availableProfit - allocatedCompanyBonus

      // ä¿å­˜æ‰©å±•ä¿¡æ¯
      ; (companyFinancialData.value as any).allocatedProjectBonus = allocatedProjectBonus
      ; (companyFinancialData.value as any).allocatedCompanyBonus = allocatedCompanyBonus
      ; (companyFinancialData.value as any).finalAvailableProfit = finalAvailableProfit

    // console.log('å…¬å¸è´¢åŠ¡æ•°æ®:', {
    //   totalBudget: companyFinancialData.value.totalBudget,
    //   totalCost: companyFinancialData.value.totalCost,
    //   totalProfit: companyFinancialData.value.totalProfit,
    //   allocatedProjectBonus,
    //   allocatedCompanyBonus,
    //   finalAvailableProfit
    // })
  } catch (error) {
    console.error('è·å–å…¬å¸è´¢åŠ¡æ•°æ®å¤±è´¥:', error)
  }

  createPoolVisible.value = true
}

const handleCreatePool = async () => {
  if (!poolFormRef.value) return

  try {
    await poolFormRef.value.validate()

    // éªŒè¯å¥–é‡‘æ± é‡‘é¢æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…
    const poolAmount = poolForm.totalProfit * poolForm.poolRatio
    const totalProfit = companyFinancialData.value.totalProfit

    // æ£€æŸ¥è¾“å…¥çš„æ€»åˆ©æ¶¦æ˜¯å¦è¶…è¿‡å®é™…æ€»åˆ©æ¶¦
    if (totalProfit > 0 && poolForm.totalProfit > totalProfit * 1.5) {
      const confirmResult = await ElMessageBox.confirm(
        `è¾“å…¥çš„å…¬å¸æ€»åˆ©æ¶¦ Â¥${formatNumber(poolForm.totalProfit)} è¶…è¿‡äº†å®é™…æ€»åˆ©æ¶¦ Â¥${formatNumber(totalProfit)} çš„150%ï¼Œæ˜¯å¦ç»§ç»­åˆ›å»ºï¼Ÿ`,
        'æ€»åˆ©æ¶¦æ•°æ®å¼‚å¸¸',
        {
          type: 'warning',
          confirmButtonText: 'ç»§ç»­åˆ›å»º',
          cancelButtonText: 'é‡æ–°è°ƒæ•´'
        }
      ).catch(() => false)

      if (!confirmResult) {
        return
      }
    }

    // æ£€æŸ¥å¥–é‡‘æ± é‡‘é¢æ˜¯å¦è¶…è¿‡æ€»åˆ©æ¶¦
    if (poolAmount > poolForm.totalProfit) {
      ElMessage.error('å¥–é‡‘æ± é‡‘é¢ä¸èƒ½è¶…è¿‡å…¬å¸æ€»åˆ©æ¶¦')
      return
    }

    submitting.value = true

    // è°ƒç”¨çœŸå®APIåˆ›å»ºå¥–é‡‘æ± 
    const createData = {
      period: poolForm.period,
      totalProfit: poolForm.totalProfit,
      poolRatio: poolForm.poolRatio,
      reserveRatio: poolForm.reserveRatio,
      specialRatio: poolForm.specialRatio
    }

    console.log('åˆ›å»ºå¥–é‡‘æ± :', createData)

    // ä½¿ç”¨calculation APIåˆ›å»ºå¥–é‡‘æ± 
    const { createBonusPool } = await import('@/api/calculation')
    const response: any = await createBonusPool(createData)

    if (response && response.code === 200) {
      ElMessage.success('å¥–é‡‘æ± åˆ›å»ºæˆåŠŸ')
      createPoolVisible.value = false
      loadBonusPools()
    } else {
      throw new Error(response?.message || 'åˆ›å»ºå¥–é‡‘æ± å¤±è´¥')
    }

  } catch (error: any) {
    console.error('åˆ›å»ºå¥–é‡‘æ± å¤±è´¥:', error)
    if (error !== 'cancel') {
      const errorMessage = error.response?.data?.message || error.message || 'åˆ›å»ºå¤±è´¥'
      ElMessage.error(errorMessage)
    }
  } finally {
    submitting.value = false
  }
}

const showCalculateDialog = (pool: BonusPool) => {
  currentPool.value = pool
  Object.assign(calculateForm, {
    mode: 'full',
    departments: [],
    businessLines: [],
    minScoreThreshold: 0,
    simulation: false
  })
  calculateVisible.value = true
}

const handleCalculate = async () => {
  if (!currentPool.value || !currentPool.value.period) {
    ElMessage.error('å¥–é‡‘æ± ä¿¡æ¯ä¸å®Œæ•´')
    return
  }

  calculating.value = true

  try {
    // ç¬¬ä¸€æ­¥ï¼šéªŒè¯ç»©æ•ˆæ•°æ®
    const { validatePerformanceData } = await import('@/api/calculation')
    let validationResponse: any
    
    try {
      validationResponse = await validatePerformanceData(currentPool.value.period)
    } catch (error: any) {
      // æ•è·requestæ‹¦æˆªå™¨çš„rejectï¼Œä»é”™è¯¯ä¿¡æ¯ä¸­æå–ä¸šåŠ¡ä¿¡æ¯
      const errorMessage = error.message || ''
      calculating.value = false
      await ElMessageBox.alert(
        errorMessage,
        'ç»©æ•ˆæ•°æ®ä¸å®Œæ•´',
        {
          type: 'error',
          confirmButtonText: 'å»å½•å…¥'
        }
      )
      return
    }
    
    if (validationResponse.code === 400) {
      // æ²¡æœ‰ç»©æ•ˆæ•°æ®ï¼Œé˜»æ­¢è®¡ç®—
      calculating.value = false
      await ElMessageBox.alert(
        validationResponse.message,
        'ç»©æ•ˆæ•°æ®ä¸å®Œæ•´',
        {
          type: 'error',
          confirmButtonText: 'å»å½•å…¥'
        }
      )
      return
    } else if (validationResponse.code === 200 && validationResponse.data?.warning) {
      // ç»©æ•ˆæ•°æ®ä¸å®Œæ•´ï¼Œç»™å‡ºè­¦å‘Š
      const confirmResult = await ElMessageBox.confirm(
        validationResponse.message,
        'ç»©æ•ˆæ•°æ®è­¦å‘Š',
        {
          type: 'warning',
          confirmButtonText: 'ç»§ç»­è®¡ç®—',
          cancelButtonText: 'å»è¡¥å……',
          distinguishCancelAndClose: true
        }
      ).catch((action) => {
        if (action === 'cancel') {
          router.push('/performance/records')
        }
        return false
      })

      if (!confirmResult) {
        calculating.value = false
        return
      }
    }

    // ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œè®¡ç®—
    calculateVisible.value = false
    progressVisible.value = true

    // é‡ç½®è¿›åº¦
    Object.assign(progress, {
      percentage: 0,
      status: 'active',
      text: 'å‡†å¤‡è®¡ç®—...',
      details: []
    })

    // è°ƒç”¨çœŸå®çš„è®¡ç®—API
    const calculateData = {
      poolId: currentPool.value._id,
      mode: calculateForm.mode as 'full' | 'department' | 'line',
      departments: calculateForm.departments,
      businessLines: calculateForm.businessLines,
      minScoreThreshold: calculateForm.minScoreThreshold,
      simulation: calculateForm.simulation
    }

    const response: any = await startCalculation(calculateData)

    if (response && response.code === 200) {
      const taskId = response.data.taskId;

      // å¦‚æœæ˜¯æ¨¡æ‹Ÿè®¡ç®—ï¼Œç›´æ¥æ˜¾ç¤ºç»“æœ
      if (calculateForm.simulation) {
        // è·å–æ¨¡æ‹Ÿè®¡ç®—ç»“æœ
        try {
          const simulateResponse: any = await simulateCalculation(calculateData)

          if (simulateResponse && simulateResponse.code === 200) {
            calculationResult.value = {
              summary: simulateResponse.data.summary,
              lineStats: Object.entries(simulateResponse.data.distribution.byDepartment).map(([lineName, data]: [string, any]) => ({
                lineName,
                employees: data.count,
                totalBonus: data.amount,
                averageBonus: data.count > 0 ? data.amount / data.count : 0
              }))
            }
            progressVisible.value = false
            resultVisible.value = true
          } else {
            throw new Error(simulateResponse?.message || 'æ¨¡æ‹Ÿè®¡ç®—å¤±è´¥')
          }
        } catch (simulateError: any) {
          progress.status = 'exception'
          progress.text = 'æ¨¡æ‹Ÿè®¡ç®—å¤±è´¥: ' + (simulateError.message || 'æœªçŸ¥é”™è¯¯')
        }
      } else {
        // å®é™…è®¡ç®—ï¼Œå¼€å§‹è½®è¯¢è¿›åº¦
        await pollCalculationProgress(taskId);
      }
    } else {
      throw new Error(response?.message || 'è®¡ç®—ä»»åŠ¡æäº¤å¤±è´¥')
    }

  } catch (error: any) {
    progress.status = 'exception'
    progress.text = 'è®¡ç®—å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯')
    ElMessage.error('è®¡ç®—å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
  } finally {
    calculating.value = false
  }
}

const viewCalculationResult = () => {
  progressVisible.value = false
  resultVisible.value = true
}

const showResultDialog = async (pool: BonusPool) => {
  currentPool.value = pool
  loading.value = true
  resultViewMode.value = 'line'
  try {
    // è°ƒç”¨çœŸå®çš„APIè·å–è®¡ç®—ç»“æœ
    const { getCalculationHistory } = await import('@/api/calculation')
    const response: any = await getCalculationHistory(pool._id)

    if (response && response.code === 200 && response.data && response.data.summary) {
      // ä½¿ç”¨APIè¿”å›çš„å®é™…æ•°æ®
      const data = response.data

      // åˆ›å»ºè®¡ç®—ç»“æœå¯¹è±¡
      calculationResult.value = {
        summary: data.summary,
        lineStats: [],
        threeDimensionalResults: data.threeDimensionalResults
      }

      // åŠ è½½ä¸šåŠ¡çº¿ç»Ÿè®¡æ•°æ®
      await loadBusinessLineStats();
    } else {
      // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      calculationResult.value = {
        summary: {
          totalEmployees: 31,
          totalBonus: 1350000,
          averageBonus: 9000,
          maxBonus: 45000,
          minBonus: 3000
        },
        lineStats: [
          { lineName: 'å®æ–½', employees: 16, totalBonus: 742500, averageBonus: 9281 },
          { lineName: 'å”®å‰', employees: 6, totalBonus: 270000, averageBonus: 9000 },
          { lineName: 'å¸‚åœº', employees: 5, totalBonus: 202500, averageBonus: 8100 },
          { lineName: 'è¿è¥', employees: 4, totalBonus: 135000, averageBonus: 9000 }
        ],
        threeDimensionalResults: []
      }
    }
  } catch (error: any) {
    ElMessage.error('è·å–è®¡ç®—ç»“æœå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
    // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
    calculationResult.value = {
      summary: {
        totalEmployees: 31,
        totalBonus: 1350000,
        averageBonus: 9000,
        maxBonus: 45000,
        minBonus: 3000
      },
      lineStats: [
        { lineName: 'å®æ–½', employees: 16, totalBonus: 742500, averageBonus: 9281 },
        { lineName: 'å”®å‰', employees: 6, totalBonus: 270000, averageBonus: 9000 },
        { lineName: 'å¸‚åœº', employees: 5, totalBonus: 202500, averageBonus: 8100 },
        { lineName: 'è¿è¥', employees: 4, totalBonus: 135000, averageBonus: 9000 }
      ],
      threeDimensionalResults: []
    }
  } finally {
    loading.value = false
    resultVisible.value = true
  }
}

const exportResult = async () => {
  if (!currentPool.value) {
    ElMessage.warning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¥–é‡‘æ± ')
    return
  }

  exporting.value = true
  try {
    const { exportCalculationResult } = await import('@/api/calculation')
    const response = await exportCalculationResult(currentPool.value._id, 'excel')

    // åˆ›å»º Blob å¯¹è±¡
    const blob = new Blob([response.data], {
      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    })

    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const url = window.URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = `å¥–é‡‘æ± è®¡ç®—ç»“æœ_${currentPool.value.period}.xlsx`
    document.body.appendChild(link)
    link.click()

    // æ¸…ç†
    document.body.removeChild(link)
    window.URL.revokeObjectURL(url)

    ElMessage.success('å¯¼å‡ºæˆåŠŸ')
  } catch (error: any) {
    console.error('å¯¼å‡ºå¤±è´¥:', error)
    ElMessage.error('å¯¼å‡ºå¤±è´¥: ' + (error.response?.data?.message || error.message || 'æœªçŸ¥é”™è¯¯'))
  } finally {
    exporting.value = false
  }
}

const showEditDialog = (pool: BonusPool) => {
  currentPool.value = pool
  // å¡«å……ç¼–è¾‘è¡¨å•
  Object.assign(editForm, {
    period: pool.period,
    totalProfit: pool.totalProfit,
    poolRatio: pool.poolRatio,
    reserveRatio: pool.reserveRatio,
    specialRatio: pool.specialRatio
  })
  editPoolVisible.value = true
}

const handleEditPool = async () => {
  if (!editFormRef.value) return

  try {
    await editFormRef.value.validate()

    submitting.value = true

    const updateData = {
      period: editForm.period,
      totalProfit: editForm.totalProfit,
      poolRatio: editForm.poolRatio,
      reserveRatio: editForm.reserveRatio,
      specialRatio: editForm.specialRatio
    }

    console.log('æ›´æ–°å¥–é‡‘æ± :', currentPool.value._id, updateData)

    const { updateBonusPool } = await import('@/api/calculation')
    const response: any = await updateBonusPool(currentPool.value._id, updateData)

    if (response && response.code === 200) {
      ElMessage.success('å¥–é‡‘æ± æ›´æ–°æˆåŠŸ')
      editPoolVisible.value = false
      loadBonusPools()
    } else {
      throw new Error(response?.message || 'æ›´æ–°å¥–é‡‘æ± å¤±è´¥')
    }

  } catch (error: any) {
    console.error('æ›´æ–°å¥–é‡‘æ± å¤±è´¥:', error)
    if (error !== 'cancel') {
      const errorMessage = error.response?.data?.message || error.message || 'æ›´æ–°å¤±è´¥'
      ElMessage.error(errorMessage)
    }
  } finally {
    submitting.value = false
  }
}

const handleCopyPool = async (pool: BonusPool) => {
  try {
    const { value: newPeriod } = await ElMessageBox.prompt(
      'è¯·è¾“å…¥æ–°å¥–é‡‘æ± çš„è®¡ç®—å‘¨æœŸ',
      'å¤åˆ¶å¥–é‡‘æ± ',
      {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        inputPattern: /.+/,
        inputErrorMessage: 'è¯·è¾“å…¥è®¡ç®—å‘¨æœŸ',
        inputValue: `${pool.period}-copy`
      }
    )

    if (!newPeriod) {
      return
    }

    submitting.value = true

    const { copyBonusPool } = await import('@/api/calculation')
    const response: any = await copyBonusPool(pool._id, newPeriod)

    if (response && response.code === 200) {
      ElMessage.success('å¥–é‡‘æ± å¤åˆ¶æˆåŠŸ')
      loadBonusPools()
    } else {
      throw new Error(response?.message || 'å¤åˆ¶å¥–é‡‘æ± å¤±è´¥')
    }

  } catch (error: any) {
    if (error !== 'cancel') {
      console.error('å¤åˆ¶å¥–é‡‘æ± å¤±è´¥:', error)
      const errorMessage = error.response?.data?.message || error.message || 'å¤åˆ¶å¤±è´¥'
      ElMessage.error(errorMessage)
    }
  } finally {
    submitting.value = false
  }
}


const handleMoreAction = async (command: string, pool: BonusPool) => {
  switch (command) {
    case 'edit':
      showEditDialog(pool)
      break
    case 'copy':
      await handleCopyPool(pool)
      break
    case 'export':
      // å¯¼å‡ºç»“æœ
      currentPool.value = pool
      await exportResult()
      break
    case 'delete':
      try {
        await ElMessageBox.confirm(
          `ç¡®å®šè¦åˆ é™¤å¥–é‡‘æ±  ${pool.period} å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚`,
          'ç¡®è®¤åˆ é™¤',
          {
            confirmButtonText: 'ç¡®å®š',
            cancelButtonText: 'å–æ¶ˆ',
            type: 'warning'
          }
        )

        // è°ƒç”¨åˆ é™¤API
        const { deleteBonusPool } = await import('@/api/calculation')
        const response: any = await deleteBonusPool(pool._id)

        if (response && response.code === 200) {
          ElMessage.success('åˆ é™¤æˆåŠŸ')
          loadBonusPools()
        } else {
          throw new Error(response?.message || 'åˆ é™¤å¤±è´¥')
        }
      } catch (error: any) {
        // ç”¨æˆ·å–æ¶ˆæˆ–åˆ é™¤å¤±è´¥
        if (error !== 'cancel') {
          const errorMessage = error.response?.data?.message || error.message || 'åˆ é™¤å¤±è´¥'
          ElMessage.error(errorMessage)
        }
      }
      break
  }
}

// å‘æ”¾å¥–é‡‘
const handlePayment = async (pool: BonusPool) => {
  try {
    await ElMessageBox.confirm(
      `ç¡®è®¤å‘æ”¾å¥–é‡‘æ±  ${pool.period} çš„å¥–é‡‘ï¼Ÿ\n\nå‘æ”¾åå°†ä¸èƒ½ä¿®æ”¹æˆ–åˆ é™¤æ­¤å¥–é‡‘æ± ã€‚`,
      'ç¡®è®¤å‘æ”¾',
      {
        confirmButtonText: 'ç¡®è®¤å‘æ”¾',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }
    )

    // è°ƒç”¨å‘æ”¾æ¥å£
    const { payBonusPool } = await import('@/api/calculation')
    const response: any = await payBonusPool(pool._id)

    if (response && response.code === 200) {
      ElMessage.success('å¥–é‡‘å‘æ”¾æˆåŠŸ')
      loadBonusPools()
    } else {
      throw new Error(response?.message || 'å‘æ”¾å¤±è´¥')
    }
  } catch (error: any) {
    if (error !== 'cancel') {
      const errorMessage = error.response?.data?.message || error.message || 'å‘æ”¾å¤±è´¥'
      ElMessage.error(errorMessage)
    }
  }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ•°æ®
onMounted(() => {
  loadBonusPools()
  loadBasicData()
})

// ç›‘å¬è§†å›¾æ¨¡å¼åˆ‡æ¢ï¼ŒåŠ è½½å‘˜å·¥æ˜ç»†
watch(resultViewMode, async (newMode) => {
  if (newMode === 'employee' && currentPool.value._id) {
    await loadEmployeeDetails()
  }
})

// ç›‘å¬è§†å›¾æ¨¡å¼åˆ‡æ¢ï¼ŒåŠ è½½ç›¸åº”æ•°æ®
watch(resultViewMode, async (newMode) => {
  if (calculationResult.value && calculationResult.value.threeDimensionalResults) {
    if (newMode === 'line') {
      await loadBusinessLineStats();
    } else if (newMode === 'department') {
      await loadDepartmentStats();
    } else if (newMode === 'employee') {
      await loadEmployeeDetails();
    }
  }
})

// è½®è¯¢è®¡ç®—è¿›åº¦
const pollCalculationProgress = async (taskId: string) => {
  // åˆå§‹åŒ–è¿›åº¦
  Object.assign(progress, {
    percentage: 0,
    status: 'active',
    text: 'æ­£åœ¨è®¡ç®—ä¸­...',
    details: ['ä»»åŠ¡å·²æäº¤']
  })

  const maxRetries = 60; // æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œå‡è®¾æ¯ç§’ä¸€æ¬¡ï¼Œæœ€å¤š1åˆ†é’Ÿ
  let retryCount = 0;

  while (retryCount < maxRetries) {
    try {
      const { getCalculationResult } = await import('@/api/calculation')
      const response: any = await getCalculationResult(taskId)

      if (response && response.code === 200 && response.data) {
        const resultData = response.data

        // æ›´æ–°è¿›åº¦
        if (resultData.progress !== undefined) {
          progress.percentage = resultData.progress
        }

       // æ ¹æ®çŠ¶æ€æ›´æ–°UI
        if (resultData.status === 'completed') {
          progress.status = 'success'
          progress.text = 'è®¡ç®—å®Œæˆï¼'
          progress.details.push('è®¡ç®—ä»»åŠ¡å·²å®Œæˆï¼Œè¯·ç‚¹å‡»"æŸ¥çœ‹ç»“æœ"æŒ‰é’®æŸ¥çœ‹è¯¦æƒ…')

          // ä¸å†è‡ªåŠ¨å¼¹å‡ºç»“æœå¯¹è¯æ¡†ï¼Œç”±ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»"æŸ¥çœ‹ç»“æœ"æŒ‰é’®
          // åˆ·æ–°å¥–é‡‘æ± åˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€
          await loadBonusPools()
          
          break
        } else if (resultData.status === 'error') {
          progress.status = 'exception'
          progress.text = 'è®¡ç®—å¤±è´¥: ' + (resultData.error || 'æœªçŸ¥é”™è¯¯')
          progress.details.push('é”™è¯¯: ' + (resultData.error || 'æœªçŸ¥é”™è¯¯'))
          break
        } else if (resultData.status === 'processing') {
          progress.status = 'active'
          progress.text = `æ­£åœ¨è®¡ç®—ä¸­... (${resultData.progress || 0}%)`

          // å¦‚æœæœ‰å…·ä½“è¿›åº¦ä¿¡æ¯
          if (resultData.message) {
            progress.details.push(resultData.message)
          }
        }
      } else {
        // å¦‚æœAPIè¿”å›é”™è¯¯ï¼Œé‡è¯•
        progress.details.push(`å°è¯• ${retryCount + 1}: è¯·æ±‚å¤±è´¥`)
      }
    } catch (error: any) {
      console.error('è·å–è®¡ç®—è¿›åº¦å¤±è´¥:', error)
      progress.details.push(`å°è¯• ${retryCount + 1}: ${(error.message || 'ç½‘ç»œé”™è¯¯')}`)
    }

    // ç­‰å¾…1ç§’å†ç»§ç»­è½®è¯¢
    await new Promise(resolve => setTimeout(resolve, 1000))
    retryCount++
  }

  if (retryCount >= maxRetries) {
    progress.status = 'warning'
    progress.text = 'è®¡ç®—è¶…æ—¶ï¼Œè¯·ç¨åæŸ¥çœ‹ç»“æœ'
    progress.details.push('ä»»åŠ¡è¶…æ—¶ï¼Œå»ºè®®æ‰‹åŠ¨åˆ·æ–°æŸ¥çœ‹ç»“æœ')
  }
}

// åŠ è½½ä¸šåŠ¡çº¿ç»Ÿè®¡æ•°æ®ï¼ˆé€šç”¨å‡½æ•°ï¼Œç”¨äºåˆå§‹åŒ–ï¼‰
const loadLineStats = async () => {
  try {
    // ä»ä¸‰ç»´è®¡ç®—ç»“æœä¸­æå–ä¸šåŠ¡çº¿æ•°æ®
    if (calculationResult.value && calculationResult.value.threeDimensionalResults) {
      const results = calculationResult.value.threeDimensionalResults

      // æŒ‰ä¸šåŠ¡çº¿åˆ†ç»„ç»Ÿè®¡
      const lineStatsMap = new Map<string, { lineName: string, employees: number, totalBonus: number, averageBonus: number }>()

      for (const result of results) {
        // ä¼˜å…ˆä½¿ç”¨ä¸šåŠ¡çº¿åç§°ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨éƒ¨é—¨åç§°
        const lineName = result.businessLineName || result.business_line_name || result.departmentName || result.department_name || 'æœªåˆ†é…'
        const finalBonus = parseFloat(result.finalBonusAmount || result.final_bonus_amount || 0)

        if (!lineStatsMap.has(lineName)) {
          lineStatsMap.set(lineName, {
            lineName,
            employees: 0,
            totalBonus: 0,
            averageBonus: 0
          })
        }

        const stat = lineStatsMap.get(lineName)!
        stat.employees++
        stat.totalBonus += finalBonus
      }

      // è®¡ç®—å¹³å‡å¥–é‡‘
      for (const [_, stat] of lineStatsMap) {
        stat.averageBonus = stat.employees > 0 ? stat.totalBonus / stat.employees : 0
      }

      calculationResult.value.lineStats = Array.from(lineStatsMap.values())
    }
  } catch (error: any) {
    console.error('åŠ è½½ä¸šåŠ¡çº¿ç»Ÿè®¡æ•°æ®å¤±è´¥:', error)
    ElMessage.error('åŠ è½½ä¸šåŠ¡çº¿ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
  }
}

// åŠ è½½éƒ¨é—¨ç»Ÿè®¡æ•°æ®
const loadDepartmentStats = async () => {
  try {
    // ä»ä¸‰ç»´è®¡ç®—ç»“æœä¸­æå–éƒ¨é—¨æ•°æ®
    if (calculationResult.value && calculationResult.value.threeDimensionalResults) {
      const results = calculationResult.value.threeDimensionalResults

      // æŒ‰éƒ¨é—¨åˆ†ç»„ç»Ÿè®¡
      const lineStatsMap = new Map<string, { lineName: string, employees: number, totalBonus: number, averageBonus: number }>()

      for (const result of results) {
        // ä½¿ç”¨éƒ¨é—¨åç§°
        const lineName = result.departmentName || result.department_name || 'æœªåˆ†é…'
        const finalBonus = parseFloat(result.finalBonusAmount || result.final_bonus_amount || 0)

        if (!lineStatsMap.has(lineName)) {
          lineStatsMap.set(lineName, {
            lineName,
            employees: 0,
            totalBonus: 0,
            averageBonus: 0
          })
        }

        const stat = lineStatsMap.get(lineName)!
        stat.employees++
        stat.totalBonus += finalBonus
      }

      // è®¡ç®—å¹³å‡å¥–é‡‘
      for (const [_, stat] of lineStatsMap) {
        stat.averageBonus = stat.employees > 0 ? stat.totalBonus / stat.employees : 0
      }

      calculationResult.value.lineStats = Array.from(lineStatsMap.values())
    }
  } catch (error: any) {
    console.error('åŠ è½½éƒ¨é—¨ç»Ÿè®¡æ•°æ®å¤±è´¥:', error)
    ElMessage.error('åŠ è½½éƒ¨é—¨ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
  }
}

// ä¸“é—¨ç”¨äºåŠ è½½ä¸šåŠ¡çº¿æ•°æ®çš„å‡½æ•°
const loadBusinessLineStats = async () => {
  try {
    // ä»ä¸‰ç»´è®¡ç®—ç»“æœä¸­æå–ä¸šåŠ¡çº¿æ•°æ®
    if (calculationResult.value && calculationResult.value.threeDimensionalResults) {
      const results = calculationResult.value.threeDimensionalResults

      console.log('ğŸ” ä¸šåŠ¡çº¿ç»Ÿè®¡ - æ•°æ®æ ·æœ¬:', results[0])

      // æŒ‰ä¸šåŠ¡çº¿åˆ†ç»„ç»Ÿè®¡
      const lineStatsMap = new Map<string, { lineName: string, employees: number, totalBonus: number, averageBonus: number }>()

      for (const result of results) {
        // å¤šç§å¯èƒ½çš„å­—æ®µåï¼š
        // 1. businessLineName (ç›´æ¥å­—æ®µ)
        // 2. business_line_name (ä¸‹åˆ’çº¿å­—æ®µ)
        // 3. businessLine.name (å¯¹è±¡å­—æ®µ)
        // 4. business_line.name (å¯¹è±¡å­—æ®µ)
        let lineName = result.businessLineName || result.business_line_name
        
        if (!lineName && result.businessLine) {
          lineName = typeof result.businessLine === 'object' 
            ? (result.businessLine.name || result.businessLine.Name)
            : result.businessLine
        }
        
        if (!lineName && result.business_line) {
          lineName = typeof result.business_line === 'object'
            ? (result.business_line.name || result.business_line.Name)  
            : result.business_line
        }
        
        // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œæ ‡è®°ä¸º"æœªåˆ†é…"
        lineName = lineName || 'æœªåˆ†é…'
        
        const finalBonus = parseFloat(result.finalBonusAmount || result.final_bonus_amount || 0)

        // åŒ…å«æ‰€æœ‰æ•°æ®ï¼Œå³ä½¿æ˜¯"æœªåˆ†é…"çš„ä¹Ÿè¦æ˜¾ç¤º
        if (!lineStatsMap.has(lineName)) {
          lineStatsMap.set(lineName, {
            lineName,
            employees: 0,
            totalBonus: 0,
            averageBonus: 0
          })
        }

        const stat = lineStatsMap.get(lineName)!
        stat.employees++
        stat.totalBonus += finalBonus
      }

      // è®¡ç®—å¹³å‡å¥–é‡‘
      for (const [_, stat] of lineStatsMap) {
        stat.averageBonus = stat.employees > 0 ? stat.totalBonus / stat.employees : 0
      }

      calculationResult.value.lineStats = Array.from(lineStatsMap.values())
      console.log('âœ… ä¸šåŠ¡çº¿ç»Ÿè®¡å®Œæˆ:', calculationResult.value.lineStats)
    }
  } catch (error: any) {
    console.error('åŠ è½½ä¸šåŠ¡çº¿ç»Ÿè®¡æ•°æ®å¤±è´¥:', error)
    ElMessage.error('åŠ è½½ä¸šåŠ¡çº¿ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
  }
}

// åŠ è½½å‘˜å·¥å¥–é‡‘æ˜ç»†
const loadEmployeeDetails = async () => {
  if (!currentPool.value._id) {
    return
  }

  loadingEmployeeDetails.value = true
  try {
    // è°ƒç”¨APIè·å–ä¸‰ç»´è®¡ç®—ç»“æœ
    const response: any = await request({
      url: `/calculations/bonus-pools/${currentPool.value._id}/calculations`,
      method: 'get'
    })

    if (response.code === 200 && response.data.threeDimensionalResults) {
      const results = response.data.threeDimensionalResults

      console.log('=== ä¸‰ç»´è®¡ç®—ç»“æœè°ƒè¯• ===')
      console.log('è®¡ç®—ç»“æœæ•°é‡:', results.length)
      if (results.length > 0) {
        console.log('ç¬¬ä¸€æ¡ç»“æœæ ·ä¾‹:', results[0])
      }

      // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„å‘˜å·¥ä¿¡æ¯ï¼Œä¸éœ€è¦å†æ¬¡æŸ¥è¯¢
      employeeDetailsList.value = results.map((result: any) => {
        return {
          employeeId: result.employeeId,
          // åç«¯å·²ç»å…³è”å¥½äº†å‘˜å·¥ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨
          employeeNo: result.employeeNo || result.employee_no || '-',
          employeeName: result.employeeName || result.employee_name || 'æœªçŸ¥',
          departmentName: result.departmentName || result.department_name || '-',
          positionName: result.positionName || result.position_name || '-',
          businessLineName: result.businessLineName || result.business_line_name || '-', // æ·»åŠ ä¸šåŠ¡çº¿åç§°
          profitContributionScore: result.profitContributionScore || result.profit_contribution_score || 0,
          positionValueScore: result.positionValueScore || result.position_value_score || 0,
          performanceScore: result.performanceScore || result.performance_score || 0,
          finalScore: result.finalScore || result.final_score || 0,
          totalScore: result.total_score || result.total_score || 0,
          finalBonusAmount: result.finalBonusAmount || result.final_bonus_amount || 0,
          
          // â­ æ–°å¢ï¼šç³»æ•°å­—æ®µï¼ˆç”¨äºå±•ç¤ºè®¡ç®—è¿‡ç¨‹ï¼‰
          baseThreeDimensionalScore: result.baseThreeDimensionalScore || result.base_three_dimensional_score || 0,
          finalCoefficientScore: result.finalCoefficientScore || result.final_coefficient_score || 0,
          positionBenchmark: result.positionBenchmark || result.position_benchmark || 1.0,
          cityCoefficient: result.cityCoefficient || result.city_coefficient || 1.0,
          businessLineCoefficient: result.businessLineCoefficient || result.business_line_coefficient || 1.0,
          performanceCoefficient: result.performanceCoefficient || result.performance_coefficient || 1.0,
          // timeCoefficient: result.timeCoefficient || result.time_coefficient || 1.0  // âœ… å·²ç§»é™¤
        }
      })

      // æŒ‰å¥–é‡‘é™åºæ’åº
      employeeDetailsList.value.sort((a, b) => b.finalBonusAmount - a.finalBonusAmount)
    } else {
      employeeDetailsList.value = []
    }
  } catch (error: any) {
    console.error('åŠ è½½å‘˜å·¥æ˜ç»†å¤±è´¥:', error)
    ElMessage.error('åŠ è½½å‘˜å·¥æ˜ç»†å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'))
    employeeDetailsList.value = []
  } finally {
    loadingEmployeeDetails.value = false
  }
}

// â­ æ–°å¢ï¼šæ˜¾ç¤ºè®¡ç®—è¯¦æƒ…
const showCalculationDetail = (row: any) => {
  currentCalculationDetail.value = row
  calculationDetailVisible.value = true
}
</script>

<style scoped>
.bonus-calculation {
  padding: 20px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.page-header h2 {
  margin: 0;
  color: #303133;
}

.header-actions {
  display: flex;
  gap: 12px;
}

.stats-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.stat-card {
  border-radius: 8px;
  transition: transform 0.2s;
}

.stat-card:hover {
  transform: translateY(-2px);
}

.stat-content {
  text-align: center;
}

.stat-title {
  font-size: 14px;
  color: #666;
  margin-bottom: 8px;
}

.stat-number {
  font-size: 24px;
  font-weight: bold;
  color: #409EFF;
  margin-bottom: 4px;
}

.stat-subtitle {
  font-size: 12px;
  color: #999;
}

.table-card {
  margin-bottom: 20px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-controls {
  display: flex;
  gap: 12px;
  align-items: center;
}

.pagination {
  margin-top: 20px;
  text-align: right;
}

.calculation-preview {
  background: #f8f9fa;
  padding: 16px;
  border-radius: 6px;
  margin-top: 16px;
}

.preview-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.preview-item.highlight {
  font-size: 16px;
  font-weight: bold;
  border-top: 1px solid #ddd;
  padding-top: 8px;
  margin-top: 8px;
}

.form-item-help {
  font-size: 12px;
  color: #999;
  margin-left: 8px;
}

.pool-info {
  margin-bottom: 20px;
}

.progress-content {
  text-align: center;
  padding: 20px 0;
}

.progress-text {
  margin: 16px 0 8px;
  font-size: 14px;
  color: #666;
}

.progress-details {
  margin-top: 16px;
  font-size: 12px;
  color: #999;
}

.result-summary {
  margin-bottom: 20px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
}

.summary-item {
  text-align: center;
}

.summary-number {
  font-size: 20px;
  font-weight: bold;
  color: #409EFF;
  margin-bottom: 4px;
}

.summary-label {
  font-size: 14px;
  color: #666;
}

.view-switcher {
  margin: 20px 0;
  display: flex;
  justify-content: center;
}

/* â­ æ–°å¢ï¼šè®¡ç®—è¯¦æƒ…å¯¹è¯æ¡†æ ·å¼ */
.calculation-detail-container {
  padding: 10px 0;
}

.calculation-detail-container .el-card {
  margin-bottom: 20px;
}

.calculation-detail-container .el-card:last-child {
  margin-bottom: 0;
}

.card-header {
  display: flex;
  align-items: center;
  font-weight: bold;
  font-size: 16px;
}

.formula-card {
  background: linear-gradient(135deg, #f5f7fa 0%, #e8f0fe 100%);
}

.formula-content {
  padding: 20px;
}

.formula-line {
  padding: 15px;
  margin: 10px 0;
  background: white;
  border-radius: 8px;
  font-size: 14px;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
}

.formula-line.main-formula {
  background: #fff9e6;
  border: 2px solid #ffd666;
}

.formula-line.calculation-result {
  background: #e6f7ff;
  border: 2px solid #91d5ff;
  font-size: 16px;
}

.formula-part {
  padding: 4px 12px;
  background: #409eff;
  color: white;
  border-radius: 4px;
  font-size: 13px;
}

.formula-line .value {
  padding: 4px 10px;
  background: #67c23a;
  color: white;
  border-radius: 4px;
  font-weight: bold;
}

.coefficient-item {
  text-align: center;
  padding: 20px;
  background: #f5f7fa;
  border-radius: 8px;
  transition: all 0.3s;
}

.coefficient-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.coefficient-item.highlight {
  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
  border: 2px solid #ff9800;
}

.coef-label {
  font-size: 14px;
  color: #666;
  margin-bottom: 12px;
  font-weight: 500;
}

.coef-value {
  font-size: 28px;
  font-weight: bold;
  color: #303133;
  margin-bottom: 8px;
}

.coef-value.positive {
  color: #67c23a;
}

.coef-value.negative {
  color: #f56c6c;
}

.coef-value.normal {
  color: #909399;
}

.coef-value.final {
  color: #e6a23c;
  font-size: 32px;
}

.coef-desc {
  font-size: 12px;
  color: #999;
}

.score-value {
  font-size: 16px;
  font-weight: bold;
  color: #409eff;
}

.score-value.highlight {
  font-size: 18px;
  color: #e6a23c;
}

.score-note {
  margin-left: 10px;
  font-size: 12px;
  color: #999;
  font-weight: normal;
}
</style>